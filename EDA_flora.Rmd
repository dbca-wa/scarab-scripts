---
title: 'Data ETL: Flora'
author: "Florian Mayer and Milly Piggott, DBCA"
date: "`r Sys.time()`"
always_allow_html: yes
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    fig_width: 10
    fig_height: 6
    code_folding: hide
    theme: lumen
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = TRUE)
source("helpers.R")
```

# Context
This workbook summarises the legacy data migration and QA for the Threatened
and Priority Flora database (TFL).

<img src="https://data.dpaw.wa.gov.au/dataset/79e90d7b-33a3-4aa0-8634-8a12033eb21d/resource/98588a4e-b3af-452b-bbf4-f63ca7697752/download/tsc-progress.jpg" 
width="100%" alt="Legacy data migration and QA diagram"/>

By default, all code blocks are collapsed to provide better readability to the
non-technical audience. Feel free to expand the code blocks to view the process.

The code for all SCB workbooks is under version control at 
[github](https://github.com/dbca-wa/scarab-scripts).


# Extract and transform legacy Data from TFL
Data from the Threatened Flora Database (TFL) is downloaded from the 
[TFL dataset](https://data.dpaw.wa.gov.au/dataset/threatened-and-priority-flora-database) 
on the DBCA data catalogue, then extracted and transformed.

## Taxonomy
```{r load_tfl, message=TRUE}

tfl_file <- here::here("data", "tfl.Rdata")
if (file.exists(tfl_file)) {
  load(tfl_file)
} else {
  tfl_data <- dl_mdbzip("77062fa0-f409-4fe7-ae28-de8c933a59bd")
  tfl_file <- here::here("data", "tfl.Rdata")
save(tfl_data, file=tfl_file)
}

snapshot_last_updated <- "77062fa0-f409-4fe7-ae28-de8c933a59bd" %>%
  ckanr::resource_show() %>%
  magrittr::extract2("last_modified") %>%
  lubridate::as_datetime() %>%
  lubridate::with_tz("Australia/Perth")

# Cached data from TSC - delete to force refresh
datafile_tsc_flora <- here::here("data", "etl_flora_tsc.Rda")

lookups <-	tfl_data$DRF_LOOKUP_TERMS

# Look up tables
populations <- tfl_data$DRF_POPULATION %>%
  dplyr::transmute(
    pop_id = POP.ID %>% as.character(),
    pop_number = POP.NUMBER %>% as.character(),
    subpop_code = SUBPOP.CODE %>% as.character(),
    taxonid = TAXONID %>% as.character(),
    spname = SPNAME %>% as.character(),
    parent_pop_id = PARENT.POP.ID %>% as.character(),
    pop_rec_type_ind = POP.REC.TYPE.IND %>% as.character(),
    creation_sheetno = CREATION.SHEETNO %>% as.character(),
    first_observed_date = FIRST.OBSERVED.DATE %>% as.character(),
    confirmed = CONFIRMED %>% as.character(),
    status = STATUS %>% as.character(),
    pop_comments = POP.COMMENTS %>% as.character(),
    assoc_sp_accum = ASSOC.SP.ACCUM %>% as.character(),
    location = LOCATION %>% as.character(),
    district = DISTRICT %>% as.character(),
    landdistrict = LANDDISTRICT %>% as.character(),
    lga_code = LGA.CODE %>% as.character(),
    nearplace = NEARPLACE %>% as.character(),
    distance = DISTANCE %>% as.character(),
    direction = DIRECTION %>% as.character(),
    purpose1 = PURPOSE1 %>% as.character(),
    purpose2 = PURPOSE2 %>% as.character(),
    vesting = VESTING %>% as.character(),
    land_loc_no = LAND.LOC.NO %>% as.character(),
    reserve = RESERVE %>% as.character(),
    class = CLASS %>% as.character(),
    utility_ref = UTILITY.REF %>% as.character(),
    land_manager = LAND.MANAGER %>% as.character(),
    land_mgr_address = LAND.MGR.ADDRESS %>% as.character(),
    land_mgr_phone = LAND.MGR.PHONE %>% as.character(),
    co_ord_type_code = CO.ORD.TYPE.CODE %>% as.character(),
    co_ord_source_code = CO.ORD.SOURCE.CODE %>% as.character(),
    gda94lat = GDA94LAT %>% as.character(),
    gda94long = GDA94LONG %>% as.character(),
    loc_sect_date = LOC.SECT.DATE %>% as.character(),
    datum = DATUM %>% as.character(),
    latdeg = LATDEG %>% as.character(),
    latmin = LATMIN %>% as.character(),
    latsec = LATSEC %>% as.character(),
    longdeg = LONGDEG %>% as.character(),
    longmin = LONGMIN %>% as.character(),
    longsec = LONGSEC %>% as.character(),
    gps_zone = GPS.ZONE %>% as.character(),
    northing = NORTHING %>% as.character(),
    easting = EASTING %>% as.character(),
    no_of_satellites = NO.OF.SATELLITES %>% as.character(),
    resolution = RESOLUTION %>% as.character(),
    map_used = MAP.USED %>% as.character(),
    map_scale = MAP.SCALE %>% as.character(),
    dec_latitude = DEC.LATITUDE %>% as.character(),
    dec_longitude = DEC.LONGITUDE %>% as.character(),
    count_sect_date = COUNT.SECT.DATE %>% as.character(),
    svy_extent = SVY.EXTENT %>% as.character(),
    svy_effort_area = SVY.EFFORT.AREA %>% as.character(),
    svy_effort_time = SVY.EFFORT.TIME %>% as.character(),
    svy_effort = SVY.EFFORT %>% as.character(),
    quality_ind = QUALITY.IND %>% as.character(),
    count_mthd_code = COUNT.MTHD.CODE %>% as.character(),
    mature_plants = MATURE.PLANTS %>% as.character(),
    mature_dead = MATURE.DEAD %>% as.character(),
    juvenile_plants = JUVENILE.PLANTS %>% as.character(),
    juvenile_dead = JUVENILE.DEAD %>% as.character(),
    seedling_plants = SEEDLING.PLANTS %>% as.character(),
    seedling_dead = SEEDLING.DEAD %>% as.character(),
    cnt_plant_type_code = CNT.PLANT.TYPE.CODE %>% as.character(),
    simple_live_tot = SIMPLE.LIVE.TOT %>% as.character(),
    area_occupied = AREA.OCCUPIED %>% as.character(),
    area_occupied_method = AREA.OCCUPIED.METHOD %>% as.character(),
    quad_num = QUAD.NUM %>% as.character(),
    quad_size = QUAD.SIZE %>% as.character(),
    quad_tot_sq_m = QUAD.TOT.SQ.M %>% as.character(),
    quad_num_mature = QUAD.NUM.MATURE %>% as.character(),
    quad_num_juvenile = QUAD.NUM.JUVENILE %>% as.character(),
    quad_num_seedlings = QUAD.NUM.SEEDLINGS %>% as.character(),
    quad_num_total = QUAD.NUM.TOTAL %>% as.character(),
    clonal = CLONAL %>% as.character(),
    vegetative = VEGETATIVE %>% as.character(),
    in_buds = IN.BUDS %>% as.character(),
    in_flower = IN.FLOWER %>% as.character(),
    immature_fruit = IMMATURE.FRUIT %>% as.character(),
    fruit = FRUIT %>% as.character(),
    dehisced_fruit = DEHISCED.FRUIT %>% as.character(),
    flower_percentage = FLOWER.PERCENTAGE %>% as.character(),
    hab_sect_date = HAB.SECT.DATE %>% as.character(),
    population_condition = POPULATION.CONDITION %>% as.character(),
    population_notes = POPULATION.NOTES %>% as.character(),
    habitat_condition = HABITAT.CONDITION %>% as.character(),
    habitat_notes = HABITAT.NOTES %>% as.character(),
    soil_condition = SOIL.CONDITION %>% as.character(),
    landform = LANDFORM %>% as.character(),
    rock_type = ROCK.TYPE %>% as.character(),
    gravel = GRAVEL %>% as.character(),
    soil_type = SOIL.TYPE %>% as.character(),
    soil_color = SOIL.COLOR %>% as.character(),
    drainage = DRAINAGE %>% as.character(),
    aspect = ASPECT %>% as.character(),
    associated_species = ASSOCIATED.SPECIES %>% as.character(),
    fire_intensity = FIRE.INTENSITY %>% as.character(),
    fire_year = FIRE.YEAR %>% as.character(),
    fire_season = FIRE.SEASON %>% as.character(),
    fencing_status = FENCING.STATUS %>% as.character(),
    fencing_comments = FENCING.COMMENTS %>% as.character(),
    roadside_marker_status = ROADSIDE.MARKER.STATUS %>% as.character(),
    rdside_mkr_comments = RDSIDE.MKR.COMMENTS %>% as.character(),
    other_comments = OTHER.COMMENTS %>% as.character(),
    vchr_sect_date = VCHR.SECT.DATE %>% as.character(),
    voucher_location = VOUCHER.LOCATION %>% as.character(),
    dupvouch_location = DUPVOUCH.LOCATION %>% as.character(),
    collector_no = COLLECTOR.NO %>% as.character(),
    barcode = BARCODE %>% as.character(),
    vchr_status_code = VCHR.STATUS.CODE %>% as.character(),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character(),
    simple_dead_tot = SIMPLE.DEAD.TOT %>% as.character(),
    observer_code = OBSERVER.CODE %>% as.character(),
    obs_name = OBS.NAME %>% as.character(),
    observer_phone = OBSERVER.PHONE %>% as.character(),
    obs_role_code = OBS.ROLE.CODE %>% as.character(),
    obs_org_code = OBS.ORG.CODE %>% as.character(),
    obs_org_name = OBS.ORG.NAME %>% as.character(),
    land_mgr_notes = LAND.MGR.NOTES %>% as.character()
  )
names_populations <- as.data.frame(names(populations))

pop_forms <- tfl_data$DRF_POP_FORMS %>% #This is the paper form, not the shape of the population!
  dplyr::transmute(
    pop_forms_id = POP.FORMS.ID %>% as.character(),
    pop_id = POP.ID %>% as.character(),
    sheetno = SHEETNO %>% as.character(),
    prev_pop_id = PREV.POP.ID %>% as.character(),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deact = REASON.DEACT %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    current_rec = CURRENT.REC %>% as.character(),
    chg_type_code = CHG.TYPE.CODE %>% as.character(),
    deact_by = DEACT.BY %>% as.character()
  )
# pop_forms[1:100, ] %>% DT::datatable(.)
names_pop_forms <- as.data.frame(names(pop_forms))

pop_threats <- tfl_data$DRF_POP_THREATS %>%
  dplyr::transmute(
    pop_threat_id = POP.THREAT.ID %>% as.character(),
    pop_id = POP.ID %>% as.character(),
    threat_code = THREAT.CODE %>% as.character(),
    cur_impact = CUR.IMPACT %>% as.character(),
    pot_impact = POT.IMPACT %>% as.character(),
    onset = ONSET %>% as.character(),
    agent_code = AGENT.CODE %>% as.character(),
    comments = COMMENTS %>% as.character(),
    status = STATUS %>% as.character(),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character(),
    sheetno = SHEETNO %>% as.character(),
    observation_date = OBSERVATION.DATE %>% as.character()
  )
# pop_threats[1:100, ] %>% DT::datatable(.)
names_pop_threats <- as.data.frame(names(pop_threats))

pop_vegclass <- tfl_data$DRF_POP_VEG_CLASSES %>%
  dplyr::transmute(
    veg_class_id = VEG.CLASS.ID %>% as.character(),
    veg_class_code = VEG.CLASS.CODE %>% as.character(),
    pop_id = POP.ID %>% as.character(),
    veg_class_dom1 = VEG.CLASS.DOM1 %>% as.character(),
    veg_class_dom2 = VEG.CLASS.DOM2 %>% as.character()
  )
names_pop_vegclass <- as.data.frame(names(pop_vegclass))
# pop_vegclass[1:100, ] %>% DT::datatable(.)
```

## Conservation listings
```{r load_tfl_cons, message=TRUE}
tfl_cons_listing <- tfl_data$DRF_TAXON_CONSV_LISTINGS %>%
  dplyr::transmute(
    txn_list_id = TXN.LIST.ID %>% as.character(),
    name_id = TAXONID %>% as.integer(),
    name = NAME %>% as.character(),
    list_code = LIST.CODE %>% as.character(),
    category_code = STATUS.CODE %>% as.character(),
    list_code_wa = WA.IUCN.RANK.LIST.CODE %>% as.character(),
    category_code_wa = WA.IUCN.RANK %>% as.character(),
    criteria_code_wa = IUCN.CRITERIA %>% as.character(),
    date_listed = DATE.LISTED %>% 
      parse_date_time(., orders = orders, tz = tz),
    reasons = REASONS %>% as.character(),
    authority = AUTHORITY %>% as.character(),
    date_delisted = DATE.DELISTED %>% 
      parse_date_time(., orders = orders, tz = tz),
    comments = COMMENTS %>% as.character(),
    distribution = DISTRIBUTION %>% as.character(),
    fl_period = FL.PERIOD %>% as.character(),
    prev_taxonid = PREV.TAXONID %>% as.character(),
    prev_name = PREV.NAME %>% as.character(),
    fam_no = FAM.NO %>% as.character(),
    recovery_plan = R.PLAN %>% as.character(),
    recovery_plan_comments = RP.COMMENTS %>% as.character(),
    recovery_plan_expiry_date = RP.EXP.DATE %>% 
      parse_date_time(., orders = orders, tz = tz),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% 
      parse_date_time(., orders = orders, tz = tz),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% 
      parse_date_time(., orders = orders, tz = tz),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% 
      parse_date_time(., orders = orders, tz = tz),
    file_last_updated = FILE.LAST.UPDATED %>% 
      parse_date_time(., orders = orders, tz = tz),
    file_comments = FILE.COMMENTS %>% as.character(),
    file_no = FILE.NO %>% as.character()
  ) %>% 
  tibble::rowid_to_column("source_id") %>%
  dplyr::mutate(source_id = source_id %>% as.character()) %>% 
  dplyr::arrange(name_id)

# tfl_cons_listing[1:100, ] %>% DT::datatable(.)
readr::write_csv(tfl_cons_listing, path = here::here("data","tfl_cons_listing.csv"))

flcl_file <- here::here("data", "tfl_cons_listings.Rdata")
save(tfl_cons_listing, file=flcl_file)
if (file.exists(flcl_file)) load(flcl_file)

# ETL condensed criteria mixed with free text, therefore must be manually mapped
all_crit_map <- tfl_cons_listing %>%
  dplyr::group_by(list_code_wa) %>% 
  dplyr::distinct(criteria_code_wa) %>% 
  dplyr::arrange(list_code_wa, criteria_code_wa) %>% 
  dplyr::select(list_code_wa, criteria_code_wa)
readr::write_csv(all_crit_map, path = here::here("data","all_tfl_conscrit.csv"))
```

## Occurrences
```{r load_tfl_occ, message=TRUE}
default_date <- lubridate::parse_date_time("1900-01-01 00:00:00", orders = "ymd HMS", tz = tz)

tfl_occ <- tfl_data$DRF_RFR_FORMS %>%
  dplyr::transmute(
    # IDs
    sheetno = SHEETNO %>% as.integer(),
    name_id = TAXONID %>% as.character(),
    species_name = SPNAME %>% as.character(),
    new_pop_ind = NEW.POP.IND %>% as.character(), # Y N
    pop_id = SHEET.POP.NUMBER %>% as.integer(),
    subpop_code = SHEET.SUBPOP.CODE %>% as.character(),
    record_src_code = RECORD.SRC.CODE %>% as.character(),

    # location
    latitude = GDA94LAT %>% as.double(),
    longitude = GDA94LONG %>% as.double(),
    location = LOCATION %>% as.character(),
    district = DISTRICT %>% as.character(),
    landdistrict = LANDDISTRICT %>% as.character(),
    lga_code = LGA.CODE %>% as.character(),
    nearplace = NEARPLACE %>% as.character(),
    distance = DISTANCE %>% as.character(),
    direction = DIRECTION %>% as.character(),
    purpose1 = PURPOSE1 %>% as.character(),
    purpose2 = PURPOSE2 %>% as.character(),
    vesting = VESTING %>% as.character(),
    land_loc_no = LAND.LOC.NO %>% as.character(),
    reserve = RESERVE %>% as.character(),
    class = CLASS %>% as.character(),
    utility_ref = UTILITY.REF %>% as.character(),
    co_ord_type_code = CO.ORD.TYPE.CODE %>% as.character(),
    co_ord_source_code = CO.ORD.SOURCE.CODE %>% as.character(),
    datum = DATUM %>% as.character(),
    # latdeg = LATDEG %>% as.character(),
    # latmin = LATMIN %>% as.character(),
    # latsec = LATSEC %>% as.character(),
    # longdeg = LONGDEG %>% as.character(),
    # longmin = LONGMIN %>% as.character(),
    # longsec = LONGSEC %>% as.character(),
    # gps_zone = GPS.ZONE %>% as.character(),
    northing = NORTHING %>% as.character(),
    easting = EASTING %>% as.character(),
    no_of_satellites = NO.OF.SATELLITES %>% as.character(),
    resolution = RESOLUTION %>% as.character(),
    map_used = MAP.USED %>% as.character(),
    map_scale = MAP.SCALE %>% as.character(),
    # dec_latitude = DEC.LATITUDE %>% as.character(),
    # dec_longitude = DEC.LONGITUDE %>% as.character(),

    # habitat description
    landform = LANDFORM %>% as.character(),
    rock_type = ROCK.TYPE %>% as.character(),
    gravel = GRAVEL %>% as.character(),
    soil_type = SOIL.TYPE %>% as.character(),
    soil_color = SOIL.COLOR %>% as.character(),
    drainage = DRAINAGE %>% as.character(),
    aspect = ASPECT %>% as.character(),
    associated_species = ASSOCIATED.SPECIES %>% as.character(),
    fire_intensity = FIRE.INTENSITY %>% as.character(),
    fire_year = FIRE.YEAR %>% as.character(),
    fire_season = FIRE.SEASON %>% as.character(),
    fire_ind = FIRE.IND %>% as.character(),
    fencing_status = FENCING.STATUS %>% as.character(),
    fencing_comments = FENCING.COMMENTS %>% as.character(),
    roadside_marker_status = ROADSIDE.MARKER.STATUS %>% as.character(),
    rdside_mkr_comments = RDSIDE.MKR.COMMENTS %>% as.character(),
    other_comments = OTHER.COMMENTS %>% as.character(),

    # habitat condition
    habitat_condition = HABITAT.CONDITION %>% as.character(),
    habitat_notes = HABITAT.NOTES %>% as.character(),
    soil_condition = SOIL.CONDITION %>% as.character(),

    # site quadrat info
    quad_num = QUAD.NUM %>% as.character(),
    quad_size = QUAD.SIZE %>% as.character(),
    quad_tot_sq_m = QUAD.TOT.SQ.M %>% as.character(),
    quad_num_mature = QUAD.NUM.MATURE %>% as.character(),
    quad_num_juvenile = QUAD.NUM.JUVENILE %>% as.character(),
    quad_num_seedlings = QUAD.NUM.SEEDLINGS %>% as.character(),
    quad_num_total = QUAD.NUM.TOTAL %>% as.character(),

    # survey / site visit
    observation_date = OBSERVATION.DATE %>% 
            lubridate::parse_date_time2(orders, tz = tz, cutoff_2000 = 19L) %>% 
            lubridate::as_datetime(.) %>%
            lubridate::with_tz(tzone = tz),
        # ifelse(
        # is.na(OBSERVATION.DATE),
        # default_date,
        # OBSERVATION.DATE %>% 
        #     lubridate::parse_date_time2(orders, tz = tz, cutoff_2000 = 18L) %>% 
        #     lubridate::as_datetime(.) %>%
        #     with_tz(tzone = tz)
        # ),
    svy_extent = SVY.EXTENT %>% as.character(),
    svy_effort_area = SVY.EFFORT.AREA %>% as.character(),
    svy_effort_time = SVY.EFFORT.TIME %>% as.character(),
    svy_effort = SVY.EFFORT %>% as.character(),
    landowner_present = LANDOWNER.PRESENT %>% as.character(),

    # observer
    observer_code = OBSERVER.CODE %>% as.character(),
    obs_name = OBS.NAME %>% as.character(),
    observer_phone = OBSERVER.PHONE %>% as.character(),
    obs_role_code = OBS.ROLE.CODE %>% as.character(),
    obs_org_code = OBS.ORG.CODE %>% as.character(),
    obs_org_name = OBS.ORG.NAME %>% as.character(),

    # measurements
    quality_ind = QUALITY.IND %>% as.character(),
    count_mthd_code = COUNT.MTHD.CODE %>% as.character(),
    mature_plants = MATURE.PLANTS %>% as.character(),
    mature_dead = MATURE.DEAD %>% as.character(),
    juvenile_plants = JUVENILE.PLANTS %>% as.character(),
    juvenile_dead = JUVENILE.DEAD %>% as.character(),
    seedling_plants = SEEDLING.PLANTS %>% as.character(),
    seedling_dead = SEEDLING.DEAD %>% as.character(),
    cnt_plant_type_code = CNT.PLANT.TYPE.CODE %>% as.character(),
    simple_live_tot = SIMPLE.LIVE.TOT %>% as.character(),
    area_occupied = AREA.OCCUPIED %>% as.character(),
    area_occupied_method = AREA.OCCUPIED.METHOD %>% as.character(),

    # plant properties
    clonal = CLONAL %>% as.character(),
    vegetative = VEGETATIVE %>% as.character(),
    in_buds = IN.BUDS %>% as.character(),
    in_flower = IN.FLOWER %>% as.character(),
    immature_fruit = IMMATURE.FRUIT %>% as.character(),
    fruit = FRUIT %>% as.character(),
    dehisced_fruit = DEHISCED.FRUIT %>% as.character(),
    flower_percentage = FLOWER.PERCENTAGE %>% as.character(),
    simple_dead_tot = SIMPLE.DEAD.TOT %>% as.integer(),
    pollinator = POLLINATOR %>% as.character(),

    # population
    population_condition = POPULATION.CONDITION %>% as.character(),
    population_notes = POPULATION.NOTES %>% as.character(),

    # taxonomy, voucher specimens
    voucher_location = VOUCHER.LOCATION %>% as.character(),
    dupvouch_location = DUPVOUCH.LOCATION %>% as.character(),
    collector_no = COLLECTOR.NO %>% as.character(),
    barcode = BARCODE %>% as.character(),
    vchr_status_code = VCHR.STATUS.CODE %>% as.character(),

    # attachments
    attached_doc1 = ATTACHED.DOC1 %>% as.character(),
    attached_doc2 = ATTACHED.DOC2 %>% as.character(),
    attached_doc3 = ATTACHED.DOC3 %>% as.character(),
    attached_other_doc = ATTACHED.OTHER.DOC %>% as.character(),
    report_key = REPORT.KEY %>% as.character(),

    # metadata
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character(),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    form_status_code = FORM.STATUS.CODE %>% as.character(),
    classification_code = CLASSIFICATION.CODE %>% as.character(),
    florabus_ind = FLORABUS.IND %>% as.character(),
    licence = LICENCE %>% as.character()
  )

# occ_liasons <- tfl_data$DRF_LIAISONS %>%
#   dplyr::transmute(
#     liaisons_id = LIAISONS.ID %>% as.integer(),
#     pop_id = POP.ID %>% as.integer(),
#     notify_date = NOTIFY.DATE %>% as.character(),
#     othernames = OTHERNAMES %>% as.character(),
#     initials = INITIALS %>% as.character(),
#     surname = SURNAME %>% as.character(),
#     address = ADDRESS %>% as.character(),
#     phone_number = PHONE.NO %>% as.character(),
#     comments = COMMENTS %>% as.character(),
#     notification_type = NOTIFICATION.TYPE %>% as.character(),
#     notifier_name = NOTIFIER.NAME %>% as.character(),
#     active_ind = ACTIVE.IND %>% as.character(),
#     deactivated_date = DEACTIVATED.DATE %>% as.character(),
#     reason_deactivated = REASON.DEACTIVATED %>% as.character(),
#     created_by = CREATED.BY %>% as.character(),
#     created_date = CREATED.DATE %>% as.character(),
#     modified_by = MODIFIED.BY %>% as.character(),
#     modified_date = MODIFIED.DATE %>% as.character())

# names(tfl_data$DRF_P2K_PRIORITY)

# occ_priority <- tfl_data$DRF_P2K_PRIORITY %>%
#   dplyr::transmute(
#     species = SPECIES %>% as.character(),
#     taxon_id = TAXONID %>% as.integer(),
#     change = CHANGE %>% as.character(),
#     change_date = CHANGE.DATE %>% as.character(),
#     add_date = ADD.DATE %>% as.character(),
#     delete_date = DELETE.DATE %>% as.character(),
#     informal = INFORMAL %>% as.character(),
#     authority = INFORMAL %>% as.character(),
#     pr_code = PR.CODE %>% as.character(),
#     wa_iucn_rank = WA.IUCN.RANK %>% as.character(),
#     iucn_criteria = IUCN.CRITERIA %>% as.character(),
#     date_iucn_change = DATE.IUCN.CHANGE %>% as.character(),
#     epbc_rank = EPBC.RANK %>% as.character(),
#     calm_reg = CALM.REG %>% as.character(),
#     district = DISTRICT %>% as.character(),
#     dist = DIST %>% as.character(),
#     fl_period = FL.PERIOD %>% as.character(),
#     old_name = OLD.NAME %>% as.character(),
#     fam_num = FAM.NO %>% as.character(),
#     file_num = FILE.NO %>% as.character(),
#     man_plan = MANPLAN %>% as.character(),
#     row_num = ROW.NO %>% as.integer()
#     )

## Create occurrence data tables for each card in TSC
hab_comp <- tfl_occ %>%
  dplyr::filter(!is.na(name_id) & !is.na(latitude) & !is.na(longitude) & name_id!=0) %>% 
  dplyr::transmute(
    source = 11,
    source_id = sheetno,
    landform = landform,
    rock_type = rock_type,
    loose_rock = gravel,
    soil_type = soil_type,
    soil_colour = soil_color,
    drainage = drainage,
    aspect = aspect) %>%
  filter(landform != "" | rock_type != "" | loose_rock != "" | soil_type != "" | soil_colour != "" | drainage != "" |  aspect != "")

hab_comp %>%
  dplyr::select(landform) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_landcrit.csv"))

hab_comp %>%
  dplyr::select(rock_type) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_rocktype.csv"))

hab_comp %>%
  dplyr::select(loose_rock) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_looserock.csv"))

hab_comp %>%
  dplyr::select(soil_type) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_soiltype.csv"))

hab_comp %>%
  dplyr::select(soil_colour) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_soilcolour.csv"))

hab_comp %>%
  dplyr::select(drainage) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_drainage.csv"))

hab_comp %>%
  dplyr::select(aspect) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_aspect.csv"))

area_ass <- tfl_occ %>%
  dplyr::filter(!is.na(name_id) & !is.na(latitude) & !is.na(longitude) & name_id!=0) %>% 
  dplyr::transmute(
    source = 11,
    source_id = sheetno,
    survey_method = svy_extent,
    surveyed_area = svy_effort_area,
    survey_duration = svy_effort_time) %>% 
  dplyr::filter(survey_method != "" | surveyed_area != "NA" | survey_duration!= "NA")

area_ass %>%
  dplyr::select(survey_method) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_survey_method.csv"))

hab_cond <- tfl_occ %>%
  dplyr::filter(!is.na(name_id) & !is.na(latitude) & !is.na(longitude) & name_id!=0) %>% 
  dplyr::transmute(
    source = 11,
    source_id = sheetno,
    occurrence_condition = habitat_condition,
    soil_condition = soil_condition) %>%  #There is a problem with migrating this- won't match TSC card
  dplyr::filter(occurrence_condition != "" | soil_condition != "")

hab_cond %>%
  dplyr::select(soil_condition) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_soil_condition.csv"))

tfl_fire_hist <- tfl_occ %>%
  dplyr::filter(!is.na(name_id) & !is.na(latitude) & !is.na(longitude) & name_id!=0) %>% 
  dplyr::transmute(
    source = 11,
    source_id = sheetno,
    fire_intensity = fire_intensity,
    fire_year = fire_year,
    fire_season = fire_season) %>%
   mutate(fire_year = case_when(is.na(fire_year) ~ "1900",
  TRUE ~ as.character(fire_year)))%>%
   mutate(fire_intensity = case_when(fire_intensity == "0" ~ "no",
                                fire_intensity == "1" ~ "low",
                                fire_intensity == "2" ~ "medium",
                                fire_intensity == "3" ~ "high")) %>% 
  mutate(month = case_when(fire_season == "SPR" ~ "09",
                                fire_season == "SUM" ~ "12",
                                fire_season == "AUT" ~ "03",
                                fire_season == "WIN" ~ "06",
                           fire_season =="" ~ "01")) %>% 
  mutate(day = case_when(month == "03" ~ "01",
  month == "06" ~ "01",
  month == "09" ~ "01",
  month == "12" ~ "01",
  month == "01" ~ "01")) %>% 
  transmute(source = source,
    source_id = source_id,
    fire_intensity = fire_intensity,
    fire_date = glue::glue("{fire_year}-{month}-{day}", .na = "NA") %>% as.character()) %>% 
  mutate(fire_date = case_when(is.na(fire_intensity) ~ "NA",
                               TRUE ~ as.character(fire_date))) %>% 
  dplyr::filter(fire_intensity != "NA" | fire_date != "NA")

plant_count <- tfl_occ %>%
  dplyr::filter(!is.na(name_id) & !is.na(latitude) & !is.na(longitude) & name_id!=0) %>% 
  dplyr::transmute(
    source = 11,
    source_id = sheetno,
    number_of_quadrats_surveyed = quad_num,
    individual_quadrat_area = quad_size,
    yotal_quadrat_area =quad_tot_sq_m,
    land_manager_present = landowner_present,
    plant_count_method = count_mthd_code,
    number_alive_mature = mature_plants,
    number_dead_mature = mature_dead,
    number_alive_juvenile = juvenile_plants,
    number_dead_juvenile = juvenile_dead,
    number_alive_seedlings = seedling_plants,
    number_dead_seedlings = seedling_dead,
    counted_subject = cnt_plant_type_code,
    number_alive = simple_live_tot,
    estimates_population_area = area_occupied,
    area_occupied_method = area_occupied_method,
    clonal_reproduction_present = clonal,
    vegetative_state_present = vegetative,
    flower_buds_present = in_buds,
    flowers_present = in_flower,
    immature_fruit_present = immature_fruit,
    ripe_fruit_present = fruit,
    dehisced_fruit_present = dehisced_fruit,
    flowering_plants = flower_percentage,
    number_dead = simple_dead_tot,
    plant_condition = population_condition,
    comments = population_notes) %>% 
  dplyr::filter(plant_count_method != "" | counted_subject != "" | plant_condition != "" | comments != "")

plant_count %>%
  dplyr::select(plant_count_method) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_plant_count_method.csv"))

plant_count %>%
  dplyr::select(counted_subject) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_counted_subject.csv"))

plant_count %>%
  dplyr::select(plant_condition) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_plant_condition.csv"))

ass_species <- tfl_occ %>%
  dplyr::filter(!is.na(name_id) & !is.na(latitude) & !is.na(longitude) & name_id!=0) %>% 
  dplyr::transmute(
    source = 11,
    source_id = sheetno,
    taxon = associated_species) %>% 
  dplyr::filter(taxon != "")

phys_sample <- tfl_occ %>% 
  dplyr::filter(!is.na(name_id) & !is.na(latitude) & !is.na(longitude) & name_id!=0) %>% 
  dplyr::transmute(
    source = 11,
    source_id = sheetno,
    sample_type = "plant specimen",
    sample_destination = voucher_location, # most of these are listed as WA HERB/ INT HERB/ DIS HERB, but none of these are options in the card
    duplicate_sample_destination = dupvouch_location,
    sample_label = glue::glue("[{sample_destination}]{barcode}"),
    permit_id = licence) %>% 
  dplyr::filter(sample_destination != "") 


phys_sample %>%
  dplyr::select(sample_destination) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_sample_destination.csv"))

# Occurrence vegetation classes
occ_vegclass <- tfl_data$DRF_SHEET_VEG_CLASSES %>%
  dplyr::transmute(
    veg_class_id = VEG.CLASS.ID %>% as.integer(),
    veg_class_code = VEG.CLASS.CODE %>% as.character(),
    sheetno = SHEETNO %>% as.character(),
    veg_class_dom1 = VEG.CLASS.DOM1 %>% as.character(),
    veg_class_dom2 = VEG.CLASS.DOM2 %>% as.character()
  )

## Occurrence threats
occ_threats <- tfl_data$DRF_SHEET_THREATS %>%
  dplyr::transmute(
    sheet_threat_id = SHEET.THREAT.ID %>% as.character(),
    sheetno = SHEETNO %>% as.character(),
    threat_code = THREAT.CODE %>% as.character(),
    cur_impact = CUR.IMPACT %>% as.character(),
    pot_impact = POT.IMPACT %>% as.character(),
    onset = ONSET %>% as.character(),
    agent_code = AGENT.CODE %>% as.character(),
    comments = COMMENTS %>% as.character(),
    status = STATUS %>% as.character(),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character()
  )

## Occurrence fire details
occ_fire <- tfl_data$DRF_FIRE_DETAILS %>%
  dplyr::transmute(
    fire_det_id = FIRE.DET.ID %>% as.character(),
    sheet_no = SHEET.NO %>% as.character(),
    sit_id = SIT.ID %>% as.character(),
    quadrat_name = QUADRAT.NAME %>% as.character(),
    fire_date = FIRE.DATE %>% as.character(),
    other_treatment_date = OTHER.TREATMENT.DATE %>% as.character(),
    other_treatment_type = OTHER.TREATMENT.TYPE %>% as.character(),
    unburnt_postburn = UNBURNT.POSTBURN %>% as.character(),
    months_since_fire = MONTHS.SINCE.FIRE %>% as.character(),
    fire_type = FIRE.TYPE %>% as.character(),
    burnt_pct = BURNT.PCT %>% as.character(),
    fuel_age = FUEL.AGE %>% as.character(),
    flammability = FLAMMABILITY %>% as.character(),
    seedlings_new = SEEDLINGS.NEW %>% as.character(),
    seedlings_old = SEEDLINGS.OLD %>% as.character(),
    juveniles = JUVENILES %>% as.character(),
    adults_pre_burn_alive = ADULTS.PRE.BURN.ALIVE %>% as.character(),
    adults_pre_burn_dead = ADULTS.PRE.BURN.DEAD %>% as.character(),
    adults_post_burn_unburnt = ADULTS.POST.BURN.UNBURNT %>% as.character(),
    adults_post_burn_burnt = ADULTS.POST.BURN.BURNT %>% as.character(),
    adults_post_burn_respr = ADULTS.POST.BURN.RESPR %>% as.character(),
    adults_post_burn_dead = ADULTS.POST.BURN.DEAD %>% as.character(),
    flowering_pct_seeder = FLOWERING.PCT.SEEDER %>% as.character(),
    flowering_pct_respr = FLOWERING.PCT.RESPR %>% as.character(),
    fruiting_pct_seeder = FRUITING.PCT.SEEDER %>% as.character(),
    fruiting_pct_respr = FRUITING.PCT.RESPR %>% as.character(),
    dehisced_fruit_pct = DEHISCED.FRUIT.PCT %>% as.character(),
    native_alive_pct = NATIVE.ALIVE.PCT %>% as.character(),
    weed_cover_pct = WEED.COVER.PCT %>% as.character(),
    bare_ground_pct = BARE.GROUND.PCT %>% as.character(),
    litter_depth = LITTER.DEPTH %>% as.character(),
    comments = COMMENTS %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character()
  ) 

## Taxon area encounter
tfl_tae <- tfl_occ %>%
  dplyr::filter(!is.na(name_id)) %>% 
  dplyr::filter(!is.na(observation_date)) %>%
  dplyr::filter(!is.na(latitude)) %>%
  dplyr::filter(!is.na(longitude)) %>%
  dplyr::transmute(
    taxon = name_id,
    code = pop_id,
    name = glue::glue("{pop_id}{subpop_code}"),
    description = glue::glue(
        "Sheet number: {sheetno}\n",
        "Population {pop_id}, Subpopulation {subpop_code}\n",
        "Population classification: {classification_code}\n",
        "Habitat condition: {habitat_condition} {habitat_notes}\n",
        "Location: {location} {distance} KM {direction} from {nearplace}\n",
        "District: {district}\n",
        "Land district: {landdistrict}\n",
        "LGA code: {lga_code}\n",
        "Record source code: {record_src_code}\n",
        "Comments: {other_comments}\n"
        ),
    source = 11,
    source_id = sheetno,
    encounter_type = 3, # https://tsc.dbca.wa.gov.au/admin/occurrence/encountertype/3/change/ = monitoring
    encountered_on = observation_date %>% as.character(),
    encountered_by = 1,
    area_type = 20, # pop:20, subpop: 21
    geolocation_capture_method='gps-point',
    accuracy = 1000,
    point = glue::glue("SRID=4326;POINT({longitude} {latitude})")
  ) #%>% glimpse()

# names_tfl_occ <- (as.data.frame(names(tfl_occ)))

## Some (sub)populations are resighted. (Good examples: 1033, 10796, 10850)
tfl_tae %>% dplyr::group_by(taxon, name) %>% dplyr::tally() %>% dplyr::filter(n>2) %>% dplyr::arrange(-n) 
```

## Conservation Threats and Actions
```{r load_actions, message=TRUE}
act_fenc <- tfl_occ %>%
  dplyr::filter(!is.na(name_id) & !is.na(latitude) & !is.na(longitude) & name_id!=0) %>% 
  dplyr::transmute(
    source = 11,
    source_id = sheetno,
    fencing_action = fencing_status,
    comments = fencing_comments)

act_rdmk <- tfl_occ %>%
  dplyr::filter(!is.na(name_id) & !is.na(latitude) & !is.na(longitude) & name_id!=0) %>% 
  dplyr::transmute(
    source = 11,
    source_id = sheetno,
    fencing_action = roadside_marker_status,
    comments = rdside_mkr_comments)

names(tfl_data$DRF_POP_MGMT_ACTIONS)

mgmt_act <- tfl_data$DRF_POP_MGMT_ACTIONS %>%
  dplyr::transmute(
    action_id = ACTION.ID %>% as.character(),
    pop_id = POP.ID %>% as.character(),
    mgmt_act_code = MGMT.ACT.CODE %>% as.character(),
    action_notes = ACTION.NOTES %>% as.character(),
    priority_code = PRIORITY.CODE %>% as.character(),
    status = STATUS %>% as.character(),
    action_date = ACTION.DATE %>% as.character(),
    r_plan = R.PLAN %>% as.character(),
    finalised_on = FINALISED.ON %>% as.character(),
    active_on = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character()
  )
```

## Fire History
```{r load_fire_history, message=TRUE}
fire_sum <- tfl_data$DRF_FIRE_SUMMARIES %>%
  dplyr::transmute(
    fire_id = FIRE.SUM.ID %>% as.integer(),
    summary_level = SUMMARY.LEVEL %>% as.character(),
    publish = PUBLISH %>% as.character(),
    taxon_id = TAXONID %>% as.character(),
    spname = SPNAME %>% as.character(),
    pop_id = POP.ID %>% as.character(),
    sit_id = SIT.ID %>% as.character(),
    quadrat = QUADRAT %>% as.character(),
    summary_date = SUMMARY.DATE %>% as.character(),
    completed_date = COMPLETED.DATE %>% as.character(),
    observer_name = OBSERVER.NAME %>% as.character(),
    adult_survival = ADULT.SURVIVAL.PCT %>% as.character(),
    seedling_survival = SEEDLING.SURVIVAL.PCT %>% as.character(),
    recruitment = RECRUITMENT %>% as.character(),
    fire_response_type = FIRE.RESPONSE.TYPE %>% as.character(),
    juvenile_period_seeder = JUVENILE.PERIOD.SEEDER %>% as.character(),
    juvenile_period_respr = JUVENILE.PERIOD.RESPR %>% as.character(),
    peak_flowering = PEAK.FLOWERING %>% as.character(),
    mature_age = MATURE.AGE %>% as.character(),
    minimum_fire_interval = MINIMUM.FIRE.INTERVAL %>% as.character(), 
    seeder_type = SEEDER.TYPE %>% as.character(),
    germination = GERMINATION %>% as.character(),
    resprouter.type = RESPROUTER.TYPE %>% as.character(),
    senescence = SENESCENCE %>% as.character(),
    longevity = LONGEVITY %>% as.character(),
    data_source = DATA.SOURCE %>% as.character(),
    comments = COMMENTS %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character())
```

# Extract and transform conservation criteria Data from TSC
Conservation criteria Data from TSC is extracted through the TSC API and transformed into a useable
format for manual mapping to tfl.

``` {r extract_tsc_cons_criteria, message = FALSE}
tsc_cons_list <- "conservationlist" %>% 
  wastdr::wastd_GET(api_url = prod) %>% 
  wastdr::wastd_parse()

tsc_cons_cat <- "conservationcategory" %>% 
  wastdr::wastd_GET(api_url = prod) %>% 
  wastdr::wastd_parse() %>% 
  dplyr::arrange(conservation_list, rank) %>% 
  dplyr::left_join(tsc_cons_list, by = c("conservation_list" = "id"))

tsc_cons_crit <- "conservationcriterion" %>% 
  wastdr::wastd_GET(api_url = prod) %>% 
  wastdr::wastd_parse() %>% 
  dplyr::arrange(conservation_list, rank) %>% 
  dplyr::left_join(tsc_cons_list, by = c("conservation_list" = "id")) 

tsc_cons_crit %>%
  dplyr::select(-"conservationcategory_set", -"conservationcriterion_set") %>%
  readr::write_csv(path = here::here("data", "tsc_conscrit.csv"))

# Load manual mapping of tfl cons criteria from CSV file,  join to tfl_cons_crit
tfl_conscrit <- here::here("csv/tfl_conscrit_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      list_code_wa = col_character(),
      tsc_criteria = col_character(),
      criteria_code_wa = col_character(),
      assigned_as_in_tsc = col_character(),
      comments_MP = col_character(),
      actions_required = col_character()
    )
  )  %>%
  dplyr::mutate(
    tsc_criteria = purrr::map(tsc_criteria, chr2int)
  )

# glimpse(tfl_conscrit)

tfl_tcl <- tfl_cons_listing %>% 
  left_join(tfl_conscrit,by=c("list_code_wa","criteria_code_wa")) %>%  
  # dplyr::glimpse() %>% 
  invisible()
```

# Extract and transform occurrence lookup Data from TSC
``` {r extract_tsc_occurrence_lookup, message=FALSE}
tsc_landforms <- "lookup-landform" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_landforms.csv"))

tsc_rocktype <- "lookup-rocktype" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_rocktype.csv"))

tsc_soiltype <- "lookup-soiltype" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_soiltype.csv"))

tsc_soilcolour <- "lookup-soilcolour" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_soilcolour.csv"))

tsc_drainage <- "lookup-drainage" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_drainage.csv"))

tsc_soilcondition <- "lookup-soilcondition" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_soilcondition.csv"))

tsc_surveymethod <- "lookup-surveymethod" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_surveymethod.csv"))

tsc_countmethod <- "lookup-countmethod" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_countmethod.csv"))

tsc_countsubject <- "lookup-countsubject" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_countsubject.csv"))

tsc_plantcondition <- "lookup-plantcondition" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_plantcondition.csv"))

tsc_samp_dest <- "lookup-sampledestination" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_samp_dest.csv"))

# Load manual mapping of tfl lookup criteria from CSV file, and join to relevant table

## habitat composition
tfl_landcrit <- here::here("csv/tfl_landcrit_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      landform = col_character(),
      tsc_landform = col_character(),
      tsc_criteria = col_character()
    ))

tfl_rocktype <- here::here("csv/tfl_rocktype_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      rocktype= col_character(),
      tsc_rocktype = col_character(),
      tsc_criteria = col_character()
    ))

tfl_soiltype <- here::here("csv/tfl_soiltype_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      soil_type = col_character(),
      tsc_soiltype = col_character(),
      tsc_criteria = col_character()
    ))

tfl_soilcolour <- here::here("csv/tfl_soilcolour_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      soil_colour = col_character(),
      tsc_soil_colour = col_character(),
      tsc_criteria = col_character()
    ))

tfl_drainage <- here::here("csv/tfl_drainage_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      drainage = col_character(),
      tsc_drainage = col_character(),
      tsc_criteria = col_character()
    ))

tfl_hab_comp <- hab_comp %>%
  left_join(tfl_landcrit, by = c("landform")) %>% 
  left_join(tfl_rocktype, by = c("rock_type")) %>%
  left_join(tfl_soiltype, by = c("soil_type")) %>%
  left_join(tfl_soilcolour, by = c("soil_colour")) %>%
  left_join(tfl_drainage, by = c("drainage")) %>%
  dplyr::select(source,source_id,tsc_landforms,tsc_rock_type,loose_rock,tsc_soil_type,tsc_soil_colour,tsc_drainage) %>% 
  dplyr::rename(landform = tsc_landforms) %>% 
  dplyr::rename(rocktype = tsc_rock_type) %>% 
  dplyr::rename(soiltype = tsc_soil_type) %>% 
  dplyr::rename(soilcolour = tsc_soil_colour) %>%
  dplyr::rename(drainage = tsc_drainage)


## Area assessment
tfl_survey_method <- here::here("csv/tfl_survey_method_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      survey_method = col_character(),
      tsc_survey_method = col_character(),
      tsc_criteria = col_character()
    ))

tfl_area_ass <- area_ass %>%
  left_join(tfl_survey_method, by = c("survey_method")) %>% 
dplyr::select(source,source_id,tsc_survey_method,surveyed_area,survey_duration) %>%
  dplyr::rename(survey_method = tsc_survey_method) 

## Habitat condition
tfl_soil_condition <- here::here("csv/tfl_soil_condition_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      soil_condition = col_character(),
      tsc_soil_condition = col_character(),
      tsc_criteria = col_character()
    ))

tfl_hab_cond <- hab_cond %>%
  left_join(tfl_soil_condition, by = c("soil_condition")) %>% 
dplyr::select(source,source_id,occurrence_condition,tsc_soil_condition) %>%
  dplyr::rename(soil_condition = tsc_soil_condition) 

## Plant count
tfl_plant_count_method <- here::here("csv/tfl_plant_count_method_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      plant_count_method = col_character(),
      tsc_plant_count_method = col_character(),
      tsc_criteria = col_character()
    ))

tfl_plant_count_subject <- here::here("csv/tfl_counted_subject_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      counted_subject = col_character(),
      tsc_counted_subject = col_character(),
      tsc_criteria = col_character()
    ))

tfl_plant_condition <- here::here("csv/tfl_plant_condition_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      plant_condition = col_character(),
      tsc_Plant_condition = col_character(),
      tsc_criteria = col_character()
    ))

tfl_plant_count <- plant_count %>%
  left_join(tfl_plant_count_method, by = c("plant_count_method")) %>%
  left_join(tfl_plant_count_subject, by = c("counted_subject")) %>%
  left_join(tfl_plant_condition, by = c("plant_condition")) %>%  
  dplyr::select(
    -plant_count_method,
    -counted_subject,
    -plant_condition,
    -tsc_criteria.x,
    -tsc_criteria.y,
    -tsc_criteria
  ) %>%
  dplyr::rename(plant_count_method = tsc_plant_count_method) %>% 
  dplyr::rename(counted_subject = tsc_counted_subject) %>%
  dplyr::rename(plant_condition = tsc_Plant_condition)

## Physical sample
tfl_sampdest <- here::here("csv/tfl_sample_destination_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      sample_destination = col_character(),
      tsc_sample_destination = col_character(),
      tsc_criteria = col_character()
    ))

tfl_phys_sample <- phys_sample %>%
  left_join(tfl_sampdest, by = c("sample_destination")) %>%
dplyr::select(-sample_destination,-tsc_criteria) %>%
  dplyr::rename(sample_destination = tsc_sample_destination)
```

# Load legacy data from TFL into TSC
In this section, the extracted and transformed data from TFL are loaded into TSC
using the TSC API. The code is collapsed; expand the code blocks to view the 
process.

## Taxonomy
The QA part of this workbook will compare TFL names to TSC names.

## Conservation listings
```{r tfl_cons_listing_subsetting}
tsc_conscat_sp <- "conservationcategory" %>% 
  wastdr::wastd_GET(api_url = prod) %>% 
  magrittr::extract2("features") %>% 
  {tibble::tibble(
    tsc_category_id = purrr::map_int(., "id"),
    category_code = purrr::map_chr(., "code"),
    tsc_label = purrr::map_chr(., "label"),
    conservation_list = purrr::map_chr(., "conservation_list")
  )} %>% 
  dplyr::filter(conservation_list %in% c(1,2,3,4,5,6,7))

unique(tfl_tcl$list_code)
# "Priority"  "EPBC"      "WCA_1991"  "FIDMS"     "FLORABASE"
unique(tfl_tcl$list_code_wa)
# ""          "IUCN_1994" "IUCN_2001"

# List codes: "Priority"
# https://tsc.dbca.wa.gov.au/admin/conservation/conservationlist/6/
tfl_listing_cat_priority <- tfl_tcl %>% 
  dplyr::filter(list_code=="Priority") %>%
  dplyr::mutate(
    category_code=glue::glue("P{category_code}") %>% as.character) %>% 
  dplyr::left_join(
    dplyr::filter(tsc_conscat_sp, conservation_list == 6), 
    by="category_code") %>% 
  dplyr::transmute(
        source = 2, # TaxonGaz.source tfl 1, TFL 2, TEC 3
        source_id = source_id %>% as.character(),
        scope = 0, # state 0, cwth 1, intl 2, ap 3
        status = ifelse(is.na(date_delisted), 80, 90),
        effective_from = date_listed,
        effective_to = date_delisted,
        review_due = recovery_plan_expiry_date,# check
        last_reviewed_on = file_last_updated,
        taxon = name_id %>% as.numeric,
        category = tsc_category_id %>% as.list(),
        criteria = tsc_criteria
    ) %>% 
  dplyr::filter(!is.na(category))

# Active Priority listings:
tfl_no_active_listings <- tfl_listing_cat_priority %>% dplyr::filter(status==80) %>% nrow

# Inactive Priority listings:
tfl_no_inactive_listings <- tfl_listing_cat_priority %>% dplyr::filter(status==90) %>% nrow

# tfl_cl_priority[3888,] 
# taxonid 315936 does not exist, 31593 does - typo confirmed

# List codes: "EPBC" 
# https://tsc.dbca.wa.gov.au/admin/conservation/conservationlist/7/
tfl_listing_cat_epbc <- tfl_tcl %>% 
  dplyr::filter(list_code=="EPBC") %>% 
  dplyr::left_join(
    dplyr::filter(tsc_conscat_sp, conservation_list == 7), 
    by="category_code") %>% 
  dplyr::transmute(
        source = 2, # TaxonGaz.source tfl 1, TFL 2, TEC 3
        source_id = source_id %>% as.character(),
        scope = 1, # state 0, cwth 1, intl 2, ap 3
        status = ifelse(is.na(date_delisted), 80, 90),
        effective_from = date_listed,
        effective_to = date_delisted,
        review_due = recovery_plan_expiry_date,# check
        last_reviewed_on = file_last_updated,
        taxon = name_id %>% as.numeric,
        category = tsc_category_id %>% as.list(),
        criteria = tsc_criteria
    ) %>% 
  dplyr::filter(!is.na(category))

# List codes: "WCA_1991" = IUCN 1994/2001/2012
# IUCN 1994 
# https://tsc.dbca.wa.gov.au/admin/conservation/conservationlist/5/change/
tfl_listing_cat_iucn1994 <- tfl_tcl %>% 
  dplyr::filter(list_code_wa=="IUCN_1994") %>% 
  dplyr::mutate(category_code=category_code_wa) %>% 
  dplyr::left_join(
    dplyr::filter(tsc_conscat_sp, conservation_list == 5), 
    by="category_code") %>% 
  dplyr::transmute(
        source = 2, # TaxonGaz.source tfl 1, TFL 2, TEC 3
        source_id = source_id %>% as.character(),
        scope = 0, # state 0, cwth 1, intl 2, ap 3
        status = ifelse(is.na(date_delisted), 80, 90),
        effective_from = date_listed,
        effective_to = date_delisted,
        review_due = recovery_plan_expiry_date,# check
        last_reviewed_on = file_last_updated,
        taxon = name_id %>% as.numeric,
        category = tsc_category_id %>% as.list(),
        criteria = tsc_criteria
    ) %>% 
  dplyr::filter(!is.na(category))

# IUCN 2001
# https://tsc.dbca.wa.gov.au/admin/conservation/conservationlist/4/change/
tfl_listing_cat_iucn2001 <- tfl_tcl %>% 
  dplyr::filter(list_code_wa=="IUCN_2001") %>% 
  dplyr::mutate(category_code=category_code_wa) %>% 
  dplyr::left_join(
    dplyr::filter(tsc_conscat_sp, conservation_list == 4), 
    by="category_code") %>% 
  dplyr::transmute(
        source = 2, # TaxonGaz.source tfl 1, TFL 2, TEC 3
        source_id = source_id %>% as.character(),
        scope = 0, # state 0, cwth 1, intl 2, ap 3
        status = ifelse(is.na(date_delisted), 80, 90),
        effective_from = date_listed,
        effective_to = date_delisted,
        review_due = recovery_plan_expiry_date,# check
        last_reviewed_on = file_last_updated,
        taxon = name_id %>% as.numeric,
        category = tsc_category_id %>% as.list(),
        criteria = tsc_criteria
    ) %>% 
  dplyr::filter(!is.na(category))

# IUCN 2012
# https://tsc.dbca.wa.gov.au/admin/conservation/conservationlist/3/change/
tfl_listing_cat_iucn2012 <- tfl_tcl %>% 
  dplyr::filter(list_code_wa=="IUCN_2012") %>% 
  dplyr::mutate(category_code=category_code_wa) %>% 
  dplyr::left_join(
    dplyr::filter(tsc_conscat_sp, conservation_list == 3), 
    by="category_code") %>% 
  dplyr::transmute(
        source = 2, # TaxonGaz.source tfl 1, TFL 2, TEC 3
        source_id = source_id %>% as.character(),
        scope = 0, # state 0, cwth 1, intl 2, ap 3
        status = ifelse(is.na(date_delisted), 80, 90),
        effective_from = date_listed,
        effective_to = date_delisted,
        review_due = recovery_plan_expiry_date,# check
        last_reviewed_on = file_last_updated,
        taxon = name_id %>% as.numeric,
        category = tsc_category_id %>% as.list(),
        criteria = tsc_criteria
    ) %>% 
  dplyr::filter(!is.na(category))

```


```{r tfl_cons_listing_upload, eval=F}

tfl_listing_cat_priority %>% 
  wastdr::wastd_POST("taxon-conservationlisting", 
                     api_url = prod, verbose=TRUE)

tfl_listing_cat_epbc %>% 
  wastdr::wastd_POST("taxon-conservationlisting", 
                     api_url = prod, verbose = TRUE)

tfl_listing_cat_iucn1994 %>% 
  wastdr::wastd_POST("taxon-conservationlisting", 
                     api_url = prod, verbose = TRUE)

tfl_listing_cat_iucn2001 %>% 
  wastdr::wastd_POST("taxon-conservationlisting", 
                     api_url = prod, verbose=TRUE)

# There are none, skip upload
# tfl_cl_iucn2012 %>% 
#   wastdr::wastd_POST("taxon-conservationlisting", api_url = prod)
```

## Occurrences
The EOO (Extent of occurrence) is calculated as the convex hull around all recorded flora occurrences, including fossil records.
For further details on the methodology behind the movement of EOO data, please follow the link to the workbook.

### TSC upload example for EOOs

```{r ex_upload_one_eoo, eval=F}
one_taxon_eoo <- tibble::tibble(
  name_id = 24162,
  eoo = eoo_polygon(tfl_occ, nid = 24162) %>% sfc_geojson()
)
wastdr::wastd_POST(one_taxon_eoo, "taxon", verbose = T)
```

### Upload EOOs to TSC

```{r prepare eoo, eval=F}
# extract all eoo
fna <- tfl_occ %>% 
  dplyr::filter(!is.na(latitude)) %>% 
  dplyr::filter(!is.na(longitude))
fna_eoo_all <- eoo_polygon(tfl_eoo)
# mapview::mapview(fna_eoo_all)

# Calculate_eoo
tfl_eoo <- fna %>% make_eoo()

# map_eoo
# mapview::mapview(head(flora_eoo$eoo_sfc))
```

```{r upload_eoo, eval=F}
tfl_eoo %>%
  dplyr::select(-data, -eoo_sfc) %>%
  wastdr::wastd_POST("taxon", verbose = T, api_url = prod)
```

### Upload TAEs to TSC
```{r flora_occ_tsc_upload, eval=F}
tfl_tae[1:100,] %>% chunk_post(serializer = "occ-taxon-points", verbose = T, api_url = prod)

tfl_tae[1:1000,] %>% chunk_post(serializer = "occ-taxon-points", verbose = T, api_url = prod)

tfl_tae %>% chunk_post(serializer = "occ-taxon-points", verbose = T, api_url = prod) # upload for all occurrences
```

## Conservation Documents

## Fire History

## Conservation Threats and Actions


# Extract and transform migrated Data from TSC
Data from TSC is extracted through the TSC API and transformed into a useable
format.

Expand the code block below to view the process.

## Conservation listings

```{r load_tsc, message=FALSE}
# Taxonomic names and taxon conservation listings for flora from TSC
if (file.exists(datafile_tsc_flora)) {
  load(datafile_tsc_flora)
} else {
  # TSC contains taxonomic names from WACensus
  tsc_taxa_flora <- "taxon" %>%
    wastdr::wastd_GET(api_url = prod,
                      query = list(paraphyletic_groups__icontains = 21)) %>%
    wastdr::wastd_parse() %>%
    dplyr::mutate(taxon = name_id %>% as.character())
  
  # Taxon conservation listings for flora
  tsc_tcl_flora <-
    wastdr::wastd_GET("taxon-conservationlisting") %>%
    wastdr::parse_taxon_conservationlisting() %>%
    dplyr::mutate(taxon = taxon %>% as.character()) %>%
    dplyr::inner_join(tsc_taxa_flora, by = "taxon")
  
  save(tsc_taxa_flora, tsc_tcl_flora, file = datafile_tsc_flora)
}
```

## Occurrences

We get Taxon occurrences with their point representations from TSC through the 
API endpoint [occ-taxon-points](https://tsc.dbca.wa.gov.au/api/1/occ-taxon-points/).

Currently, all flora and Flora occurrences are georeferenced only with point 
coordinates, not polygons.

We then get TSC Areas and split them into DBCA Regions and Districts.
Caveat: Regions and Districts to not comprehensively cover WA.

Lastly, we get a list of taxonomic names from TSC to resolve taxon IDs from
taxon occurrences to names.

occurrences are presented as `occ` with DBCA Region and District names (where
applicable), plus taxonomic names.
```{r extract_tsc_occurrences, message = FALSE, eval = FALSE}
datafile <- here::here("data/tae.RData")

if (file.exists(datafile)) {
  load(datafile)
} else {
tsc_tae <- wastdr::wastd_GET("occ-taxon-points") # 137k records

tsc_taxa_flora <- "taxon" %>%
    wastdr::wastd_GET(api_url = prod,
                      query = list(paraphyletic_groups = 21)) %>%
    wastdr::wastd_parse() %>%
    dplyr::mutate(taxon = name_id %>% as.character())

tsc_areas <- wastdr::wastd_GET("area") %>%
      magrittr::extract2("features") %>%
      geojsonio::as.json() %>%
      geojsonsf::geojson_sf()

save(tsc_tae, tsc_taxa_flora, tsc_areas, file=datafile, compress="xz")
}
```

```{r munge}
datafile_tsc_occ <- here::here("data/tsc_occ.RData")

if (file.exists(datafile_tsc_occ)) {
  load(datafile_tsc_occ)
} else {
regions <- tsc_areas %>%
  dplyr::filter(area_type == "Region") %>%
  dplyr::transmute(region_id = pk, region_name = name)

districts <- tsc_areas %>%
  dplyr::filter(area_type == "District") %>%
  dplyr::transmute(district_id = pk, district_name = name)

tsc_occ_flora <- tsc_tae %>%
  magrittr::extract2("features") %>%
  geojsonio::as.json() %>%
  geojsonsf::geojson_sf() %>% 
  sf::st_join(regions) %>% 
  sf::st_join(districts) %>% 
  dplyr::mutate(taxon = taxon %>% as.character()) %>% 
  dplyr::right_join(tsc_taxa_flora, by="taxon")
}

# save(occ, file=here::here("data/occ.RData"), compress="xz")
# load(here::here("data/occ.RData"))
```

# Compare legacy from TFL to migrated data from TSC
This section provides an automated comparison between original data from TFL,
and TFL data as uploaded into TSC. 

Data custodians should be able to comprehend this section, and be able to verify 
that the data migration has worked correctly.

Legacy data snapshot used for TFL was updated last on `r snapshot_last_updated`.

## Summary statistics

Check unique number of species by name_id.
Check unique number of observations and identify observations missing from TSC compared to TFL.
```{r tfl_summary}
tfl_tcl_unique_taxa <- tfl_tcl$name_id %>%
  unique() %>%
  length() 

tsc_tcl_unique_taxa <- tsc_tcl_flora$name_id %>%
  unique() %>%
  length()
```

## Taxonomy

Flora use a live copy of WACensus names, therefore we don't need to QA taxonomy.

## Conservation Listing

TFL has `r nrow(tfl_tcl)` conservation listings of `r tfl_tcl_unique_taxa` unique taxa.
TSC has `r nrow(tsc_tcl_flora)` flora conservation listings of 
`r tsc_tcl_unique_taxa` unique taxa.

### TFL conservation listings not in TSC

Any records in the following table indicate conservation listings in TFL that
were not migrated into TSC.

```{r missing_observations}
tfl_tcl %>%
  dplyr::anti_join(tsc_tcl_flora, by = "source_id") %>% 
  reactable::reactable(filterable = TRUE)
```

### TSC conservation listings not in tfl

The following table shows any conservation listings in TSC which are not in TFL.

```{r}
tsc_tcl_flora %>%
  dplyr::anti_join(tfl_tcl, by = "source_id") %>%
  reactable::reactable(filterable = TRUE)
```

### TFL cons listed phrase names
Some TFL cons listings have a name_id of 0. 
These are phrase names and require to be assigned the `name_id` of the published 
name, once the published name is known and entered into WACensus, then propagated
into TSC.

```{r}
tfl_tcl %>% dplyr::filter(name_id == 0) %>% reactable::reactable()
```

### Conservation criteria mapping

Conservation criteria were manually mapped for each species, 
therefore they need to be checked to confirm whether the mapping is correct. 
```{r}
tfl_conscrit %>%
  reactable::reactable(filterable = TRUE)
```

In addition, some conservation criteria could not be mapped as they do not exist 
in the list/category_code. 
These need to be corrected before the manual mapping can be updated and the 
correct criteria assigned for all species.

### Conservation listing dates

Below are the dates of the most recent conservation criteria changes made in the
snapshot of the tfl.

Excluded are tfl cons listings of unmigrated lists (AP, RL, BCA).

``` {r effective_dates}
tsc_corner_dates <- tsc_tcl_flora %>%
  summarise(
    effective_from_min = min(effective_from, na.rm = T),
    effective_from_max = max(effective_from, na.rm = T),
    effective_to_min = min(effective_to, na.rm = T),
    effective_to_max = max(effective_to, na.rm = T),
    last_reviewed_on_min = min(last_reviewed_on, na.rm = T),
    last_reviewed_on_max = max(last_reviewed_on, na.rm = T)
  )

tfl_corner_dates <- tfl_tcl %>%
  summarise(
    effective_from_min = min(date_listed, na.rm = T),
    effective_from_max = max(date_listed, na.rm = T),
    effective_to_min = min(date_delisted, na.rm = T),
    effective_to_max = max(date_delisted, na.rm = T),
    last_reviewed_on_min = min(file_last_updated, na.rm = T),
    last_reviewed_on_max = max(file_last_updated, na.rm = T)
  )

cl_corner_dates <- rbind(tfl_corner_dates, tsc_corner_dates) %>%
  t() %>%
  magrittr::set_colnames(c("TFL", "TSC"))

cl_corner_dates %>% reactable::reactable()
```


### Conservation listing differences

Summary of the number of conservation listings for each list.

Discrepancies in numbers indicate the need for a closer review of category_code and criteria_code in TFL.

Equality of numbers does not prove absence of equal numbers of false positives
and false negatives.

```{r summary_conservation_list}
make_tfl_cl_summary <- . %>% nrow() %>% as.data.frame() %>% magrittr::set_colnames("TFL")

tfl_cl_sum_priority <- tfl_listing_cat_priority %>% make_tfl_cl_summary
tfl_cl_sum_iucn1994 <- tfl_listing_cat_iucn1994 %>% make_tfl_cl_summary
tfl_cl_sum_iucn2001 <- tfl_listing_cat_iucn2001 %>% make_tfl_cl_summary
tfl_cl_sum_iucn2012 <- tfl_listing_cat_iucn2012 %>% make_tfl_cl_summary
tfl_cl_sum_epbc <- tfl_listing_cat_epbc %>% make_tfl_cl_summary


make_tsc_cl_summary <- function(data, cn){
  data %>%
  dplyr::select(category_cache) %>%
  dplyr::filter(str_detect(category_cache, cn)) %>%
  nrow() %>% 
  as.data.frame %>% 
  magrittr::set_colnames("TSC")
}


tsc_cl_sum_priority <- tsc_tcl_flora %>% make_tsc_cl_summary("Priority")
tsc_cl_sum_iucn1994 <- tsc_tcl_flora %>% make_tsc_cl_summary("IUCN1994")
tsc_cl_sum_iucn2001 <- tsc_tcl_flora %>% make_tsc_cl_summary("IUCN2001")
tsc_cl_sum_iucn2012 <- tsc_tcl_flora %>% make_tsc_cl_summary("IUCN2012")
tsc_cl_sum_epbc <- tsc_tcl_flora %>% make_tsc_cl_summary("EPBC")


tfl_cons_cat_sum <- rbind(
  tfl_cl_sum_priority,
  tfl_cl_sum_iucn1994, 
  tfl_cl_sum_iucn2001, 
  tfl_cl_sum_iucn2012,
  tfl_cl_sum_epbc
)

tsc_cons_cat_sum <- rbind(
  tsc_cl_sum_priority,
  tsc_cl_sum_iucn1994, 
  tsc_cl_sum_iucn2001, 
  tsc_cl_sum_iucn2012, 
  tsc_cl_sum_epbc 
  )

cons_cat_summary <- tfl_cons_cat_sum %>%
  cbind(tsc_cons_cat_sum) %>%
  cbind(Category = c("Priority","IUCN1994", "IUCN2001", "IUCN2012", "EPBC")) %>%
  dplyr::select("Category", everything())

cons_cat_summary %>% reactable::reactable() ## ARE THESE DIFFERENCES FROM USE OF CATEGORY_CODE AND NOT CATEGORY_CODE_WA?
```


The following tables show any conservation listings in TFL which are not in TSC, for each conservation list.

IUCN 2012
```{r }
#### IUCN 2012
tsc_listing_cat_iucn2012 <- tsc_tcl_flora %>%
  dplyr::filter(str_detect(category_cache,"IUCN(2012)"))

tfl_listing_cat_iucn2012 %>% anti_join(tsc_listing_cat_iucn2012,by = c("source_id","effective_from","status","effective_to")) %>% 
  reactable::reactable(filterable = T)
```
IUCN 2001
```{r}
#### IUCN 2001
tsc_listing_cat_iucn2001 <- tsc_tcl_flora %>%
  dplyr::filter(str_detect(category_cache,"IUCN(2001)"))

tfl_listing_cat_iucn2001 %>% anti_join(tsc_listing_cat_iucn2001,by = c("source_id","effective_from","status","effective_to")) %>% 
  reactable::reactable(filterable = T)
```
IUCN 1994
```{r}
#### IUCN 1994
tsc_listing_cat_iucn1994 <- tsc_tcl_flora %>%
  dplyr::filter(str_detect(category_cache,"IUCN(1994)"))

tfl_listing_cat_iucn1994 %>% anti_join(tsc_listing_cat_iucn1994,by = c("source_id","effective_from","status","effective_to")) %>% 
  reactable::reactable(filterable = T)
```
Priority
```{r}
#### Priority
tsc_listing_cat_priority <- tsc_tcl_flora %>%
  dplyr::filter(str_detect(category_cache,"Priority"))

tfl_listing_cat_priority %>% anti_join(tsc_listing_cat_priority,by = c("source_id","effective_from","status","effective_to")) %>% 
  reactable::reactable(filterable = T)
```
EPBC
```{r}
#### EPBC
tsc_listing_cat_epbc <- tsc_tcl_flora %>%
  dplyr::filter(str_detect(category_cache,"EPBC")) 

tfl_listing_cat_epbc %>% anti_join(tsc_listing_cat_epbc,by = c("source_id","effective_from","status","effective_to")) %>% 
  reactable::reactable(filterable = T)
```

The following tables show any conservation listings in TSC which are not in tfl, for each conservation list.

IUCN 2012
```{r }
#### IUCN 2012
tsc_listing_cat_iucn2012 %>% anti_join(tfl_listing_cat_iucn2012,by = c("source_id","effective_from","status","effective_to")) %>% 
  reactable::reactable(filterable = T)
```
IUCN 2001
```{r}
#### IUCN 2001
tsc_listing_cat_iucn2001 %>% anti_join(tfl_listing_cat_iucn2001,by = c("source_id","effective_from","status","effective_to")) %>% 
  reactable::reactable(filterable = T)
```
IUCN 1994
```{r}
#### IUCN 1994
tsc_listing_cat_iucn1994 %>% anti_join(tfl_listing_cat_iucn1994,by = c("source_id","effective_from","status","effective_to")) %>% 
  reactable::reactable(filterable = T)
```
IUCN Priority
```{r}
#### Priority
tsc_listing_cat_priority %>% anti_join(tfl_listing_cat_priority,by = c("source_id","effective_from","status","effective_to")) %>% 
  reactable::reactable(filterable = T)
```
EPBC
```{r}
#### EPBC
tsc_listing_cat_epbc %>% anti_join(tfl_listing_cat_epbc,by = c("source_id","effective_from","status","effective_to")) %>% 
  reactable::reactable(filterable = T)
```

## Occurrences

#### Date/ Location caveats
This section lists data issues which need to be fixed at the source (here, in legacy TFL).

Where a time is missing, we'll default to midnight (00:00).
Where a date is missing, we'll default to 1900-01-01.

While this modifies the original data, the consequences will not have a dramatic effect on analyses for
conservation management purposes:

* A safe default of the observation time (midnight) could introduce an error of up to one day. 
  Compared to the time frame considered (past 10-50 years of observations relative to time of 
  calculation), this error is minuscule.
* A safe default for missing dates (1900-01-01) will both exclude those observations from any recent
  observations (past 10-50 years), but still make the data available to identify the records for the
  purpose of backfilling a credible date.

Please review legacy data until the following numbers are all zero (or accept default handling):

* `r tfl_occ %>% dplyr::filter(created_date == "") %>% nrow()` records lack an explicit date\time and were 
  defaulted to midnight AWST.
* `r tfl_occ %>% dplyr::filter(is.na(latitude)) %>% nrow` latitudes are missing.
* `r tfl_occ %>% dplyr::filter(is.na(longitude)) %>% nrow` longitudes are missing.
* `r tfl_occ %>% dplyr::filter(latitude > 0) %>% nrow` latitudes lack the minus sign and turn up in China.

There are `r nrow(tfl_occ)` species occurrence records (encounters)in TFL. 
The following columns are incomplete.

```{r flora_missing_values}
tfl_skim <- tfl_occ %>% skimr::skim()

tfl_skim %>%
  filter(n_missing > 0) %>%
  # select(-stat, -level, -formatted) %>%
  reactable::reactable(filterable = TRUE)
```

#### Missing NameID
```{r missing_name_id}
tfl_occ_no_nameid <- tfl_occ %>% 
    filter(name_id == 0) %>% 
    select(species_name) %>% 
    unique()
tfl_occ_no_nameid %>% reactable::reactable()
```

#### Missing PopID
```{r missing_species_name}
tfl_occ_no_popid <- tfl_occ %>% 
    filter(pop_id == 0) %>% 
    select(species_name) %>% 
    unique()
tfl_occ_no_popid %>% reactable::reactable()
```

There are `r nrow(tfl_occ_no_nameid)` distinct scientific flora names without NameID, and `r nrow(tfl_occ_no_popid)` distinct scientific flora names without a PopID.
Any records listed here need to be fixed in the original Threatened Flora database.

#### Default/ missing date/time
```{r missing datetime}
tfl_occ_no_datetime<- tfl_occ %>% 
    filter(created_date == "")
tfl_occ_no_datetime %>% reactable::reactable()
```

#### Missing coordinates
```{r missing coordinates}
tfl_occ_no_latlng <- tfl_occ %>% 
    filter(is.na(latitude) | is.na(longitude))
tfl_occ_no_latlng %>% reactable::reactable()
```

There are `r nrow(tfl_occ_no_latlng)` distinct flora records with missing latitude or longitude.

```{r has eastnorthings}
tfl_occ_no_latlng_w_ne <- tfl_occ %>% 
  filter(is.na(latitude) | is.na(longitude)) %>% 
  filter((northing != "NA") | (easting!= "NA"))
tfl_occ_no_latlng_w_ne %>% reactable::reactable()
```

There are `r nrow(tfl_occ_no_latlng_w_ne)` distinct flora records with missing latitude or longitude, which have northings and eastings.

#### Datum
```{r datum_tally}
datum_tally <- tfl_occ %>%
  dplyr::group_by(datum) %>%
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>% 
  ungroup()
datum_tally %>% reactable::reactable()
```

There are `r nrow(datum_tally)` different datums used across all distinct flora records. 

```{r datum_blank}
datum_blank<- tfl_occ %>% 
    filter(datum == "")
```

There are `r nrow(datum_blank)` distinct flora records with missing datum.

TODO Which datum do we want to use? WGS84 and GDA94 are designed to be <1m different. GDA94 is designed to be comparable with WGS84 GPS data. As GDA94 is the most frequently used datum in the dataset, should we convert all others to GDA94?

### Occurrence mapping

Occurrence criteria were manually mapped for each variable, therefore they need to be checked to confirm whether the mapping is correct. 

Some conservation criteria could not be mapped as they do not exist in the list/category_code.
```{r}
#landform
tfl_landcrit %>%
  reactable::reactable(filterable = TRUE)
#rocktype
tfl_rocktype %>%
  reactable::reactable(filterable = TRUE)
#soil_type
tfl_soiltype %>%
  reactable::reactable(filterable = TRUE)
```
Soil type: Three of these criteria cound not be mapped because and we don't know what they are.
```{r}
#soil_colour
tfl_soilcolour %>%
  reactable::reactable(filterable = TRUE)
#drainage
tfl_drainage %>%
  reactable::reactable(filterable = TRUE)
#soil_condition
tfl_soil_condition %>%
  reactable::reactable(filterable = TRUE)
#survey_method
tfl_survey_method %>%
  reactable::reactable(filterable = TRUE)
#plant_count_method
tfl_plant_count_method %>%
  reactable::reactable(filterable = TRUE)
#counted_subject
tfl_plant_count_subject %>%
  reactable::reactable(filterable = TRUE)
#plant_condition
tfl_plant_condition %>%
  reactable::reactable(filterable = TRUE)
#sample_destination
tfl_sampdest %>%
  reactable::reactable(filterable = TRUE) 

```
Sample destination was manually mapped to a generic field for its location and the specific location added to the smaple label field as free text. We have done this because, combined with flora, there are > 100 unique locations for sample destination, which would make a very long drop down menu.

The above need to be corrected  before the manual mapping can be completed.

### Trust level of occurrence records
Currently, we assume that all occurrence records in the legacy databases are trustworthy.
If this weren't the case, this analysis should exclude the non-trustworthy records.

### TFL_OCC occurrences not in TFL_TAE

Any records in the following table indicate occurrences in tfl that
were not migrated into TSC.

```{r missing_occurrences}
missing_occ_tfl_tae <- tfl_occ %>%
  dplyr::anti_join(tfl_tae, by = c("id" = "source_id")) 

missing_occ_tfl_tae %>% reactable::reactable(filterable = TRUE)

```

There are `r nrow(missing_occ_tfl_tae)` occurrences missing from tfl_tae when compared to tfl_occ. The occurrences listed were likely not migrated because they do not contain lat or long data which is a requirement for valid taxon area encounters.

The table below is a tally of mismatching occurrences and confirms the two missing occurrences identified above.

```{r tally_tfl_tae}
tfl_occ_tally <- tfl_occ %>%
  dplyr::group_by(name_id) %>% 
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>% 
  ungroup()

tfl_tae_tally <- tfl_tae %>%
  dplyr::group_by(taxon) %>% 
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>% 
  ungroup() %>% 
  dplyr::rename(name_id = taxon)

tfl_occ_tally %>%
  dplyr::rename(tfl = n) %>% 
  left_join(tfl_tae_tally,by = "name_id") %>% 
  dplyr::rename(tae = n) %>% 
  filter(tfl != tae) %>% reactable::reactable()
```

### TFL_TAE occurrences not in TSC_TAE

Any records in the following table indicate taxon in TFL that were not migrated into TSC.

#### Name mismatches tfl_tae to tsc_tae
```{r name mismatches}
missing_taxa_tsc <- tfl_tae %>% 
    dplyr::anti_join(tsc_tae, by = "taxon") 

missing_taxa_tsc_unique <- missing_taxa_tsc %>% 
    dplyr::select(taxon) %>% 
    distinct() %>% 
  dplyr::left_join(tsc_taxa_flora,by = "taxon")#26

missing_taxa_tsc_unique %>% reactable::reactable()

```

There are `r nrow(missing_taxa_tsc)` taxon records missing from tsc_tae when compared to taf_tae. These records are attributed to `r nrow(missing_taxa_tsc_unique)` unique species.  

#### Name mismatches tfl_tae to tsc_occ_flora
```{r name mismatches}
missing_taxa_occ_flora <- tfl_tae %>% 
    dplyr::anti_join(tsc_occ_flora, by = "taxon") 

missing_taxa_occ_flora_unique <- missing_taxa_occ_flora %>% 
    dplyr::select(taxon) %>% 
    distinct() %>% 
  dplyr::left_join(tsc_taxa_flora,by = "taxon")#152

missing_taxa_occ_flora_unique %>% reactable::reactable()

```

There are `r nrow(missing_taxa_occ_flora)` taxon records missing from tsc_occ_flora when compared to tfl_tae. These records are attributed to `r nrow(missing_taxa_occ_flora_unique)` unique species.  

#### Occurrence mismatches tfl_tae to tsc_tae
```{r missing_occurrences}

missing_occ_tae_tsc <- tfl_tae %>%
  dplyr::anti_join(tsc_tae, by = "source_id") 

missing_occ_tae_tsc %>% reactable::reactable()
# missing_occ_tae_tsc <- tsc_tae %>%
#   dplyr::anti_join(tsc_occ_flora, by = "source_id") 

missing_occ_tae_tsc_unique <- missing_occ_tae_tsc %>% 
    dplyr::select(taxon) %>% 
    distinct() %>% 
  dplyr::left_join(tsc_taxa_flora,by = "taxon") #27

```

There are `r nrow(missing_occ_tae_tsc)` unique occurrences missing from tsc_tae when compared to tfl_tae. These missing occurrences come from `r nrow(missing_occ_tae_tsc_unique)` unique species.

The table below is a tally of mismatching occurrences and confirms the missing occurrences identified above.

```{r tally_tfl_tae}
tfl_tae_tally <- tfl_tae %>%
  dplyr::group_by(source_id) %>% 
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>% 
  ungroup() 

tsc_tae_tally <- tsc_tae %>%
  dplyr::group_by(source_id) %>% 
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>% 
  ungroup() 

tfl_tsc_tae_tally <- tfl_tae_tally %>%
  dplyr::rename(tfl = n) %>% 
  left_join(tsc_tae_tally,by = "source_id") %>% 
  dplyr::rename(tsc = n) %>% 
  filter(tfl != tsc)

tfl_tsc_tae_tally %>% reactable::reactable()
```

#### Occurrence mismatches tfl_tae to tsc_occ_flora
```{r missing_occurrences}

missing_occ_tfl_occ_flora <- tfl_tae %>%
  dplyr::anti_join(tsc_occ_flora, by = "source_id") #39073

missing_occ_tfl_occ_flora %>% reactable::reactable(filterable = T)
# missing_occ_tae_tsc <- tsc_tae %>%
#   dplyr::anti_join(tsc_occ_flora, by = "source_id") 

missing_occ_tfl_occ_flora_unique <- missing_occ_tfl_occ_flora %>% 
    dplyr::select(taxon) %>% 
    distinct() %>%  
   dplyr::left_join(tsc_taxa_flora,by = "taxon") #381

```

There are `r nrow(missing_occ_tfl_occ_flora)` unique occurrences missing from tsc_occ_flora when compared to tfl_tae. These missing occurrences come from `r nrow(missing_occ_tfl_occ_flora_unique)` 381 unique species.

The table below is a tally of mismatching occurrences and confirms the missing occurrences identified above.

```{r tally_tfl_tae}
tfl_tae_tally <- tfl_tae %>%
  dplyr::group_by(source_id) %>% 
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>% 
  ungroup() 

tsc_occ_flora_tally <- tsc_occ_flora %>%
  dplyr::group_by(source_id) %>% 
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>% 
  ungroup() 

tfl_tae_tsc_occ_tally <- tfl_tae_tally %>%
  dplyr::rename(tfl = n) %>% 
  left_join(tsc_occ_flora_tally,by = "source_id") %>% 
  dplyr::rename(tsc = n) %>% 
  filter(tfl != tsc) %>% sf_as_tbl()

tfl_tae_tsc_occ_tally %>% reactable::reactable()

```

## Conservation Documents

## Fire History

## Conservation Threats and Actions

# Upload to data catalogue
The [compiled version of this workbook]() is uploaded to the 
[Threatened Flora Dataset](https://data.dpaw.wa.gov.au/dataset/threatened-and-priority-flora-database/) 
on the DBCA data catalogue.

The manual mapping of conservation criteria, plus all legacy data is also
uploaded as CSV snapshots.

```{r upload_data_catalogue}
# This workbook
upload_file_to_ckan("1b5e6401-82fe-4728-83be-f3f8ea4b5876", "EDA_flora.html")

# Manual mapping of conservation criteria
# upload_file_to_ckan("", here::here("tfl_conscrit_w_tsc.csv"))

# Legacy tfl data
d <- ckanr::package_show("threatened-and-priority-flora-database")
# upload_to_ckan(
#   tfl_cons_listings, "Threatened Flora Conservation Status Gazettal", d$id,
#   resource_id = ""
# )
# same for other tfl legacy data, copy over from data_etl_flora.Rmd
```

