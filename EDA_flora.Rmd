---
title: 'Data ETL and QA: Flora'
author: "Florian Mayer and Milly Piggott, DBCA"
date: "`r Sys.time()`"
always_allow_html: yes
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    fig_width: 10
    fig_height: 6
    code_folding: hide
    theme: yeti
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = TRUE)
source("helpers.R")

# Cached data from TFL database on CKAN - delete to force refresh
tfl_extracted <- here::here("data/tfl_extracted.Rdata")
tfl_transformed <- here::here("data/tfl_transformed.RData")
tfl_occ_datafile <- here::here("data/tfl_occ.RData")
tsc_extracted_flora <- here::here("data/tsc_extracted_flora.RData")
```

# Context

This workbook summarizes the legacy data migration and QA for the Threatened and
Priority Flora database (TFL).

The last chapter of this workbook forms the "data migration report", which 
shows whether the data migration was correct, consistent, and comprehensive.

![](https://data.dbca.wa.gov.au/dataset/79e90d7b-33a3-4aa0-8634-8a12033eb21d/resource/98588a4e-b3af-452b-bbf4-f63ca7697752/download/tsc-progress.jpg){width="100%"}

By default, all code blocks are collapsed to provide better readability to the
non-technical audience. Feel free to expand the code blocks to view the process.

The code for all SCB workbooks is under version control at
[github](https://github.com/dbca-wa/scarab-scripts).

## How to read this workbook
This workbook servers several audiences.

### Data custodians
**Data custodians** are the "daily drivers" of the legacy systems, and will be
the "daily drivers" of TSC.
Data custodians should 

* read this workbook end to end, and be able to understand each section,
* review the summary tables for matching totals of legacy systems vs TSC,
* use the interactive tables for spot checks of individual records.

### Data analysts
**Data analysts** will re-build all legacy reports from TSC's API. Since this
workbook accesses and parses all data from TSC, it thereby supplies working
examples of extracting every bit of TSC data.

Reports follow a common scheme:

* access data from TSC,
* parse data into suitable shape (spreadsheets-like flat tables) and 
  datatypes (e.g. dates, locations),
* filter data as required (date range, regions),
* visualise data as required (pivot tables, maps),
* export data as required (CSV, GeoJSON),
* disseminate report as required (data catalogue, Google Drive).

This workbook shows many examples of the above steps, which then can be 
recombined and adapted by data analysts as required.

### Data engineers
**Data engineers** will ingest other data sources into TSC as required.
This workbook also contains working examples to upload every TSC related data 
using the TSC API.
Future data imports from other sources can recombine and adapt the code in this
workbook for a running start.

# Legacy Data (TFL)

Data from the Threatened Flora Database (TFL) is downloaded from the 
[TFL dataset](https://data.dbca.wa.gov.au/dataset/threatened-and-priority-flora-database)
on the DBCA data catalogue, then extracted and transformed.

## Taxonomy
This section extracts taxonomic data from TFL. 
This data will later be compared to the taxonomic data from TSC.

```{r tfl_extract}
if (file.exists(tfl_extracted)) {
  load(tfl_extracted)
} else {
  tfl_data <-
    dl_mdbzip("77062fa0-f409-4fe7-ae28-de8c933a59bd", verbose = T)
  snapshot_last_updated <-
    "77062fa0-f409-4fe7-ae28-de8c933a59bd" %>%
    ckanr::resource_show() %>%
    magrittr::extract2("last_modified") %>%
    lubridate::as_datetime() %>%
    lubridate::with_tz("Australia/Perth")
  save(tfl_data, snapshot_last_updated, file = tfl_extracted)
}
```


```{r tfl_transform}
# Look up tables
populations <- tfl_data$DRF_POPULATION %>%
  dplyr::transmute(
    pop_id = POP.ID %>% as.character(),
    pop_number = POP.NUMBER %>% as.character(),
    subpop_code = SUBPOP.CODE %>% as.character(),
    taxonid = TAXONID %>% as.character(),
    spname = SPNAME %>% as.character(),
    parent_pop_id = PARENT.POP.ID %>% as.character(),
    pop_rec_type_ind = POP.REC.TYPE.IND %>% as.character(),
    creation_sheetno = CREATION.SHEETNO %>% as.character(),
    first_observed_date = FIRST.OBSERVED.DATE %>% as.character(),
    confirmed = CONFIRMED %>% as.character(),
    status = STATUS %>% as.character(),
    pop_comments = POP.COMMENTS %>% as.character(),
    assoc_sp_accum = ASSOC.SP.ACCUM %>% as.character(),
    location = LOCATION %>% as.character(),
    district = DISTRICT %>% as.character(),
    landdistrict = LANDDISTRICT %>% as.character(),
    lga_code = LGA.CODE %>% as.character(),
    nearplace = NEARPLACE %>% as.character(),
    distance = DISTANCE %>% as.character(),
    direction = DIRECTION %>% as.character(),
    purpose1 = PURPOSE1 %>% as.character(),
    purpose2 = PURPOSE2 %>% as.character(),
    vesting = VESTING %>% as.character(),
    land_loc_no = LAND.LOC.NO %>% as.character(),
    reserve = RESERVE %>% as.character(),
    class = CLASS %>% as.character(),
    utility_ref = UTILITY.REF %>% as.character(),
    land_manager = LAND.MANAGER %>% as.character(),
    land_mgr_address = LAND.MGR.ADDRESS %>% as.character(),
    land_mgr_phone = LAND.MGR.PHONE %>% as.character(),
    co_ord_type_code = CO.ORD.TYPE.CODE %>% as.character(),
    co_ord_source_code = CO.ORD.SOURCE.CODE %>% as.character(),
    gda94lat = GDA94LAT %>% as.character(),
    gda94long = GDA94LONG %>% as.character(),
    loc_sect_date = LOC.SECT.DATE %>% as.character(),
    datum = DATUM %>% as.character(),
    latdeg = LATDEG %>% as.character(),
    latmin = LATMIN %>% as.character(),
    latsec = LATSEC %>% as.character(),
    longdeg = LONGDEG %>% as.character(),
    longmin = LONGMIN %>% as.character(),
    longsec = LONGSEC %>% as.character(),
    gps_zone = GPS.ZONE %>% as.character(),
    northing = NORTHING %>% as.character(),
    easting = EASTING %>% as.character(),
    no_of_satellites = NO.OF.SATELLITES %>% as.character(),
    resolution = RESOLUTION %>% as.character(),
    map_used = MAP.USED %>% as.character(),
    map_scale = MAP.SCALE %>% as.character(),
    dec_latitude = DEC.LATITUDE %>% as.character(),
    dec_longitude = DEC.LONGITUDE %>% as.character(),
    count_sect_date = COUNT.SECT.DATE %>% as.character(),
    svy_extent = SVY.EXTENT %>% as.character(),
    svy_effort_area = SVY.EFFORT.AREA %>% as.character(),
    svy_effort_time = SVY.EFFORT.TIME %>% as.character(),
    svy_effort = SVY.EFFORT %>% as.character(),
    quality_ind = QUALITY.IND %>% as.character(),
    count_mthd_code = COUNT.MTHD.CODE %>% as.character(),
    mature_plants = MATURE.PLANTS %>% as.character(),
    mature_dead = MATURE.DEAD %>% as.character(),
    juvenile_plants = JUVENILE.PLANTS %>% as.character(),
    juvenile_dead = JUVENILE.DEAD %>% as.character(),
    seedling_plants = SEEDLING.PLANTS %>% as.character(),
    seedling_dead = SEEDLING.DEAD %>% as.character(),
    cnt_plant_type_code = CNT.PLANT.TYPE.CODE %>% as.character(),
    simple_live_tot = SIMPLE.LIVE.TOT %>% as.character(),
    area_occupied = AREA.OCCUPIED %>% as.character(),
    area_occupied_method = AREA.OCCUPIED.METHOD %>% as.character(),
    quad_num = QUAD.NUM %>% as.character(),
    quad_size = QUAD.SIZE %>% as.character(),
    quad_tot_sq_m = QUAD.TOT.SQ.M %>% as.character(),
    quad_num_mature = QUAD.NUM.MATURE %>% as.character(),
    quad_num_juvenile = QUAD.NUM.JUVENILE %>% as.character(),
    quad_num_seedlings = QUAD.NUM.SEEDLINGS %>% as.character(),
    quad_num_total = QUAD.NUM.TOTAL %>% as.character(),
    clonal = CLONAL %>% as.character(),
    vegetative = VEGETATIVE %>% as.character(),
    in_buds = IN.BUDS %>% as.character(),
    in_flower = IN.FLOWER %>% as.character(),
    immature_fruit = IMMATURE.FRUIT %>% as.character(),
    fruit = FRUIT %>% as.character(),
    dehisced_fruit = DEHISCED.FRUIT %>% as.character(),
    flower_percentage = FLOWER.PERCENTAGE %>% as.character(),
    hab_sect_date = HAB.SECT.DATE %>% as.character(),
    population_condition = POPULATION.CONDITION %>% as.character(),
    population_notes = POPULATION.NOTES %>% as.character(),
    habitat_condition = HABITAT.CONDITION %>% as.character(),
    habitat_notes = HABITAT.NOTES %>% as.character(),
    soil_condition = SOIL.CONDITION %>% as.character(),
    landform = LANDFORM %>% as.character(),
    rock_type = ROCK.TYPE %>% as.character(),
    gravel = GRAVEL %>% as.character(),
    soil_type = SOIL.TYPE %>% as.character(),
    soil_color = SOIL.COLOR %>% as.character(),
    drainage = DRAINAGE %>% as.character(),
    aspect = ASPECT %>% as.character(),
    associated_species = ASSOCIATED.SPECIES %>% as.character(),
    fire_intensity = FIRE.INTENSITY %>% as.character(),
    fire_year = FIRE.YEAR %>% as.character(),
    fire_season = FIRE.SEASON %>% as.character(),
    fencing_status = FENCING.STATUS %>% as.character(),
    fencing_comments = FENCING.COMMENTS %>% as.character(),
    roadside_marker_status = ROADSIDE.MARKER.STATUS %>% as.character(),
    rdside_mkr_comments = RDSIDE.MKR.COMMENTS %>% as.character(),
    other_comments = OTHER.COMMENTS %>% as.character(),
    vchr_sect_date = VCHR.SECT.DATE %>% as.character(),
    voucher_location = VOUCHER.LOCATION %>% as.character(),
    dupvouch_location = DUPVOUCH.LOCATION %>% as.character(),
    collector_no = COLLECTOR.NO %>% as.character(),
    barcode = BARCODE %>% as.character(),
    vchr_status_code = VCHR.STATUS.CODE %>% as.character(),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character(),
    simple_dead_tot = SIMPLE.DEAD.TOT %>% as.character(),
    observer_code = OBSERVER.CODE %>% as.character(),
    obs_name = OBS.NAME %>% as.character(),
    observer_phone = OBSERVER.PHONE %>% as.character(),
    obs_role_code = OBS.ROLE.CODE %>% as.character(),
    obs_org_code = OBS.ORG.CODE %>% as.character(),
    obs_org_name = OBS.ORG.NAME %>% as.character(),
    land_mgr_notes = LAND.MGR.NOTES %>% as.character()
  )
# names_populations <- as.data.frame(names(populations))

# pop_forms is the paper form recording one population of one taxon
pop_forms <- tfl_data$DRF_POP_FORMS %>% 
  dplyr::transmute(
    pop_forms_id = POP.FORMS.ID %>% as.character(),
    pop_id = POP.ID %>% as.character(),
    sheetno = SHEETNO %>% as.character(),
    prev_pop_id = PREV.POP.ID %>% as.character(),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deact = REASON.DEACT %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    current_rec = CURRENT.REC %>% as.character(),
    chg_type_code = CHG.TYPE.CODE %>% as.character(),
    deact_by = DEACT.BY %>% as.character()
  )
# pop_forms[1:100, ] %>% rt
# names_pop_forms <- as.data.frame(names(pop_forms))

pop_threats <- tfl_data$DRF_POP_THREATS %>%
  dplyr::transmute(
    pop_threat_id = POP.THREAT.ID %>% as.character(),
    pop_id = POP.ID %>% as.character(),
    threat_code = THREAT.CODE %>% as.character(),
    cur_impact = CUR.IMPACT %>% as.character(),
    pot_impact = POT.IMPACT %>% as.character(),
    onset = ONSET %>% as.character(),
    agent_code = AGENT.CODE %>% as.character(),
    comments = COMMENTS %>% as.character(),
    status = STATUS %>% as.character(),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character(),
    sheetno = SHEETNO %>% as.character(),
    observation_date = OBSERVATION.DATE %>% as.character()
  )
# pop_threats[1:100, ] %>% rt
names_pop_threats <- as.data.frame(names(pop_threats))

pop_vegclass <- tfl_data$DRF_POP_VEG_CLASSES %>%
  dplyr::transmute(
    veg_class_id = VEG.CLASS.ID %>% as.character(),
    veg_class_code = VEG.CLASS.CODE %>% as.character(),
    pop_id = POP.ID %>% as.character(),
    veg_class_dom1 = VEG.CLASS.DOM1 %>% as.character(),
    veg_class_dom2 = VEG.CLASS.DOM2 %>% as.character()
  )
names_pop_vegclass <- as.data.frame(names(pop_vegclass))
# pop_vegclass[1:100, ] %>% rt
```

## Conservation listings
This section extracts conservation listings from TFL.
TFL conservation criteria are exported as CSV spreadsheet for manual mapping
to TSC values.

```{r make_tfl_cl}
# TFL taxon conservation listings
tfl_cons_listing <- tfl_data$DRF_TAXON_CONSV_LISTINGS %>%
  dplyr::transmute(
    txn_list_id = TXN.LIST.ID %>% as.character(),
    name_id = TAXONID %>% as.integer(),
    name = NAME %>% as.character(),
    list_code = LIST.CODE %>% as.character(),
    category_code = STATUS.CODE %>% as.character(),
    list_code_wa = WA.IUCN.RANK.LIST.CODE %>% as.character(),
    category_code_wa = WA.IUCN.RANK %>% as.character(),
    criteria_code_wa = IUCN.CRITERIA %>% as.character(),
    date_listed = DATE.LISTED %>% parse_date_time(., orders = orders, tz = tz),
    reasons = REASONS %>% as.character(),
    authority = AUTHORITY %>% as.character(),
    date_delisted = DATE.DELISTED %>% parse_date_time(., orders = orders, tz = tz),
    comments = COMMENTS %>% as.character(),
    distribution = DISTRIBUTION %>% as.character(),
    fl_period = FL.PERIOD %>% as.character(),
    prev_taxonid = PREV.TAXONID %>% as.character(),
    prev_name = PREV.NAME %>% as.character(),
    fam_no = FAM.NO %>% as.character(),
    recovery_plan = R.PLAN %>% as.character(),
    recovery_plan_comments = RP.COMMENTS %>% as.character(),
    recovery_plan_expiry_date = RP.EXP.DATE %>% parse_date_time(., orders = orders, tz = tz),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% parse_date_time(., orders = orders, tz = tz),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% parse_date_time(., orders = orders, tz = tz),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE%>% parse_date_time(., orders = orders, tz = tz),
    file_last_updated = FILE.LAST.UPDATED %>% parse_date_time(., orders = orders, tz = tz),
    file_comments = FILE.COMMENTS %>% as.character(),
    file_no = FILE.NO %>% as.character()
  ) %>% 
  tibble::rowid_to_column("source_id") %>%
  dplyr::mutate(source_id = source_id %>% as.character()) %>% 
  dplyr::arrange(name_id)

# tfl_cons_listing[1:100, ] %>% rt
readr::write_csv(tfl_cons_listing, path = here::here("data","tfl_cons_listing.csv"))

# Legacy conservation criteria are free text in condensed writing.
# Write to CSV for manual mapping to TSC criteria PKs.
all_crit_map <- tfl_cons_listing %>%
  dplyr::group_by(list_code_wa) %>% 
  dplyr::distinct(criteria_code_wa) %>% 
  dplyr::arrange(list_code_wa, criteria_code_wa) %>% 
  dplyr::select(list_code_wa, criteria_code_wa)
readr::write_csv(all_crit_map, path = here::here("data","all_tfl_conscrit.csv"))
```

## Occurrences
This section extracts TFL occurrences.

```{r get_tfl_occ, message=FALSE, warning=FALSE}
# Taxon occurrences
tfl_occ <- tfl_data$DRF_RFR_FORMS %>%
  dplyr::transmute(
    # IDs
    source_id = SHEETNO %>% as.character(),
    name_id = TAXONID %>% as.character(),
    species_name = SPNAME %>% as.character(),
    new_pop_ind = NEW.POP.IND %>% as.character(), # Y N
    pop_id = SHEET.POP.NUMBER %>% as.integer(),
    subpop_code = SHEET.SUBPOP.CODE %>% as.character(),
    record_src_code = RECORD.SRC.CODE %>% as.character(),

    # location
    latitude = GDA94LAT %>% as.double(),
    longitude = GDA94LONG %>% as.double(),
    location = LOCATION %>% as.character(),
    district = DISTRICT %>% as.character(),
    landdistrict = LANDDISTRICT %>% as.character(),
    lga_code = LGA.CODE %>% as.character(),
    nearplace = NEARPLACE %>% as.character(),
    distance = DISTANCE %>% as.character(),
    direction = DIRECTION %>% as.character(),
    purpose1 = PURPOSE1 %>% as.character(),
    purpose2 = PURPOSE2 %>% as.character(),
    vesting = VESTING %>% as.character(),
    land_loc_no = LAND.LOC.NO %>% as.character(),
    reserve = RESERVE %>% as.character(),
    class = CLASS %>% as.character(),
    utility_ref = UTILITY.REF %>% as.character(),
    co_ord_type_code = CO.ORD.TYPE.CODE %>% as.character(),
    co_ord_source_code = CO.ORD.SOURCE.CODE %>% as.character(),
    datum = DATUM %>% as.character(),
    # latdeg = LATDEG %>% as.character(),
    # latmin = LATMIN %>% as.character(),
    # latsec = LATSEC %>% as.character(),
    # longdeg = LONGDEG %>% as.character(),
    # longmin = LONGMIN %>% as.character(),
    # longsec = LONGSEC %>% as.character(),
    # gps_zone = GPS.ZONE %>% as.character(),
    northing = NORTHING %>% as.character(),
    easting = EASTING %>% as.character(),
    no_of_satellites = NO.OF.SATELLITES %>% as.character(),
    resolution = RESOLUTION %>% as.character(),
    map_used = MAP.USED %>% as.character(),
    map_scale = MAP.SCALE %>% as.character(),
    # dec_latitude = DEC.LATITUDE %>% as.character(),
    # dec_longitude = DEC.LONGITUDE %>% as.character(),

    # habitat description
    landform = LANDFORM %>% as.character(),
    rock_type = ROCK.TYPE %>% as.character(),
    gravel = GRAVEL %>% as.character(),
    soil_type = SOIL.TYPE %>% as.character(),
    soil_color = SOIL.COLOR %>% as.character(),
    drainage = DRAINAGE %>% as.character(),
    aspect = ASPECT %>% as.character(),
    associated_species = ASSOCIATED.SPECIES %>% as.character(),
    fire_intensity = FIRE.INTENSITY %>% as.character(),
    fire_year = FIRE.YEAR %>% as.character(),
    fire_season = FIRE.SEASON %>% as.character(),
    fire_ind = FIRE.IND %>% as.character(),
    fencing_status = FENCING.STATUS %>% as.character(),
    fencing_comments = FENCING.COMMENTS %>% as.character(),
    roadside_marker_status = ROADSIDE.MARKER.STATUS %>% as.character(),
    rdside_mkr_comments = RDSIDE.MKR.COMMENTS %>% as.character(),
    other_comments = OTHER.COMMENTS %>% as.character(),

    # habitat condition
    habitat_condition = HABITAT.CONDITION %>% as.character(),
    habitat_notes = HABITAT.NOTES %>% as.character(),
    soil_condition = SOIL.CONDITION %>% as.character(),

    # site quadrat info
    quad_num = QUAD.NUM %>% as.character(),
    quad_size = QUAD.SIZE %>% as.character(),
    quad_tot_sq_m = QUAD.TOT.SQ.M %>% as.character(),
    quad_num_mature = QUAD.NUM.MATURE %>% as.character(),
    quad_num_juvenile = QUAD.NUM.JUVENILE %>% as.character(),
    quad_num_seedlings = QUAD.NUM.SEEDLINGS %>% as.character(),
    quad_num_total = QUAD.NUM.TOTAL %>% as.character(),

    # survey / site visit
    observation_date = OBSERVATION.DATE %>% parse_as_datetime(),
    svy_extent = SVY.EXTENT %>% as.character(),
    svy_effort_area = SVY.EFFORT.AREA %>% as.character(),
    svy_effort_time = SVY.EFFORT.TIME %>% as.character(),
    svy_effort = SVY.EFFORT %>% as.character(),
    landowner_present = LANDOWNER.PRESENT %>% as.character(),

    # observer
    observer_code = OBSERVER.CODE %>% as.character(),
    obs_name = OBS.NAME %>% as.character(),
    observer_phone = OBSERVER.PHONE %>% as.character(),
    obs_role_code = OBS.ROLE.CODE %>% as.character(),
    obs_org_code = OBS.ORG.CODE %>% as.character(),
    obs_org_name = OBS.ORG.NAME %>% as.character(),

    # measurements
    quality_ind = QUALITY.IND %>% as.character(),
    count_mthd_code = COUNT.MTHD.CODE %>% as.character(),
    mature_plants = MATURE.PLANTS %>% as.character(),
    mature_dead = MATURE.DEAD %>% as.character(),
    juvenile_plants = JUVENILE.PLANTS %>% as.character(),
    juvenile_dead = JUVENILE.DEAD %>% as.character(),
    seedling_plants = SEEDLING.PLANTS %>% as.character(),
    seedling_dead = SEEDLING.DEAD %>% as.character(),
    cnt_plant_type_code = CNT.PLANT.TYPE.CODE %>% as.character(),
    simple_live_tot = SIMPLE.LIVE.TOT %>% as.character(),
    area_occupied = AREA.OCCUPIED %>% as.character(),
    area_occupied_method = AREA.OCCUPIED.METHOD %>% as.character(),

    # plant properties
    clonal = CLONAL %>% as.character(),
    vegetative = VEGETATIVE %>% as.character(),
    in_buds = IN.BUDS %>% as.character(),
    in_flower = IN.FLOWER %>% as.character(),
    immature_fruit = IMMATURE.FRUIT %>% as.character(),
    fruit = FRUIT %>% as.character(),
    dehisced_fruit = DEHISCED.FRUIT %>% as.character(),
    flower_percentage = FLOWER.PERCENTAGE %>% as.character(),
    simple_dead_tot = SIMPLE.DEAD.TOT %>% as.integer(),
    pollinator = POLLINATOR %>% as.character(),

    # population
    population_condition = POPULATION.CONDITION %>% as.character(),
    population_notes = POPULATION.NOTES %>% as.character(),

    # taxonomy, voucher specimens
    voucher_location = VOUCHER.LOCATION %>% as.character(),
    dupvouch_location = DUPVOUCH.LOCATION %>% as.character(),
    collector_no = COLLECTOR.NO %>% as.character(),
    barcode = BARCODE %>% as.character(),
    vchr_status_code = VCHR.STATUS.CODE %>% as.character(),

    # attachments
    attached_doc1 = ATTACHED.DOC1 %>% as.character(),
    attached_doc2 = ATTACHED.DOC2 %>% as.character(),
    attached_doc3 = ATTACHED.DOC3 %>% as.character(),
    attached_other_doc = ATTACHED.OTHER.DOC %>% as.character(),
    report_key = REPORT.KEY %>% as.character(),

    # metadata
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character(),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    form_status_code = FORM.STATUS.CODE %>% as.character(),
    classification_code = CLASSIFICATION.CODE %>% as.character(),
    florabus_ind = FLORABUS.IND %>% as.character(),
    licence = LICENCE %>% as.character()
  )

occ_liaisons <- tfl_data$DRF_LIAISONS %>%
  dplyr::transmute(
    liaisons_id = LIAISONS.ID %>% as.integer(),
    pop_id = POP.ID %>% as.integer(),
    notify_date = NOTIFY.DATE %>% as.character(),
    othernames = OTHERNAMES %>% as.character(),
    initials = INITIALS %>% as.character(),
    surname = SURNAME %>% as.character(),
    address = ADDRESS %>% as.character(),
    phone_number = PHONE.NO %>% as.character(),
    comments = COMMENTS %>% as.character(),
    notification_type = NOTIFICATION.TYPE %>% as.character(),
    notifier_name = NOTIFIER.NAME %>% as.character(),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character())



occ_priority <- tfl_data$DRF_P2K_PRIORITY %>%
  dplyr::transmute(
    species = SPECIES %>% as.character(),
    taxon_id = TAXONID %>% as.integer(),
    change = CHANGE %>% as.character(),
    change_date = CHANGE.DATE %>% as.character(),
    add_date = ADD.DATE %>% as.character(),
    delete_date = DELETE.DATE %>% as.character(),
    informal = INFORMAL %>% as.character(),
    authority = INFORMAL %>% as.character(),
    pr_code = PR.CODE %>% as.character(),
    wa_iucn_rank = WA.IUCN.RANK %>% as.character(),
    iucn_criteria = IUCN.CRITERIA %>% as.character(),
    date_iucn_change = DATE.IUCN.CHANGE %>% as.character(),
    epbc_rank = EPBC.RANK %>% as.character(),
    calm_reg = CALM.REG %>% as.character(),
    district = DISTRICT %>% as.character(),
    dist = DIST %>% as.character(),
    fl_period = FL.PERIOD %>% as.character(),
    old_name = OLD.NAME %>% as.character(),
    fam_num = FAM.NO %>% as.character(),
    file_num = FILE.NO %>% as.character(),
    man_plan = MANPLAN %>% as.character(),
    row_num = ROW.NO %>% as.integer()
    )

## Occurrence observations
hab_comp <- tfl_occ %>%
   has_name_id_and_location %>% 
  dplyr::transmute(
    source = 11,
    source_id = source_id,
    landform = landform,
    rock_type = rock_type,
    loose_rock = gravel,
    soil_type = soil_type,
    soil_colour = soil_color,
    drainage = drainage,
    aspect = aspect) %>%
  filter(landform != "" | 
           rock_type != "" | 
           loose_rock != "" | 
           soil_type != "" | 
           soil_colour != "" | 
           drainage != "" |  
           aspect != "")
# TODO fiter correct?

hab_comp %>%
  dplyr::select(landform) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_landcrit.csv"))

hab_comp %>%
  dplyr::select(rock_type) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_rocktype.csv"))

hab_comp %>%
  dplyr::select(loose_rock) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_looserock.csv"))

hab_comp %>%
  dplyr::select(soil_type) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_soiltype.csv"))

hab_comp %>%
  dplyr::select(soil_colour) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_soilcolour.csv"))

hab_comp %>%
  dplyr::select(drainage) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_drainage.csv"))

hab_comp %>%
  dplyr::select(aspect) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_aspect.csv"))

area_ass <- tfl_occ %>%
  has_name_id_and_location %>% 
  dplyr::transmute(
    source = 11,
    source_id = source_id,
    survey_method = svy_extent,
    surveyed_area = svy_effort_area,
    survey_duration = svy_effort_time) %>% 
  dplyr::filter(
    survey_method != "" | 
      surveyed_area != "NA" | 
      survey_duration!= "NA"
  )

area_ass %>%
  dplyr::select(survey_method) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_survey_method.csv"))

# TODO There is a problem with migrating this- won't match TSC card
hab_cond <- tfl_occ %>%
  has_name_id_and_location %>% 
  dplyr::transmute(
    source = 11,
    source_id = source_id,
    occurrence_condition = habitat_condition,
    soil_condition = soil_condition) %>%  
  dplyr::filter(occurrence_condition != "" | soil_condition != "")

hab_cond %>%
  dplyr::select(soil_condition) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_soil_condition.csv"))

tfl_fire_hist <- tfl_occ %>%
  has_name_id_and_location %>% 
  dplyr::transmute(
    source = 11,
    source_id = source_id,
    fire_intensity = fire_intensity,
    fire_year = fire_year,
    fire_season = fire_season) %>%
   dplyr::mutate(fire_year = case_when(is.na(fire_year) ~ "1900",
  TRUE ~ as.character(fire_year)))%>%
   dplyr::mutate(fire_intensity = case_when(fire_intensity == "0" ~ "no",
                                fire_intensity == "1" ~ "low",
                                fire_intensity == "2" ~ "medium",
                                fire_intensity == "3" ~ "high")) %>% 
  dplyr::mutate(month = case_when(fire_season == "SPR" ~ "09",
                                fire_season == "SUM" ~ "12",
                                fire_season == "AUT" ~ "03",
                                fire_season == "WIN" ~ "06",
                           fire_season =="" ~ "01")) %>% 
  dplyr::mutate(day = case_when(month == "03" ~ "01",
  month == "06" ~ "01",
  month == "09" ~ "01",
  month == "12" ~ "01",
  month == "01" ~ "01")) %>% 
  dplyr::transmute(source = source,
    source_id = source_id,
    fire_intensity = fire_intensity,
    fire_date = glue::glue("{fire_year}-{month}-{day}", .na = "NA") %>% 
      as.character()
  ) %>% 
  dplyr::mutate(fire_date = case_when(
    is.na(fire_intensity) ~ "NA",
    TRUE ~ as.character(fire_date))
  ) %>% 
  dplyr::filter(fire_intensity != "NA" | fire_date != "NA")

plant_count <- tfl_occ %>%
  has_name_id_and_location %>% 
  dplyr::transmute(
    source = 11,
    source_id = source_id,
    number_of_quadrats_surveyed = quad_num,
    individual_quadrat_area = quad_size,
    total_quadrat_area =quad_tot_sq_m,
    land_manager_present = landowner_present,
    plant_count_method = count_mthd_code,
    number_alive_mature = mature_plants,
    number_dead_mature = mature_dead,
    number_alive_juvenile = juvenile_plants,
    number_dead_juvenile = juvenile_dead,
    number_alive_seedlings = seedling_plants,
    number_dead_seedlings = seedling_dead,
    counted_subject = cnt_plant_type_code,
    number_alive = simple_live_tot,
    estimates_population_area = area_occupied,
    area_occupied_method = area_occupied_method,
    clonal_reproduction_present = clonal,
    vegetative_state_present = vegetative,
    flower_buds_present = in_buds,
    flowers_present = in_flower,
    immature_fruit_present = immature_fruit,
    ripe_fruit_present = fruit,
    dehisced_fruit_present = dehisced_fruit,
    flowering_plants = flower_percentage,
    number_dead = simple_dead_tot,
    plant_condition = population_condition,
    comments = population_notes) %>% 
  dplyr::filter(
    plant_count_method != "" | 
      counted_subject != "" | 
      plant_condition != "" | 
      comments != ""
  ) %>% 
  dplyr::mutate_at(vars(c("land_manager_present","clonal_reproduction_present","vegetative_state_present","flower_buds_present","flowers_present","immature_fruit_present","ripe_fruit_present","dehisced_fruit_present")), funs(. == 'Y')) 
  
# TODO filter correct?

plant_count %>%
  dplyr::select(plant_count_method) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_plant_count_method.csv"))

plant_count %>%
  dplyr::select(counted_subject) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_counted_subject.csv"))

plant_count %>%
  dplyr::select(plant_condition) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_plant_condition.csv"))

ass_species <- tfl_occ %>%
  has_name_id_and_location %>% 
  dplyr::transmute(
    source = 11,
    source_id = source_id,
    taxon = associated_species) %>% 
  dplyr::filter(taxon != "")

# TODO add destinations for WA HERB/ INT HERB/ DIS HERB in TSC
phys_sample <- tfl_occ %>% 
  has_name_id_and_location %>% 
  dplyr::transmute(
    source = 11,
    source_id = source_id,
    sample_type = "plant-specimen",
    sample_destination = voucher_location, 
    duplicate_sample_destination = dupvouch_location,
    sample_label = glue::glue("[{sample_destination}]{barcode}"),
    permit_id = licence) %>% 
  dplyr::filter(sample_destination != "") 

phys_sample %>%
  dplyr::select(sample_destination) %>%
  distinct() %>% 
  readr::write_csv(path = here::here("data", "tfl_sample_destination.csv"))

# Occurrence vegetation classes
occ_vegclass <- tfl_data$DRF_SHEET_VEG_CLASSES %>%
  dplyr::transmute(
    veg_class_id = VEG.CLASS.ID %>% as.integer(),
    veg_class_code = VEG.CLASS.CODE %>% as.character(),
    sheetno = SHEETNO %>% as.character(),
    veg_class_dom1 = VEG.CLASS.DOM1 %>% as.character(),
    veg_class_dom2 = VEG.CLASS.DOM2 %>% as.character()
  )

## Occurrence threats
occ_threats <- tfl_data$DRF_SHEET_THREATS %>%
  dplyr::transmute(
    sheet_threat_id = SHEET.THREAT.ID %>% as.character(),
    source_id = SHEETNO %>% as.character(),
    threat_code = THREAT.CODE %>% as.character(),
    cur_impact = CUR.IMPACT %>% as.character(),
    pot_impact = POT.IMPACT %>% as.character(),
    onset = ONSET %>% as.character(),
    agent_code = AGENT.CODE %>% as.character(),
    comments = COMMENTS %>% as.character(),
    status = STATUS %>% as.character(),
    active_ind = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character()
  )

## Occurrence fire details
occ_fire <- tfl_data$DRF_FIRE_DETAILS %>%
  dplyr::transmute(
    fire_det_id = FIRE.DET.ID %>% as.character(),
    source_id = SHEET.NO %>% as.character(),
    sit_id = SIT.ID %>% as.character(),
    quadrat_name = QUADRAT.NAME %>% as.character(),
    fire_date = FIRE.DATE %>% as.character(),
    other_treatment_date = OTHER.TREATMENT.DATE %>% as.character(),
    other_treatment_type = OTHER.TREATMENT.TYPE %>% as.character(),
    unburnt_postburn = UNBURNT.POSTBURN %>% as.character(),
    months_since_fire = MONTHS.SINCE.FIRE %>% as.character(),
    fire_type = FIRE.TYPE %>% as.character(),
    burnt_pct = BURNT.PCT %>% as.character(),
    fuel_age = FUEL.AGE %>% as.character(),
    flammability = FLAMMABILITY %>% as.character(),
    seedlings_new = SEEDLINGS.NEW %>% as.character(),
    seedlings_old = SEEDLINGS.OLD %>% as.character(),
    juveniles = JUVENILES %>% as.character(),
    adults_pre_burn_alive = ADULTS.PRE.BURN.ALIVE %>% as.character(),
    adults_pre_burn_dead = ADULTS.PRE.BURN.DEAD %>% as.character(),
    adults_post_burn_unburnt = ADULTS.POST.BURN.UNBURNT %>% as.character(),
    adults_post_burn_burnt = ADULTS.POST.BURN.BURNT %>% as.character(),
    adults_post_burn_respr = ADULTS.POST.BURN.RESPR %>% as.character(),
    adults_post_burn_dead = ADULTS.POST.BURN.DEAD %>% as.character(),
    flowering_pct_seeder = FLOWERING.PCT.SEEDER %>% as.character(),
    flowering_pct_respr = FLOWERING.PCT.RESPR %>% as.character(),
    fruiting_pct_seeder = FRUITING.PCT.SEEDER %>% as.character(),
    fruiting_pct_respr = FRUITING.PCT.RESPR %>% as.character(),
    dehisced_fruit_pct = DEHISCED.FRUIT.PCT %>% as.character(),
    native_alive_pct = NATIVE.ALIVE.PCT %>% as.character(),
    weed_cover_pct = WEED.COVER.PCT %>% as.character(),
    bare_ground_pct = BARE.GROUND.PCT %>% as.character(),
    litter_depth = LITTER.DEPTH %>% as.character(),
    comments = COMMENTS %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character()
  ) 

form_options <- tfl_occ %>% 
  dplyr::group_by(form_status_code) %>%
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>%
  ungroup()

# Create taxon area encounter
tfl_tae <- tfl_occ %>%
  has_name_id_and_location %>% 
  dplyr::filter(!is.na(observation_date)) %>%
  # dplyr::filter(form_status_code == "ACCEPTED"| form_status_code == "READY"| form_status_code == "NEW") %>% 
  dplyr::transmute(
    taxon = name_id,
    code = pop_id,
    name = glue::glue("{pop_id}{subpop_code}"),
    description = glue::glue(
        "Source ID: {source_id}\n",
        "Population {pop_id}, Subpopulation {subpop_code}\n",
        "Population classification: {classification_code}\n",
        "Habitat condition: {habitat_condition} {habitat_notes}\n",
        "Location: {location} {distance} KM {direction} from {nearplace}\n",
        "District: {district}\n",
        "Land district: {landdistrict}\n",
        "LGA code: {lga_code}\n",
        "Record source code: {record_src_code}\n",
        "Comments: {other_comments}\n"
        ),
    source = 11,
    source_id = source_id %>% as.character(),
    # https://tsc.dbca.wa.gov.au/admin/occurrence/encountertype/3/change/ = monitoring
    encounter_type = 3, 
    encountered_on = observation_date %>% as.character(),
    encountered_by = 1,
    area_type = 20, # pop:20, subpop: 21
    geolocation_capture_method='gps-point',
    accuracy = 1000,
    point = glue::glue("SRID=4326;POINT({longitude} {latitude})")
  ) %>% 
  base::replace(., is.na(.), "") 

## Some (sub)populations are resighted. (Good examples: 1033, 10796, 10850)
# tfl_tae %>% dplyr::group_by(taxon, name) %>% dplyr::tally() %>% dplyr::filter(n>2) %>% dplyr::arrange(-n) 
```

```{r show_tfl_occ, fig.height=8, fig.width=10}
leaflet(width = 800, height = 600) %>%
  addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
  addProviderTiles("OpenStreetMap.Mapnik", group = "Place names") %>%
  clearBounds() %>%
  addAwesomeMarkers(
    data = tfl_occ,
    lng = ~ longitude, lat = ~ latitude,
    icon = leaflet::makeAwesomeIcon(icon = "leaf"),
    label = ~ paste(species_name),
    popup = ~ glue::glue(
      '
      <h3>{species_name} [{pop_id}{subpop_code}]</h3>
      <span class="glyphicon glyphicon-comment" aria-hidden="true"></span>
      Sheet no {source_id}. New population: {new_pop_ind}. {population_notes}<br/>
      <span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span> Source of record: {record_src_code}<br/>
      
      <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span> {observation_date}<br/>
      <span class="glyphicon glyphicon-globe" aria-hidden="true"></span> {location}<br/>
      Located {distance} km {direction} of {nearplace}.<br/>
      {other_comments}<br/>
      
      <h5>Habitat</h5>
      Landform: {landform}. 
      Rock type: {rock_type}.
      Gravel: {gravel}.
      Soil type: {soil_type}.
      Soil colour: {soil_color}.
      Drainage: {drainage}.
      <br/>
      '
    ),
    group = "Flora",
    clusterOptions = markerClusterOptions()
  ) %>%
  addLayersControl(
    baseGroups = c("Aerial", "Place names"),
    overlayGroups = c("Flora"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

## Conservation Threats and Actions

```{r make_act}
act_fenc <- tfl_occ %>%
  has_name_id_and_location %>% 
  dplyr::transmute(
    source = 11,
    source_id = source_id,
    fencing_action = fencing_status,
    comments = fencing_comments)

act_rdmk <- tfl_occ %>%
  has_name_id_and_location %>% 
  dplyr::transmute(
    source = 11,
    source_id = source_id,
    fencing_action = roadside_marker_status,
    comments = rdside_mkr_comments)

mgmt_act <- tfl_data$DRF_POP_MGMT_ACTIONS %>%
  dplyr::transmute(
    action_id = ACTION.ID %>% as.character(),
    pop_id = POP.ID %>% as.character(),
    mgmt_act_code = MGMT.ACT.CODE %>% as.character(),
    action_notes = ACTION.NOTES %>% as.character(),
    priority_code = PRIORITY.CODE %>% as.character(),
    status = STATUS %>% as.character(),
    action_date = ACTION.DATE %>% as.character(),
    r_plan = R.PLAN %>% as.character(),
    finalised_on = FINALISED.ON %>% as.character(),
    active_on = ACTIVE.IND %>% as.character(),
    deactivated_date = DEACTIVATED.DATE %>% as.character(),
    reason_deactivated = REASON.DEACTIVATED %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character()
  )
```

## Fire Response

```{r make_fire_hist}
fire_sum <- tfl_data$DRF_FIRE_SUMMARIES %>%
  dplyr::transmute(
    fire_id = FIRE.SUM.ID %>% as.integer(),
    summary_level = SUMMARY.LEVEL %>% as.character(),
    publish = PUBLISH %>% as.character(),
    taxon_id = TAXONID %>% as.character(),
    spname = SPNAME %>% as.character(),
    pop_id = POP.ID %>% as.character(),
    sit_id = SIT.ID %>% as.character(),
    quadrat = QUADRAT %>% as.character(),
    summary_date = SUMMARY.DATE %>% as.character(),
    completed_date = COMPLETED.DATE %>% as.character(),
    observer_name = OBSERVER.NAME %>% as.character(),
    adult_survival = ADULT.SURVIVAL.PCT %>% as.character(),
    seedling_survival = SEEDLING.SURVIVAL.PCT %>% as.character(),
    recruitment = RECRUITMENT %>% as.character(),
    fire_response_type = FIRE.RESPONSE.TYPE %>% as.character(),
    juvenile_period_seeder = JUVENILE.PERIOD.SEEDER %>% as.character(),
    juvenile_period_respr = JUVENILE.PERIOD.RESPR %>% as.character(),
    peak_flowering = PEAK.FLOWERING %>% as.character(),
    mature_age = MATURE.AGE %>% as.character(),
    minimum_fire_interval = MINIMUM.FIRE.INTERVAL %>% as.character(), 
    seeder_type = SEEDER.TYPE %>% as.character(),
    germination = GERMINATION %>% as.character(),
    resprouter.type = RESPROUTER.TYPE %>% as.character(),
    senescence = SENESCENCE %>% as.character(),
    longevity = LONGEVITY %>% as.character(),
    data_source = DATA.SOURCE %>% as.character(),
    comments = COMMENTS %>% as.character(),
    created_by = CREATED.BY %>% as.character(),
    created_date = CREATED.DATE %>% as.character(),
    modified_by = MODIFIED.BY %>% as.character(),
    modified_date = MODIFIED.DATE %>% as.character())
```

## Save point
```{r savepoint_tfl}
save(
  act_fenc,
  act_rdmk,
  all_crit_map,
  area_ass,
  ass_species,
  fire_sum,
  hab_comp,
  hab_cond,
  mgmt_act,
  names_pop_vegclass,
  names_pop_threats,
  occ_fire,
  occ_threats,
  occ_vegclass,
  phys_sample,
  plant_count,
  populations,
  pop_forms,
  pop_threats,
  pop_vegclass,
  resolution,
  snapshot_last_updated,
  tfl_cons_listing,
  tfl_data,
  tfl_fire_hist,
  tfl_occ,
  tfl_tae,
  file = tfl_transformed
)
# load(tfl_transformed)
```

# Current conservation lists (TSC)

## Conservation criteria
Conservation criteria Data from TSC is extracted through the TSC API and
transformed into a useable format for manual mapping to TFL.

A manual step annotated legacy conservation criteria exported from TFL to
conservation criteria IDs in TSC in a spreadsheet.

```{r get_tsc_tcl, message = FALSE}
tsc_conslist <- wastdr::wastd_GET("conservationlist") %>% 
  wastdr::wastd_parse() %>% 
  dplyr::select(
    -conservationcategory_set,
    -conservationcriterion_set
  ) %>% 
  dplyr::rename(
    list_id = id,
    list_code = code,
    list_label = label
  )

tsc_conscat <- wastdr::wastd_GET("conservationcategory") %>% 
  wastdr::wastd_parse() %>% 
  dplyr::rename(list_id = conservation_list) %>% 
  dplyr::arrange(list_id, rank) %>% 
  dplyr::left_join(tsc_conslist, by = "list_id")

tsc_conscrit <- wastdr::wastd_GET("conservationcriterion", api_url = prod) %>% 
  wastdr::wastd_parse() %>% 
  dplyr::rename(list_id = conservation_list) %>% 
  dplyr::arrange(list_id, rank) %>% 
  dplyr::left_join(tsc_conslist, by = "list_id")

readr::write_csv(tsc_conscrit, path = here::here("data/tsc_conscrit_flora.csv"))

# Load manual mapping of tfl cons criteria from CSV file,  join to tfl_cons_crit
tfl_conscrit <- here::here("csv/tfl_conscrit_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      list_code_wa = col_character(),
      tsc_criteria = col_character(),
      criteria_code_wa = col_character(),
      assigned_as = col_character(),
      comments = col_character()
    )
  )  %>%
  base::replace(., is.na(.), "") %>% 
  dplyr::mutate(
    tsc_criteria = purrr::map(tsc_criteria, chr2int)
  )

# glimpse(tfl_conscrit)

tfl_tcl <- tfl_cons_listing %>% 
  left_join(tfl_conscrit,by=c("list_code_wa","criteria_code_wa")) %>% 
  # base::replace(., is.na(.), "") %>% 
  invisible()
```

## Observation Groups lookups
Occurrence lookup data from TSC are downloaded from the TSC API 
and transformed into a usable format for manual mapping to TFL.

A manual step annotated lookup values exported from TSC to 
occurrence data in TFL in a spreadsheet.

```{r get_tsc_occ_lookups, message=FALSE}
tsc_landforms <- "lookup-landform" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_landforms.csv"))

tsc_rocktype <- "lookup-rocktype" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_rocktype.csv"))

tsc_soiltype <- "lookup-soiltype" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_soiltype.csv"))

tsc_soilcolour <- "lookup-soilcolour" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_soilcolour.csv"))

tsc_drainage <- "lookup-drainage" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_drainage.csv"))

tsc_soilcondition <- "lookup-soilcondition" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_soilcondition.csv"))

tsc_surveymethod <- "lookup-surveymethod" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_surveymethod.csv"))

tsc_countmethod <- "lookup-countmethod" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_countmethod.csv"))

tsc_countsubject <- "lookup-countsubject" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_countsubject.csv"))

tsc_plantcondition <- "lookup-plantcondition" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_plantcondition.csv"))

tsc_samp_dest <- "lookup-sampledestination" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  readr::write_csv(path = here::here("data", "tsc_samp_dest.csv"))

# Load manual mapping of tfl lookup criteria from CSV file, and join to relevant table

## habitat composition
tfl_landcrit <- here::here("csv/tfl_landcrit_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      landform = col_character(),
      tsc_landforms = col_character(),
      tsc_criteria = col_character()
    ))

tfl_rocktype <- here::here("csv/tfl_rocktype_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      rock_type= col_character(),
      tsc_rock_type = col_character(),
      tsc_criteria = col_character()
    ))

tfl_soiltype <- here::here("csv/tfl_soiltype_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      soil_type = col_character(),
      tsc_soil_type = col_character(),
      tsc_criteria = col_character()
    ))

tfl_soilcolour <- here::here("csv/tfl_soilcolour_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      soil_colour = col_character(),
      tsc_soil_colour = col_character(),
      tsc_criteria = col_character()
    ))

tfl_drainage <- here::here("csv/tfl_drainage_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      drainage = col_character(),
      tsc_drainage = col_character(),
      tsc_criteria = col_character()
    ))

tfl_hab_comp <- hab_comp %>%
  left_join(tfl_landcrit, by = c("landform")) %>%
  left_join(tfl_rocktype, by = c("rock_type")) %>%
  left_join(tfl_soiltype, by = c("soil_type")) %>%
  left_join(tfl_soilcolour, by = c("soil_colour")) %>%
  left_join(tfl_drainage, by = c("drainage")) %>%
  dplyr::transmute(
    source = source,
    source_id = source_id,
    landform = tsc_landforms,
    rock_type = tsc_rock_type,
    soil_type = tsc_soil_type,
    soil_colour = tsc_soil_colour,
    drainage = tsc_drainage
    ) %>%
  dplyr::mutate(obstype = "HabitatComposition") %>% 
  base::replace(., is.na(.), "") %>% 
  dplyr::semi_join(tfl_tae)

## Area assessment
tfl_survey_method <-
  here::here("csv/tfl_survey_method_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      survey_method = col_character(),
      tsc_survey_method = col_character(),
      tsc_criteria = col_character()
    )
  )

tfl_area_ass <- area_ass %>%
  left_join(tfl_survey_method, by = c("survey_method")) %>%
  dplyr::transmute(
    source = source,
    source_id = source_id,
    survey_method = tsc_survey_method,
    area_surveyed_m2 = surveyed_area,
    survey_duration_min = survey_duration) %>%
  dplyr::mutate(obstype = "AreaAssessment") %>% 
  base::replace(., is.na(.), "") %>% 
  dplyr::semi_join(tfl_tae)

## Habitat condition
tfl_soil_condition <-
  here::here("csv/tfl_soil_condition_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      soil_condition = col_character(),
      tsc_soil_condition = col_character(),
      tsc_criteria = col_character()
    )
  )

tfl_hab_cond <- hab_cond %>%
  left_join(tfl_soil_condition, by = c("soil_condition")) %>%
  dplyr::transmute(
    source = source,
    source_id = source_id,
    soil_condition = tsc_soil_condition) %>%
  dplyr::mutate(obstype = "HabitatCondition") %>% 
  base::replace(., is.na(.), "") %>% 
  dplyr::semi_join(tfl_tae) # 'occurrence_condition' cannot 
# be migrated to tsc card options which require a %. This has been added to tae description.

## Plant count
tfl_plant_count_method <-
  here::here("csv/tfl_plant_count_method_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      plant_count_method = col_character(),
      tsc_plant_count_method = col_character(),
      tsc_criteria = col_character()
    )
  )

tfl_plant_count_subject <-
  here::here("csv/tfl_counted_subject_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      counted_subject = col_character(),
      tsc_counted_subject = col_character(),
      tsc_criteria = col_character()
    )
  )

tfl_plant_condition <-
  here::here("csv/tfl_plant_condition_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      plant_condition = col_character(),
      tsc_Plant_condition = col_character(),
      tsc_criteria = col_character()
    )
  )

tfl_plant_count <- plant_count %>%
  left_join(tfl_plant_count_method, by = c("plant_count_method")) %>%
  left_join(tfl_plant_count_subject, by = c("counted_subject")) %>%
  left_join(tfl_plant_condition, by = c("plant_condition")) %>%
  dplyr::transmute(
    source = source,
    source_id = source_id,
    count_methods = tsc_plant_count_method,
    count_subjects = tsc_counted_subject,
    plant_conditions = tsc_Plant_condition,
    land_manager_present = land_manager_present,
    no_alive_mature = number_alive_mature,
    no_alive_juvenile = number_alive_juvenile,
    no_alive_seedlings = number_alive_seedlings,
    no_dead_mature = number_dead_mature,
    no_dead_juvenile = number_dead_juvenile,
    no_dead_seedlings = number_dead_seedlings,
    no_alive_simple = number_alive,
    no_dead_simple = number_dead,
    quadrats_details_attached = FALSE,
    quadrats_present = number_of_quadrats_surveyed,
    no_quadrats_surveyed = number_of_quadrats_surveyed,
    quadrat_area_individual_m2 = individual_quadrat_area,
    quadrat_area_total_m2 = total_quadrat_area,
    population_area_estimated_m2 = estimates_population_area,
    clonal_present = clonal_reproduction_present,
    vegetative_present = vegetative_state_present,
    flowerbuds_present = flower_buds_present,
    flowers_present = flowers_present,
    flowering_plants_percent = flowering_plants %>% as.integer(),
    immature_fruit_present = immature_fruit_present,
    ripe_fruit_present = ripe_fruit_present,
    dehisced_fruit_present = dehisced_fruit_present,
    comments = comments,
    ) %>%
  dplyr::mutate(obstype = "PlantCount") %>% 
  # base::replace(., is.na(.), "") %>%
  dplyr::mutate_at(vars("quadrats_present"), funs(. > 0)) %>% 
  dplyr::mutate_each(funs(replace(., is.na(.), F)), quadrats_present) %>% 
  dplyr::semi_join(tfl_tae)
  
## Filter non integer data from columns so I can correct it before migration
plant_count_quadrat_crap <- tfl_plant_count %>% 
  dplyr::filter(stringr::str_detect(quadrat_area_individual_m2,paste(c("x","m","p"),collapse = '|'))) %>% 
  readr::write_csv(path = here::here("data", "tfl_plant_count_dirty.csv"))

## Replace non-integer values with NA for migration
tfl_plant_count <- tfl_plant_count %>% 
  dplyr::mutate(quadrat_area_individual_m2 =  quadrat_area_individual_m2 %>% as.integer(as.character())) %>% 
  dplyr::mutate(population_area_estimated_m2 =  population_area_estimated_m2 %>% as.integer(as.character()))

## Physical sample
tfl_sampdest <-
  here::here("csv/tfl_sample_destination_w_tsc.csv") %>%
  readr::read_csv(
    col_types = cols(
      sample_destination = col_character(),
      tsc_sample_destination = col_character(),
      tsc_criteria = col_character()
    )
  )

tfl_phys_sample <- phys_sample %>%
  left_join(tfl_sampdest, by = c("sample_destination")) %>%
  dplyr::transmute(
    source = source,
    source_id = source_id,
    sample_type = sample_type,
    sample_destination = tsc_sample_destination,
    sample_label = sample_label,
    permit_id = permit_id) %>%
  dplyr::mutate(obstype = "PhysicalSample") %>% 
  base::replace(., is.na(.), "") %>% 
  dplyr::semi_join(tfl_tae)

```

Habitat Condition: 'occurrence_condition' could not be migrated
to the Habitat Condition card in TSC because it requires a %. 
Instead, 'occurrence_condition' has been added to the TAE description.

# Migrate legacy data (TFL to TSC)
In this section, the extracted and transformed data from TFL are loaded into TSC
using the TSC API. The code is collapsed; expand the code blocks to view the
process.

## Taxonomy
The QA part of this workbook will compare TFL names to TSC names.

## Conservation listings

```{r make_tfl_tcl, message=FALSE}
tsc_conscat_sp <- "conservationcategory" %>%
  wastdr::wastd_GET(api_url = prod) %>%
  wastdr::wastd_parse() %>%
  dplyr::rename(
    tsc_category_id = id,
    category_code = code,
    tsc_label = label
  ) %>%
  dplyr::filter(conservation_list %in% c(1:7))

# List codes: "Priority"
# https://tsc.dbca.wa.gov.au/admin/conservation/conservationlist/6/
tfl_listing_cat_priority <- tfl_tcl %>%
  dplyr::filter(list_code == "Priority") %>%
  dplyr::mutate(category_code = glue::glue("P{category_code}") %>% as.character) %>%
  dplyr::left_join(dplyr::filter(tsc_conscat_sp, conservation_list == 6),
                   by = "category_code") %>%
  dplyr::transmute(
    source = 2,
    # TaxonGaz.source tfl 1, TFL 2, TEC 3
    source_id = source_id %>% as.character(),
    scope = 0,
    # state 0, cwth 1, intl 2, ap 3
    status = ifelse(is.na(date_delisted), 80, 90),
    effective_from = date_listed,
    effective_to = date_delisted,
    review_due = recovery_plan_expiry_date,
    # check
    last_reviewed_on = NA,
    comments = glue::glue("Occurences last reviewed on: {file_last_updated}."),
    
    taxon = name_id %>% as.character(),
    category = tsc_category_id %>% as.list(),
    criteria = tsc_criteria
  ) %>%
  dplyr::filter(!is.na(category))

# Active Priority listings:
tfl_no_active_listings <-
  tfl_listing_cat_priority %>% dplyr::filter(status == 80) %>% nrow

# Inactive Priority listings:
tfl_no_inactive_listings <-
  tfl_listing_cat_priority %>% dplyr::filter(status == 90) %>% nrow

# tfl_cl_priority[3888,] 
# taxonid 315936 does not exist, 31593 does - typo confirmed

# List codes: "EPBC" 
# https://tsc.dbca.wa.gov.au/admin/conservation/conservationlist/7/
tfl_listing_cat_epbc <- tfl_tcl %>%
  dplyr::filter(list_code == "EPBC") %>%
  dplyr::left_join(dplyr::filter(tsc_conscat_sp, conservation_list == 7),
                   by = "category_code") %>%
  dplyr::transmute(
    source = 2,
    # TaxonGaz.source tfl 1, TFL 2, TEC 3
    source_id = source_id %>% as.character(),
    scope = 1,
    # state 0, cwth 1, intl 2, ap 3
    status = ifelse(is.na(date_delisted), 80, 90),
    effective_from = date_listed,
    effective_to = date_delisted,
    review_due = recovery_plan_expiry_date,
    # check
    last_reviewed_on = NA,
    comments = glue::glue("Occurences last reviewed on: {file_last_updated}."),
    taxon = name_id %>% as.character(),
    category = tsc_category_id %>% as.list(),
    criteria = tsc_criteria
  ) %>%
  dplyr::filter(!is.na(category))

# List codes: "WCA_1991" = IUCN 1994/2001/2012
# IUCN 1994 
# https://tsc.dbca.wa.gov.au/admin/conservation/conservationlist/5/change/
tfl_listing_cat_iucn1994 <- tfl_tcl %>%
  dplyr::filter(list_code_wa == "IUCN_1994") %>%
  dplyr::mutate(category_code = category_code_wa) %>%
  dplyr::left_join(dplyr::filter(tsc_conscat_sp, conservation_list == 5),
                   by = "category_code") %>%
  dplyr::transmute(
    source = 2,
    # TaxonGaz.source tfl 1, TFL 2, TEC 3
    source_id = source_id %>% as.character(),
    scope = 0,
    # state 0, cwth 1, intl 2, ap 3
    status = ifelse(is.na(date_delisted), 80, 90),
    effective_from = date_listed,
    effective_to = date_delisted,
    review_due = recovery_plan_expiry_date,
    # check
    last_reviewed_on = NA,
    comments = glue::glue("Occurences last reviewed on: {file_last_updated}."),
    taxon = name_id %>% as.character(),
    category = tsc_category_id %>% as.list(),
    criteria = tsc_criteria
  ) %>%
  dplyr::filter(!is.na(category))

# IUCN 2001
# https://tsc.dbca.wa.gov.au/admin/conservation/conservationlist/4/change/
tfl_listing_cat_iucn2001 <- tfl_tcl %>%
  dplyr::filter(list_code_wa == "IUCN_2001") %>%
  dplyr::mutate(category_code = category_code_wa) %>%
  dplyr::left_join(dplyr::filter(tsc_conscat_sp, conservation_list == 4),
                   by = "category_code") %>%
  dplyr::transmute(
    source = 2,
    # TaxonGaz.source tfl 1, TFL 2, TEC 3
    source_id = source_id %>% as.character(),
    scope = 0,
    # state 0, cwth 1, intl 2, ap 3
    status = ifelse(is.na(date_delisted), 80, 90),
    effective_from = date_listed,
    effective_to = date_delisted,
    review_due = recovery_plan_expiry_date,
    # check
    last_reviewed_on = NA,
    comments = glue::glue("Occurences last reviewed on: {file_last_updated}."),
    taxon = name_id %>% as.character(),
    category = tsc_category_id %>% as.list(),
    criteria = tsc_criteria
  ) %>%
  dplyr::filter(!is.na(category))

# IUCN 2012
# https://tsc.dbca.wa.gov.au/admin/conservation/conservationlist/3/change/
tfl_listing_cat_iucn2012 <- tfl_tcl %>%
  dplyr::filter(list_code_wa == "IUCN_2012") %>%
  dplyr::mutate(category_code = category_code_wa) %>%
  dplyr::left_join(dplyr::filter(tsc_conscat_sp, conservation_list == 3),
                   by = "category_code") %>%
  dplyr::transmute(
    source = 2,
    # TaxonGaz.source tfl 1, TFL 2, TEC 3
    source_id = source_id %>% as.character(),
    scope = 0,
    # state 0, cwth 1, intl 2, ap 3
    status = ifelse(is.na(date_delisted), 80, 90),
    effective_from = date_listed,
    effective_to = date_delisted,
    review_due = recovery_plan_expiry_date,
    # check
    last_reviewed_on = NA,
    comments = glue::glue("Occurences last reviewed on: {file_last_updated}."),
    taxon = name_id %>% as.character(),
    category = tsc_category_id %>% as.list(),
    criteria = tsc_criteria
  ) %>%
  dplyr::filter(!is.na(category))
```

```{r load_tfl_tcl, eval=FALSE}
# Example: one record
# tfl_listing_cat_priority_res <- tfl_listing_cat_priority[1,] %>%
#   wastdr::wastd_POST("taxon-conservationlisting")
# tfl_listing_cat_epbc_res <- tfl_listing_cat_epbc[1,] %>% 
#   wastdr::wastd_POST("taxon-conservationlisting")
# tfl_listing_cat_iucn1994_res <-  tfl_listing_cat_iucn1994[1,] %>% 
#   wastdr::wastd_POST("taxon-conservationlisting")
# tfl_listing_cat_iucn2001_res <- tfl_listing_cat_iucn2001[1,] %>% 
  # wastdr::wastd_POST("taxon-conservationlisting")

# LONG RUNNING UPLOAD
tfl_listing_cat_priority_res <- tfl_listing_cat_priority %>% 
  wastdr::wastd_POST("taxon-conservationlisting")
tfl_listing_cat_epbc_res <- tfl_listing_cat_epbc %>% 
  wastdr::wastd_POST("taxon-conservationlisting")
tfl_listing_cat_iucn1994_res <-  tfl_listing_cat_iucn1994 %>% 
  wastdr::wastd_POST("taxon-conservationlisting")
tfl_listing_cat_iucn2001_res <- tfl_listing_cat_iucn2001 %>% 
  wastdr::wastd_POST("taxon-conservationlisting")

# There are none, skip upload:
# tfl_cl_iucn2012 %>% wastdr::wastd_POST("taxon-conservationlisting")

# Expire cached TSC TCL
if (file.exists(tsc_cl_flora_datafile)) {fs::file_delete(tsc_cl_flora_datafile)}
```

## Occurrences
The EOO (Extent of occurrence) is calculated as the convex hull around all
recorded flora occurrences, including fossil records. 
For further details on the methodology behind the movement of EOO data, 
please follow the link to the workbook.

### TSC upload example for EOOs

```{r load_one_taxon_eoo, eval=FALSE}
one_taxon_eoo <- tibble::tibble(
  name_id = 24162,
  eoo = eoo_polygon(tfl_occ, nid = 17914) %>% sfc_geojson()
)
one_taxon_eoo %>% wastdr::wastd_POST("taxon")
```

### Upload EOOs to TSC

```{r make_eoo, eval=FALSE}
# extract all eoo
tfl_occ_with_coords <- tfl_occ %>% 
  dplyr::filter(!is.na(latitude)) %>% 
  dplyr::filter(!is.na(longitude))

# The total convex hull of all occurrences (one polygon)
tfl_eoo_all <- eoo_polygon(tfl_occ_with_coords)
mapview::mapview(tfl_eoo_all)

# Calculate EOO for each taxon
tfl_eoo <- tfl_occ_with_coords %>% make_eoo()
# mapview::mapview(head(tfl_eoo$eoo_sfc))
```

```{r load_eoo, eval=FALSE}
tfl_eoo %>% dplyr::select(-data, -eoo_sfc) %>% wastdr::wastd_POST("taxon")
```

### Upload TAEs to TSC
A single record (taxon area encounter), or a list of (one or) many records, 
can be uploaded to the TSC API as follows.

```{r load_tfl_tae, eval=FALSE}
# Test upload one, some, many to local or PROD:
x <- tfl_tae[1,] %>% as.list() %>% 
  # Or use any of:
  # tfl_tae[1:100,] %>% 
  # tfl_tae[1:1000,] %>% 
  wastd_POST(serializer = "occ-taxon-points")

# Upload all occurrences to TSC PROD
# LONG RUNNING UPLOAD
tfl_tae %>% chunk_post(serializer = "occ-taxon-points")
```

### Upload ObservationGroups
  
```{r load_obsgroups, eval=FALSE}
# Example: one record
# tfl_phys_sample_res <- tfl_phys_sample[1,] %>%
#   wastd_occ_obs_post(obstype="PhysicalSample")
# tfl_hab_cond_res <- tfl_hab_cond[1,]%>%
#   wastd_occ_obs_post(obstype="HabitatCondition")
# tfl_area_ass_res <- tfl_area_ass[1,] %>%
#   wastd_occ_obs_post(obstype="AreaAssessment")
# tfl_plant_count_res <- tfl_plant_count[30000:38624,] %>%
#   wastd_occ_obs_post(obstype="PlantCount")
# tfl_hab_comp_res <- tfl_hab_comp[1,] %>%
#   wastd_occ_obs_post(obstype="HabitatComposition")

# Bulk upload
# LONG RUNNING UPLOAD
tfl_phys_sample_res <- tfl_phys_sample %>%
  wastd_occ_obs_post(obstype="PhysicalSample", chunksize = 1000) #23632
tfl_hab_cond_res <- tfl_hab_cond %>%
  wastd_occ_obs_post(obstype="HabitatCondition", chunksize = 1000) #22181
tfl_area_ass_res <- tfl_area_ass %>%
  wastd_occ_obs_post(obstype="AreaAssessment") #9899
tfl_plant_count_res <- tfl_plant_count %>%
  wastd_occ_obs_post(obstype="PlantCount", chunksize = 1000) #38624
tfl_hab_comp_res <- tfl_hab_comp %>%
  wastd_occ_obs_post(obstype="HabitatComposition", chunksize = 1000) #40996

# setdiff(tfl_hab_comp$source_id,tfl_tae$source_id) - All ObservationGroups checked.

# Export as (confidential) test data for API
tfl_hab_cond %>% readr::write_csv(path = here::here("data/tfl_hab_cond.csv"))
tfl_area_ass %>% readr::write_csv(path = here::here("data/tfl_area_ass.csv"))
tfl_plant_count %>% readr::write_csv(path = here::here("data/tfl_plant_count.csv"))
```

## Conservation Documents

## Fire Response
<!-- Note: high prio to ingest this data as new (to be built) occ obs card. -->

## Conservation Threats and Actions

# Migrated Data (TSC)

Data from TSC is extracted through the TSC API and transformed into a usable
format. This process is also the template for future reporting from TSC.

First, we get a list of taxonomic names from TSC to resolve taxon IDs from
taxon occurrences to names.

Next, we extract conservation listings.

Last, we get taxon occurrences with their point representations from TSC through 
the API endpoint 
[occ-taxon-points](https://tsc.dbca.wa.gov.au/api/1/occ-taxon-points/).

Currently, all Flora occurrences are geo-referenced only with point
coordinates, not polygons.

We also get TSC Areas and split them into DBCA Regions and Districts. Caveat:
Regions and Districts to not comprehensively cover WA, and they are multi-polygons.
We do not join these multi-polygons to the data to prevent duplicates.

Expand the code block below to view the process.

```{r get_tsc_data}
if (file.exists(tsc_extracted_flora)) {
  load(tsc_extracted_flora)
} else {
  
  # Flora taxa
  tsc_taxa_flora <- "taxon" %>%
    wastdr::wastd_GET(query = list(paraphyletic_groups = 21)) %>%
    wastdr::wastd_parse() %>%
    dplyr::mutate(taxon = name_id %>% as.character())
  
  # Flora conservation listings
  tsc_tcl_flora <- "taxon-conservationlisting" %>% 
    wastdr::wastd_GET() %>%
    wastdr::wastd_parse() %>%
    dplyr::mutate(taxon = taxon %>% as.character()) %>%
    dplyr::inner_join(tsc_taxa_flora, by = "taxon")

  # Flora occurrences
  tsc_tae <- "occ-taxon-points" %>% 
    wastdr::wastd_GET(query = list(source=11)) %>%
    wastdr::wastd_parse() %>%
    dplyr::mutate(taxon = taxon %>% as.character())
  
  tsc_areas <- wastdr::wastd_GET("area") %>%
    magrittr::extract2("data") %>%
    geojsonio::as.json() %>%
    geojsonsf::geojson_sf()
  
  regions <- tsc_areas %>%
  dplyr::filter(area_type == "Region") %>%
  dplyr::transmute(region_id = pk, region_name = name)

  districts <- tsc_areas %>%
    dplyr::filter(area_type == "District") %>%
    dplyr::transmute(district_id = pk, district_name = name)
  
  # Flora occurrence observations
  tsc_tae_observations <- "occ-observation" %>% 
    wastdr::wastd_GET() %>%
    wastdr::wastd_parse()
  
  tsc_tae_observations_flora <- tsc_tae_observations %>% 
    tidyr::unnest_wider(encounter,names_repair = "universal")
  
  tsc_tae_observations_flora_2 <- tsc_tae_observations_flora %>% 
    tidyr::unnest_wider(properties,names_repair = "universal")
  
  tsc_flora_observations <- tsc_tae_observations_flora_2 %>% 
    filter(source == 11)
  
save(
    tsc_taxa_flora,
    tsc_tcl_flora,
    tsc_tae,
    tsc_areas,
    regions,
    districts,
    tsc_flora_observations,
    file = tsc_extracted_flora)
}
```


```{r tsc_screen_for_duplicates, eval=FALSE}
# All sources in tsc_tae: 11 == Flora
unique(tsc_tae$source) == 11

# There are no fauna records in tsc_tae
tsc_tae %>% dplyr::filter(source == 10) %>% nrow

# There are only flora records in tsc_tae
tsc_tae %>% dplyr::filter(source == 11) %>% nrow

# There are as many unique source_ids (TPFL sheet numbers) as occurrence records
length(unique(tsc_tae$source_id)) # == nrow(tsc_tae)

# There are no source_ids that occur more than once
tsc_tae_tally <- tsc_tae %>% 
  group_by(source, source_id) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(n>1) %>% 
  dplyr::arrange(-n)
View(tsc_tae_tally)

# If loaded occurences in TSC were to mismatch original occurrences from TPFL:
tfl_tae_create <- tfl_tae %>% dplyr::anti_join(tsc_tae, by = "source_id")
tfl_tae_update <- tfl_tae %>% dplyr::semi_join(tsc_tae, by = "source_id")

## Upload the missing tfa_tae to tsc_tae
# tfl_tae_create %>% chunk_post(serializer = "occ-taxon-points")
```

# Compare legacy from TFL to migrated data from TSC

This section provides an automated comparison between original data from TFL,
and TFL data as uploaded into TSC.

Data custodians should be able to comprehend this section, and be able to verify
that the data migration has worked correctly.

Legacy data snapshot used for TFL was updated last on `r snapshot_last_updated`.

## Summary statistics

Check unique number of species by `name_id`. Check unique number of observations
and identify observations missing from TSC compared to TFL.

```{r make_tfl_summary}
tfl_tcl_unique_taxa <- tfl_tcl$name_id %>%
  unique() %>%
  length()

tsc_tcl_unique_taxa <- tsc_tcl_flora$name_id %>%
  unique() %>%
  length()
```

## Taxonomy

Flora use a live copy of WACensus names, therefore we don't need to QA taxonomy.

## Conservation Listing

TFL has `r nrow(tfl_tcl)` conservation listings of `r tfl_tcl_unique_taxa` unique taxa. 
TSC has `r nrow(tsc_tcl_flora)` flora conservation listings of `r tsc_tcl_unique_taxa` unique taxa.

### `tfl_tcl` conservation listings not in `tsc_tcl_flora`

Any records in the following table indicate conservation listings in TFL that
were not migrated into TSC.

```{r show_tfl_tcl_not_in_tsc}
tfl_tcl %>% dplyr::anti_join(tsc_tcl_flora, by = "source_id") %>% rt
```

### `tsc_tcl_flora` conservation listings not in `tfl_tcl`

The following table shows any conservation listings in TSC which are not in TFL.
Because there are more taxa in TSC than TFL, taxa with no `source_id` have also
been removed.

```{r show_tsc_tcl_not_in_tfl}
tsc_tcl_flora %>%
  dplyr::anti_join(tfl_tcl, by = "source_id") %>%
  dplyr::filter(source_id != "") %>% 
  rt
```

### `tfl_tcl` listed phrase names

Some TFL cons listings have a `name_id` of 0. These are phrase names and require
to be assigned the `name_id` of the published name, once the published name is
known and entered into WACensus, then propagated into TSC.

```{r show_tfl_tcl_without_nameid}
tfl_tcl %>% dplyr::filter(name_id == 0) %>% rt
```

### Conservation criteria mapping

Conservation criteria were manually mapped for each species, therefore they need
to be checked to confirm whether the mapping is correct.

```{r show_cl_mapping}
tfl_conscrit %>% rt
```

Some conservation criteria could not be mapped as they do not exist
in the `list_code` / `category_code`. 

These need to be corrected before the manual mapping can be updated and the 
correct criteria assigned for all species.

### Conservation listing dates

Below are the dates of the most recent conservation criteria changes made in the
snapshot of the TFL.

```{r qa_effective_dates}
tsc_corner_dates <- tsc_tcl_flora %>%
  summarise(
    effective_from_min = min(effective_from, na.rm = T),
    effective_from_max = max(effective_from, na.rm = T),
    effective_to_min = min(effective_to, na.rm = T),
    effective_to_max = max(effective_to, na.rm = T),
    last_reviewed_on_min = min(last_reviewed_on, na.rm = T),
    last_reviewed_on_max = max(last_reviewed_on, na.rm = T)
  )

tfl_corner_dates <- tfl_tcl %>%
  summarise(
    effective_from_min = min(date_listed, na.rm = T),
    effective_from_max = max(date_listed, na.rm = T),
    effective_to_min = min(date_delisted, na.rm = T),
    effective_to_max = max(date_delisted, na.rm = T),
    last_reviewed_on_min = min(file_last_updated, na.rm = T),
    last_reviewed_on_max = max(file_last_updated, na.rm = T)
  )

cl_corner_dates <- rbind(tfl_corner_dates, tsc_corner_dates) %>%
  t() %>%
  magrittr::set_colnames(c("TFL", "TSC"))

cl_corner_dates %>% rt
```

### Conservation listing differences

Summary of the number of conservation listings for each list.

Discrepancies in numbers indicate the need for a closer review of `category_code`
and `criteria_code` in TFL.

Equality of numbers does not prove absence of equal numbers of false positives
and false negatives.

```{r make_conslist_summary}
make_tfl_cl_summary <-
  . %>% nrow() %>% as.data.frame() %>% magrittr::set_colnames("TFL")

tfl_cl_sum_priority <-
  tfl_listing_cat_priority %>% make_tfl_cl_summary
tfl_cl_sum_iucn1994 <-
  tfl_listing_cat_iucn1994 %>% make_tfl_cl_summary
tfl_cl_sum_iucn2001 <-
  tfl_listing_cat_iucn2001 %>% make_tfl_cl_summary
tfl_cl_sum_iucn2012 <-
  tfl_listing_cat_iucn2012 %>% make_tfl_cl_summary
tfl_cl_sum_epbc <- tfl_listing_cat_epbc %>% make_tfl_cl_summary

make_tsc_cl_summary <- function(data, cn) {
  data %>%
    dplyr::select(category_cache) %>%
    dplyr::filter(str_detect(category_cache, cn)) %>%
    nrow() %>%
    as.data.frame %>%
    magrittr::set_colnames("TSC")
}

tsc_cl_sum_priority <-
  tsc_tcl_flora %>% make_tsc_cl_summary("Priority")
tsc_cl_sum_iucn1994 <-
  tsc_tcl_flora %>% make_tsc_cl_summary("IUCN1994")
tsc_cl_sum_iucn2001 <-
  tsc_tcl_flora %>% make_tsc_cl_summary("IUCN2001")
tsc_cl_sum_iucn2012 <-
  tsc_tcl_flora %>% make_tsc_cl_summary("IUCN2012")
tsc_cl_sum_epbc <- tsc_tcl_flora %>% make_tsc_cl_summary("EPBC")


tfl_cons_cat_sum <- rbind(
  tfl_cl_sum_priority,
  tfl_cl_sum_iucn1994,
  tfl_cl_sum_iucn2001,
  tfl_cl_sum_iucn2012,
  tfl_cl_sum_epbc
)

tsc_cons_cat_sum <- rbind(
  tsc_cl_sum_priority,
  tsc_cl_sum_iucn1994,
  tsc_cl_sum_iucn2001,
  tsc_cl_sum_iucn2012,
  tsc_cl_sum_epbc
)

cons_cat_summary <- tfl_cons_cat_sum %>%
  cbind(tsc_cons_cat_sum) %>%
  cbind(Category = c("Priority", "IUCN1994", "IUCN2001", "IUCN2012", "EPBC")) %>%
  dplyr::select("Category", everything())

cons_cat_summary %>% rt
```

The following tables show any conservation listings in TFL which are not in TSC,
for each conservation list.

IUCN 2012

```{r show_tfl_tcl_not_in_tsc_iucn2012}
tsc_listing_cat_iucn2012 <- tsc_tcl_flora %>%
  dplyr::filter(stringr::str_detect(category_cache, "IUCN(2012)"))

tfl_listing_cat_iucn2012 %>%
  dplyr::anti_join(tsc_listing_cat_iucn2012, by = "source_id") %>%
  rt
```

IUCN 2001

```{r show_tfl_tcl_not_in_tsc_iucn2001}
tsc_listing_cat_iucn2001 <- tsc_tcl_flora %>%
  dplyr::filter(stringr::str_detect(category_cache, "IUCN(2001)"))

tfl_listing_cat_iucn2001 %>%
  dplyr::anti_join(tsc_listing_cat_iucn2001, by = c("source_id")) %>% 
  rt
```

IUCN 1994

```{r show_tfl_tcl_not_in_tsc_iucn1994}
tsc_listing_cat_iucn1994 <- tsc_tcl_flora %>%
  dplyr::filter(stringr::str_detect(category_cache, "IUCN(1994)"))

tfl_listing_cat_iucn1994 %>%
  dplyr::anti_join(tsc_listing_cat_iucn1994, by = "source_id") %>% 
  rt
```

Priority

```{r show_tfl_tcl_not_in_tsc_prio}
tsc_listing_cat_priority <- tsc_tcl_flora %>%
  dplyr::filter(stringr::str_detect(category_cache, "Priority"))

tfl_listing_cat_priority %>%
  dplyr::anti_join(tsc_listing_cat_priority, by = "source_id") %>%  
  rt
```

EPBC

```{r show_tfl_tcl_not_in_tsc_epbc}
tsc_listing_cat_epbc <- tsc_tcl_flora %>%
  dplyr::filter(stringr::str_detect(category_cache, "EPBC"))

tfl_listing_cat_epbc %>%
  dplyr::anti_join(tsc_listing_cat_epbc, by = "source_id") %>% 
  rt
```

The following tables show any conservation listings in TSC which are not in TFL,
for each conservation list.

IUCN 2012

```{r show_tsc_tcl_not_in_tfl_iucn2012}
tsc_listing_cat_iucn2012 %>% 
  dplyr::anti_join(tsc_listing_cat_iucn2012, by = "source_id") %>% 
  rt
```

IUCN 2001

```{r show_tsc_tcl_not_in_tfl_iucn2001}
tsc_listing_cat_iucn2001 %>% 
  dplyr::anti_join(dplyr::select(tfl_listing_cat_iucn2001, -"category"), by = "source_id")
```

IUCN 1994

```{r show_tsc_tcl_not_in_tfl_iucn1994}
tsc_listing_cat_iucn1994 %>% 
  dplyr::select(-"category", -"criteria") %>% 
  dplyr::anti_join(dplyr::select(tfl_listing_cat_iucn1994, -"category", -"criteria"), by = "source_id") %>% 
  rt
```

IUCN Priority

```{r show_tsc_tcl_not_in_tfl_prio}
tsc_listing_cat_priority %>% 
  dplyr::select(-"category", -"criteria") %>% 
  dplyr::anti_join(tfl_listing_cat_priority, by = "source_id") %>% 
  rt
```

EPBC

```{r  show_tsc_tcl_not_in_tfl_epbc}
tsc_listing_cat_epbc %>%
  dplyr::select(-"category", -"criteria") %>% 
  dplyr::anti_join(tfl_listing_cat_epbc, by = "source_id") %>% 
  rt
```

## Occurrences

#### Date/ Location caveats

This section lists data issues which need to be fixed at the source (here, in
legacy TFL).

Where a time is missing, we'll default to midnight (00:00). Where a date is
missing, we'll default to 1900-01-01.

While this modifies the original data, the consequences will not have a dramatic
effect on analyses for conservation management purposes:

-   A safe default of the observation time (midnight) could introduce an error
    of up to one day. Compared to the time frame considered (past 10-50 years of
    observations relative to time of calculation), this error is minuscule.
-   A safe default for missing dates (1900-01-01) will both exclude those
    observations from any recent observations (past 10-50 years), but still make
    the data available to identify the records for the purpose of backfilling a
    credible date.

Please review legacy data until the following numbers are all zero (or accept
default handling):

-   `r tfl_occ %>% dplyr::filter(is.na(observation_date)) %>% nrow()` records lack an
    explicit date\time and were defaulted to midnight AWST.
-   `r tfl_occ %>% dplyr::filter(is.na(latitude)) %>% nrow` latitudes are
    missing.
-   `r tfl_occ %>% dplyr::filter(is.na(longitude)) %>% nrow` longitudes are
    missing.
-   `r tfl_occ %>% dplyr::filter(latitude > 0) %>% nrow` latitudes lack the
    minus sign and turn up in China.

There are `r nrow(tfl_occ)` species occurrence records (encounters) in TFL. The
following columns are incomplete.

```{r show_tfl_occ_missing_values}
tfl_skim <- tfl_occ %>% skimr::skim()

tfl_skim %>%
  filter(n_missing > 0) %>%
  # select(-stat, -level, -formatted) %>%
  rt
```

#### Default/ missing date/time

```{r show_tfl_occ_missing_datetime}
tfl_occ_no_obsdate<- tfl_occ %>% 
  dplyr::filter(is.na(observation_date))

tfl_occ_no_obsdate %>% rt

readr::write_csv(tfl_occ_no_obsdate, path = here::here("data/flora_occ_no_obsdate.csv"))

# tfl_tae_no_obs_date <- tfl_occ %>%
#   dplyr::filter(observation_date == "") 
#   TODO
```

#### Missing coordinates

```{r show_tfl_occ_missing_coordinates}
tfl_occ_no_latlng <- tfl_occ %>%
  dplyr::filter(is.na(latitude) | is.na(longitude))
tfl_occ_no_latlng %>% rt

readr::write_csv(tfl_occ_no_latlng, path = here::here("data/flora_occ_no_latlng.csv"))
```

There are `r nrow(tfl_occ_no_latlng)` distinct flora records with missing
latitude or longitude.

```{r show_tfl_occ_has_eastnorthings}
tfl_occ_no_latlng_w_ne <- tfl_occ %>%
  dplyr::filter(is.na(latitude) | is.na(longitude)) %>%
  dplyr::filter((northing != "NA") | (easting != "NA"))
tfl_occ_no_latlng_w_ne %>% rt
```

There are `r nrow(tfl_occ_no_latlng_w_ne)` distinct flora records with missing
latitude or longitude, which have northings and eastings.

#### Datum

```{r show_tfl_occ_datum_tally}
datum_tally <- tfl_occ %>%
  dplyr::group_by(datum) %>%
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>%
  ungroup()
datum_tally %>% rt
```

There are `r nrow(datum_tally)` different datums used across all distinct flora
records.

```{r show_tfl_occ_datum_blank}
datum_blank <- tfl_occ %>% filter(datum == "")
```

There are `r nrow(datum_blank)` distinct flora records with missing datum.

TODO Which datum do we want to use? WGS84 and GDA94 are designed to be \<1 m
different. GDA94 is designed to be comparable with WGS84 GPS data. As GDA94 is
the most frequently used datum in the dataset, should we convert all others to
GDA94?

#### Form status codes

Below is a summary of the form status codes found in TPFL. At present all records
have been migrated regardless of status. 

```{r show_form_status_codes}
form_options <- tfl_occ %>% 
  dplyr::group_by(form_status_code) %>%
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>%
  ungroup()
form_options %>% rt
```

#### Taxonomic caveats

Flora use a live copy of WACensus names, therefore we don't need to QA taxonomy,
but we do need to QA occurrences with missing `name_id` / `pop_id`.

#### Missing NameID

```{r show_tfl_occ_missing_name_id}
tfl_occ_no_nameid <- tfl_occ %>%
  filter(name_id == 0) %>%
  select(species_name) %>%
  unique()
tfl_occ_no_nameid %>% rt
```

#### Missing PopID

```{r show_tfl_occ_missing_pop_id}
tfl_occ_no_popid <- tfl_occ %>%
  filter(pop_id == 0) %>%
  select(species_name) %>%
  unique()
tfl_occ_no_popid %>% rt
```

There are `r nrow(tfl_occ_no_nameid)` distinct scientific flora names without
NameID, and `r nrow(tfl_occ_no_popid)` distinct scientific flora names without a
PopID. Any records listed here need to be fixed in the original Threatened Flora
database.

### Occurrence observation mapping

Occurrence criteria were manually mapped for each variable.

Some conservation criteria could not be mapped as they do not exist in the
`list_code` / `category_code`.

Soil type: Three of these criteria (FSA_LOAM, LSA_LOAM, LMD_CLAY) could not be mapped because we don't know
what they are.

Habitat condition: 'Occurrence_condition' could not be mapped because the tsc card 
options which require a %. Instead, occurrence condition has been added to tfl_tae
description.

Sample destination: Was manually mapped to a generic field for its location and
the specific location added to the sample label field as free text. We have done
this because, combined with fauna, there are \> 100 unique locations for sample
destination, which would make a very long drop down menu.

The manual mapping needs to be spot checked and approved before the manual mapping
can be considered complete.

```{r show_tfl_lookup_mappings}
tfl_landcrit %>% rt
tfl_rocktype %>%  rt
tfl_soiltype %>% rt
tfl_soilcolour %>% rt
tfl_drainage %>% rt
tfl_soil_condition %>% rt
tfl_survey_method %>% rt
tfl_plant_count_method %>% rt
tfl_plant_count_subject %>% rt
tfl_plant_condition %>% rt
tfl_sampdest %>% rt 
```

### Occurrence observations with no matching TAE

Below are occurrence observations which do not have a corresponding TAE for 
them to be assigned to. 

```{r}
missing_tae_phys_sample <- tfl_phys_sample %>% 
  dplyr::anti_join(tfl_tae, by = "source_id")
missing_tae_plant_count <- tfl_plant_count %>% 
  dplyr::anti_join(tfl_tae, by = "source_id")
missing_tae_hab_cond <- tfl_hab_cond %>% 
  dplyr::anti_join(tfl_tae, by = "source_id")
missing_tae_area_ass <- tfl_area_ass %>% 
  dplyr::anti_join(tfl_tae, by = "source_id")
missing_tae_hab_comp <- tfl_hab_comp %>% 
  dplyr::anti_join(tfl_tae, by = "source_id")

missing_tae_phys_sample %>% rt
missing_tae_plant_count %>% rt
missing_tae_hab_cond %>% rt
missing_tae_area_ass %>% rt
missing_tae_hab_comp %>% rt
```

### `tfl_tae` occurrence observations not in `tsc_tae_observations`

Any record differences in the following table indicate occurrence observations in TFL that
were not migrated into TSC.

```{r}
make_tfl_tae_occ_obs_summary <-
  . %>% nrow() %>% as.data.frame() %>% magrittr::set_colnames("TFL")

tfl_phys_sample_sum <-
  tfl_phys_sample %>% make_tfl_tae_occ_obs_summary
tfl_hab_cond_sum <-
  tfl_hab_cond %>% make_tfl_tae_occ_obs_summary
tfl_area_ass_sum <-
  tfl_area_ass %>% make_tfl_tae_occ_obs_summary
tfl_hab_comp_sum <-
  tfl_hab_comp %>% make_tfl_tae_occ_obs_summary
tfl_plant_count_sum <-
  tfl_plant_count %>% make_tfl_tae_occ_obs_summary

make_tsc_occ_obs_summary <- function(data, cn) {
  data %>%
    dplyr::select(obstype) %>%
    dplyr::filter(str_detect(obstype, cn)) %>%
    nrow() %>%
    as.data.frame %>%
    magrittr::set_colnames("TSC")
}

tsc_phys_sample_sum <-
  tsc_flora_observations %>% make_tsc_occ_obs_summary("PhysicalSample")
tsc_hab_cond_sum <-
  tsc_flora_observations %>% make_tsc_occ_obs_summary("HabitatCondition")
tsc_area_ass_sum <-
  tsc_flora_observations %>% make_tsc_occ_obs_summary("AreaAssessment")
tsc_hab_comp_sum <-
  tsc_flora_observations %>% make_tsc_occ_obs_summary("HabitatComposition")
tsc_plant_count_sum <-
  tsc_flora_observations %>% make_tsc_occ_obs_summary("PlantCount")


tfl_occ_obs_sum <- rbind(
  tfl_phys_sample_sum,
  tfl_hab_cond_sum,
  tfl_area_ass_sum,
  tfl_hab_comp_sum,
  tfl_plant_count_sum
)

tsc_occ_obs_sum <- rbind(
  tsc_phys_sample_sum,
  tsc_hab_cond_sum,
  tsc_area_ass_sum,
  tsc_hab_comp_sum,
  tsc_plant_count_sum
)

occ_obs_summary <- tfl_occ_obs_sum %>%
  cbind(tsc_occ_obs_sum) %>%
  cbind(Obstype = c("PhysicalSample", "HabitatCondition", "AreaAssessment", "HabitatComposition","PlantCount")) %>% 
  dplyr::select("Obstype", everything())

occ_obs_summary %>% rt
```

#### Individual occurrence observation comparisons

Below are comparisons of the original and migrated occurrence observations data. 
Each table shows example records for three species from each occurrence observation 
lookup table. Any differences would mean the data had not been migrated correctly. 

```{r}
tfl_species_plant_count <- tfl_plant_count %>% 
  filter(source_id %in% c("75917", "32829", "100069")) %>% 
  transmute(
    source_id = source_id,
    tfl_no_alive_mature = no_alive_mature,
    tfl_land_manager_present = land_manager_present)

tfl_species_phys_sample <- tfl_phys_sample %>% 
  filter(source_id %in% c("75917", "32829", "100069")) %>% 
  transmute(
    source_id = source_id,
    tfl_sample_type = sample_type,
    tfl_sample_destination = sample_destination)

tfl_species_hab_cond <- tfl_hab_cond %>% 
  filter(source_id %in% c("75917", "32829", "100069")) %>% 
  transmute(
    source_id = source_id,
    tfl_soil_condition = soil_condition)

tfl_species_area_ass <- tfl_area_ass %>% 
  filter(source_id %in% c("75917", "32829", "100069")) %>% 
  transmute(
    source_id = source_id,
    tfl_survey_method = survey_method,
    tfl_area_surveyed_m2 = area_surveyed_m2)

tfl_species_hab_comp <- tfl_hab_comp %>% 
  filter(source_id %in% c("75917", "32829", "100069")) %>% 
  transmute(
    source_id = source_id,
    tfl_landform = landform,
    tfl_drainage = drainage)

tsc_species_plant_count <- tsc_flora_observations %>% 
  filter(obstype == "PlantCount") %>% 
  filter(source_id %in% c("32829", "75917", "100069")) %>% 
  transmute(
    source_id = source_id,
    tsc_no_alive_mature = no_alive_mature,
    tsc_land_manager_present = land_manager_present) %>% 
  arrange(match(source_id, c("32829", "75917", "100069")))

tsc_species_phys_sample <- tsc_flora_observations %>% 
  filter(obstype == "PhysicalSample") %>% 
  filter(source_id %in% c("75917", "32829", "100069"))  %>% 
  transmute(
    source_id = source_id,
    tsc_sample_type = sample_type,
    tsc_sample_destination = sample_destination)

tsc_species_hab_cond <- tsc_flora_observations %>% 
  filter(obstype == "HabitatCondition") %>% 
  filter(source_id %in% c("75917", "32829", "100069"))  %>% 
  transmute(
    source_id = source_id,
    tsc_criteria = soil_condition %>% as.character()) %>% 
  dplyr::left_join(tfl_soil_condition, by = "tsc_criteria") %>% 
  select(c("source_id","tsc_soil_condition"))

tsc_species_area_ass <- tsc_flora_observations %>% 
  filter(obstype == "AreaAssessment") %>% 
  filter(source_id %in% c("75917", "32829", "100069")) %>% 
  transmute(
    source_id = source_id,
    tsc_criteria = survey_method %>% as.character(),
    tsc_area_surveyed_m2 = area_surveyed_m2) %>% 
  dplyr::left_join(tfl_survey_method, by = "tsc_criteria") %>% 
  select(c("source_id","tsc_survey_method","tsc_area_surveyed_m2"))
 
tsc_species_hab_comp <- tsc_flora_observations %>% 
  filter(obstype == "HabitatComposition") %>% 
  filter(source_id %in% c("75917", "32829", "100069")) %>% 
  transmute(
    source_id = source_id,
    tsc_criteria = landform %>% as.character(),
    tsc_drainage = drainage) %>% 
  dplyr::left_join(tfl_landcrit, by = "tsc_criteria") %>% 
  select(c("source_id","tsc_landforms","tsc_drainage")) %>% 
  transmute(
    source_id = source_id,
    tsc_landforms = tsc_landforms,
    tsc_criteria = tsc_drainage %>% as.character()) %>% 
  dplyr::left_join(tfl_drainage, by = "tsc_criteria") %>% 
  select(c("source_id","tsc_landforms","tsc_drainage"))
```

Plant count

```{r}
tfl_plant_count_sum <- tfl_species_plant_count %>% 
  left_join(tsc_species_plant_count, by = "source_id")

tfl_phys_sample_sum %>% rt
```

Physical samples

```{r}
tfl_phys_sample_sum <- tfl_species_phys_sample %>% 
  left_join(tsc_species_phys_sample, by = "source_id")

tfl_plant_count_sum %>% rt
```

Habitat condition

```{r}
tfl_hab_cond_sum <- tfl_species_hab_cond %>% 
  left_join(tsc_species_hab_cond, by = "source_id")

tfl_hab_cond_sum %>% rt
```

Area assessment

```{r}
tfl_area_ass_sum <- tfl_species_area_ass %>% 
  left_join(tsc_species_area_ass, by = "source_id")

tfl_area_ass_sum %>% rt
```

Habitat composition

```{r}  
tfl_hab_comp_sum <- tfl_species_hab_comp %>% 
  left_join(tsc_species_hab_comp, by = "source_id")

tfl_hab_comp_sum %>% rt
```

### Trust level of occurrence records

Currently, we assume that all occurrence records in the legacy databases are
trustworthy as indicated by their QA status. 

### `tfl_occ` occurrences not in `tfl_tae`

Any records in the following table indicate occurrences in `tfl_occ` that are 
not in `tfl_tae`.

```{r show_tfl_tae_missing_occurrences}
missing_occ_tfl_tae <- tfl_occ %>%
  dplyr::anti_join(tfl_tae, by = "source_id") 

missing_occ_tfl_tae %>% rt

missing_occ_tfl_tae_unique <- missing_occ_tfl_tae %>%
  dplyr::select(name_id) %>%
  distinct() 
```

There are `r nrow(missing_occ_tfl_tae)` occurrences missing from `tfl_tae` when
compared to `tfl_occ`. These missing occurrences come from
`r nrow(missing_occ_tfl_tae_unique)` unique species. The occurrences listed 
were likely not migrated because they do not contain a name_id and/or a 
location which are a requirement of a tfa taxon area encounter.

The table below is a tally of mismatching occurrences by taxon and confirms the 
missing occurrences identified above.

```{r make_tally_tfl_occ_tae}
tfl_occ_tally <- tfl_occ %>%
  dplyr::group_by(name_id) %>% 
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>% 
  ungroup()

tfl_tae_tally <- tfl_tae %>%
  dplyr::group_by(taxon) %>% 
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>% 
  ungroup() %>% 
  dplyr::rename(name_id = taxon)

tfl_occ_tally %>%
  dplyr::rename(tfl_occ = n) %>% 
  left_join(tfl_tae_tally,by = "name_id") %>% 
  dplyr::rename(tfl_tae = n) %>% 
  filter(tfl_occ != tfl_tae) %>% rt
```

### tfl\_tae occurrences not in tsc\_occ\_flora

Any records in the following table indicate occurrences in `tfl_tae` that were not
migrated into tsc.

```{r show_tsc_occ_flora_missing_occurrences}
missing_occ_tfl_occ_flora <- tfl_tae %>%
  dplyr::anti_join(tsc_tae, by = "source_id") 

missing_occ_tfl_occ_flora %>% rt
# missing_occ_tae_tsc <- tsc_tae %>%
#   dplyr::anti_join(tsc_occ_flora, by = "source_id")

missing_occ_tfl_occ_flora_unique <- missing_occ_tfl_occ_flora %>%
  dplyr::select(taxon) %>%
  distinct() %>%
  dplyr::left_join(tsc_taxa_flora, by = "taxon") 
```

There are `r nrow(missing_occ_tfl_occ_flora)` unique occurrences missing from
`tsc_occ_flora` when compared to `tfl_tae`. 

These missing occurrences come from `r nrow(missing_occ_tfl_occ_flora_unique)` 
unique species. 

The occurrences listed were likely not migrated because they do not contain 
lat or long data which is a requirement for valid taxon area encounter in tsc.

The table below is a tally of mismatching occurrences by taxon and confirms the missing
occurrences identified above.

```{r show_tally_tfl_tae_occ_flora}
tfl_tae_tally <- tfl_tae %>%
  dplyr::group_by(taxon) %>%
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>%
  ungroup()

tsc_occ_flora_tally <- tsc_tae %>%
  dplyr::group_by(taxon) %>%
  dplyr::tally() %>%
  dplyr::arrange(desc(n)) %>%
  ungroup()

tfl_tae_tsc_occ_tally <- tfl_tae_tally %>%
  dplyr::rename(tfl = n) %>%
  left_join(tsc_occ_flora_tally, by = "taxon") %>%
  dplyr::rename(tsc = n) %>%
  filter(tfl != tsc)

# tfl_tae_tsc_occ_tally %>% rt 
# TODO cast sfc to tbl_df
```

### `tfl_occ` names not in `tfl_tae`

```{r show_name_mismatches_tfl_tae_to_tsc_tae}
missing_taxa_tfl_tae <- tfl_occ %>%
  dplyr::anti_join(tfl_tae, by = c("name_id" = "taxon"))

missing_taxa_tfl_tae_unique <- missing_taxa_tfl_tae %>%
  dplyr::select(name_id) %>%
  distinct() %>%
  dplyr::left_join(tsc_taxa_flora, by = c("name_id"="taxon")) #26

missing_taxa_tfl_tae_unique %>% rt
```

There are `r nrow(missing_taxa_tfl_tae)` taxon records missing from `tsc_tae` when
compared to `tfa_tae`. These records are attributed to
`r nrow(missing_taxa_tfl_tae_unique)` unique species.

### `tfl_tae` names not in `tsc_occ_flora`

```{r show_name_mismatches_tfl_tae_to_tsc_taxa_flora}
missing_taxa_tsc <- tfl_tae %>%
  dplyr::anti_join(tsc_tae, by = "taxon")

missing_taxa_tsc_unique <- missing_taxa_tsc %>%
  dplyr::select(taxon) %>%
  distinct() %>%
  dplyr::left_join(tsc_taxa_flora, by = "taxon") #26

missing_taxa_tsc_unique %>% rt
```

There are `r nrow(missing_taxa_tsc)` taxon records missing from `tsc_occ_flora` when
compared to `tfa_tae`. These records are attributed to
`r nrow(missing_taxa_tsc_unique)` unique species.

## Conservation Documents

## Fire History

## Conservation Threats and Actions

# Upload to data catalogue

The [compiled version of this workbook](https://data.dbca.wa.gov.au/dataset/79e90d7b-33a3-4aa0-8634-8a12033eb21d/resource/1b5e6401-82fe-4728-83be-f3f8ea4b5876) 
is uploaded to the [Threatened Flora Dataset](https://data.dbca.wa.gov.au/dataset/threatened-and-priority-flora-database/)
on the DBCA data catalogue.

The manual mappings of legacy data to TSC are also uploaded as CSV snapshots.

```{r upload_data_catalogue}
# This workbook
upload_file_to_ckan("1b5e6401-82fe-4728-83be-f3f8ea4b5876", "EDA_flora.html")

# Manual mapping of conservation criteria
# upload_file_to_ckan("", here::here("tfl_conscrit_w_tsc.csv"))

# Legacy tfl data
d <- ckanr::package_show("threatened-and-priority-flora-database")
# upload_to_ckan(
#   tfl_cons_listings, "Threatened Flora Conservation Status Gazettal", d$id,
#   resource_id = ""
# )
# same for other tfl legacy data, copy over from data_etl_flora.Rmd

# TODO review and adjust:
upload_to_ckan(tfl_occ, "TPFL Species Occurrence",
               d$id, resource_id = "b2e7f5a9-8ffb-41c4-bd11-ab090ccb71ef")
upload_to_ckan(populations, "TPFL Populations", 
               d$id, resource_id = "477dbe8c-5bcb-4a5d-90d9-a28869d376b8")
upload_to_ckan(occ_vegclass, "TPFL Occurrence vegetation classes", 
               d$id, resource_id = "bb8814ff-c423-40d5-b18d-9977a66351b7")
upload_to_ckan(occ_threats, "TPFL Occurrence threats", 
               d$id, resource_id = "a58b7214-6db1-409b-a08f-d4e28ac0c139")
upload_to_ckan(occ_fire, "TPFL Occurrence fire details", 
               d$id, resource_id = "9591a80a-cd51-4f57-bc6c-1d0024b49a58")
upload_to_ckan(pop_forms, "TPFL Population forms", 
               d$id, resource_id = "f881dbd9-31f6-4c9b-a224-62380b2f7e83")
upload_to_ckan(pop_threats, "TPFL Population threats", 
               d$id, resource_id = "3a1f3e73-7b02-4534-955b-b403ae5577ad")
upload_to_ckan(mgmt_act, "TPFL Population management actions", 
               d$id, resource_id = "3df48c1e-9fbd-48bf-8b75-ab9dbb71cfc3")
upload_to_ckan(fire_sum, "TPFL Population fire summaries", 
               d$id, resource_id = "426571af-7c1a-462b-9325-6203383546c3")
upload_to_ckan(occ_liaisons, "TPFL Liaisons", 
               d$id, resource_id = "610b31a2-d2f0-4c26-9a48-8d7fc8d58265")
upload_to_ckan(pop_vegclass, "TPFL Population vegetation classes", 
               d$id, resource_id = "89ff76aa-4511-442c-9115-101a7d5be14b")
upload_to_ckan(tfl_cons_listing, "TPFL Conservation Listings", 
               d$id, resource_id = "0fbd9080-21d7-4fb1-ae43-4cc5791862c3")
upload_to_ckan(occ_priority, "TPFL Poulation priority", 
               d$id, resource_id = "668d2bd2-02bf-43fc-ad88-439185013d15")
```
