---
title: "WACensus ETL"
author: "Florian Mayer, DBCA"
date: "`r Sys.time()`"
always_allow_html: yes
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document: default
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lubridate)
library(magrittr)
library(tidyverse)
library(skimr)
library(leaflet)
library(Hmisc)
library(ckanr)
library(wastdr)
source("helpers.R")
ckanr::ckanr_setup(url = Sys.getenv("CKAN_URL"), key = Sys.getenv("CKAN_API_KEY"))
```

# Context

* WACensus, an Oracle database, is the point of truth for WA texonomic names at DBCA.
* KMI publishes a few WACensus views as GeoServer views.
* BioSysTT maintains a copy of those WACensus views.

This workbook serves to update BioSysTT via its API from KMI's WACensus views.

# Read data from KMI

## Helpers

```{r read_data_helpers}
kmi_getFeature <- function(
    layer_name = "dpaw:herbie_hbvnames", 
    url = "https://kmi.dbca.wa.gov.au/geoserver/dpaw/ows"){
    ua <- httr::user_agent("http://github.com/dbca-scarab-scripts")
    url <- "https://kmi.dbca.wa.gov.au/geoserver/dpaw/ows"
    query <- list(
        service = "WFS",
        version = "2.0.0",
        request = "GetFeature",
        typeName = layer_name,
        outputFormat="application/json"
    )
    res <- httr::GET(url, ua, query = query)
    httr::content(res)
}
```

## Read all data from KMI

```{r read_data, eval=FALSE}
f <- kmi_getFeature(layer_name = "dpaw:herbie_hbvnames")
```

# Write data to BioSys TT

## Helpers

```{r write_data_helpers}
wastd_POST <- function(
    data,
    serializer = "taxonomy",
    api_url = wastdr::get_wastdr_api_url(),
    api_token = wastdr::get_wastdr_api_token(),
    api_un = wastdr::get_wastdr_api_un(),
    api_pw = wastdr::get_wastdr_api_pw()
){
    ua <- httr::user_agent("http://github.com/parksandwildlife/turtle-scripts")
    
    if (!is.null(api_token)) {
        auth <- httr::add_headers(c(Authorization = api_token))
      } else {
        auth <- httr::authenticate(api_un, api_pw, type = "basic")
      }
    
    url <- paste0(api_url, serializer, "/")
    
    res <- httr::POST(url, auth, ua, encode = "json", body = data)
    
    res
}

wastd_batch_update_taxon <- function(kmi_featurecollection){
    purrr::map(kmi_featurecollection[["features"]], "properties") %>%
    purrr::map(wastd_POST, api_url = "http://localhost:8220/api/1/") %>%
    httr::content(as="parsed", encoding = "utf-8")
}
```

## Example: update one Taxon

```{r write_data_example, eval=FALSE}
props <- purrr::map(f[["features"]], "properties")
one_update <- wastd_POST(props[[1]], api_url = "http://localhost:8220/api/1/") %>% 
    httr::content(as="parsed", encoding = "utf-8")
all_updates <- purrr::map(props, wastd_POST, api_url = "http://localhost:8220/api/1/")
```

## Batch upsert: Create or update all Taxa

```{r rock_and_roll, eval=FALSE}
updated <- kmi_getFeature(layer_name = "dpaw:herbie_hbvnames") %>%
    wastd_batch_update_taxon(.)
```


# Upload to CKAN

```{r upload_ckan}
d <- ckanr::package_show("wacensus")
# r <- resource_create(package_id = d$id, name="WACensus ETL to BioSysTT", format="HTML", upload = "data_etl_wacensus.html")
ckanr::resource_update("2893ad10-dfbf-460d-a508-5195edfd9a89", "data_etl_wacensus.html")
```
