---
title: "Occurrence analysis"
author: "Florian Mayer, DBCA"
date: "`r Sys.time()`"
always_allow_html: yes
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
# devtools::install_github("ropenscilabs/skimr")
# devtools::install_github("tidyverse/readr")
# install from github: "brianb/mdbtools"
# devtools::install_github("ropensci/ckanr")
library(tidyverse)
library(magrittr)
library(lubridate)
library(skimr)
library(leaflet)
library(Hmisc)
library(ckanr)
library(grDevices)
library(sf)
library(geojsonsf)
library(mapview)
library(ggplot2)

# Configure ckanr to data.dpaw.wa.gov.au
ckanr::ckanr_setup(url = Sys.getenv("CKAN_URL"), key = Sys.getenv("CKAN_API_KEY"))
source("helpers.R")
```

# Context
This workbook analyses occurrence data of threatened species and communities as
extracted from the legacy databases.

Currently, data snapshots from the data catalogue as exported by the ETL workbooks are used. Soon, we will use occurrence data from BioSys.

# Data download
* Now: Occurrence data snapshots from data catalogue
* Soon: Occurrence data from Biosys

```{r}
fauna_occ_rid <- "b73ae0de-f243-4bb3-bbce-25b65bb98e66"
flora_occ_rid <- "b2e7f5a9-8ffb-41c4-bd11-ab090ccb71ef"
comm_occ_rid <- ""
fauna_occ <- ckanr::resource_show(fauna_occ_rid)$url %>% read_csv()
```

# Analysis
## Extent of Occurrence
This section will calculate the Extent of Occurrence (EOO) 
as convex hulls around all occurrences 
of each `name_id` as recorded within the past 10 years.

```{r}
occ_tally <- fauna_occ %>% 
    group_by(name_id, scientific_name) %>% 
    tally() %>% 
    dplyr::arrange(desc(n))
kable(head(occ_tally, n=20))
```
There are `r nrow(occ_tally)` fauna taxa with recorded occurrences.

## Calculating EOO from occurrence point observations
```{r}
eoo_polygon <- function(data, nid=NULL, crs=4283){
    if (is.null(nid)) {
        selected <- data
    } else {
        selected <- dplyr::filter(data, name_id == nid)
    }
    selected %>% 
        sf::st_as_sf(., coords = c("longitude", "latitude"), 
                     crs = crs, agr = "constant") %>% 
        sf::st_union(.) %>% 
        sf::st_convex_hull(.)
}

eoo_all <- eoo_polygon(fauna_occ)

# https://tsc.dbca.wa.gov.au/api/1/taxon/?name_id=24557
# Leipoa ocellata, Malleefowl
eoo_24557 <- eoo_polygon(fauna_occ, nid = 24557)
# see https://r-spatial.github.io/sf/articles/sf5.html
# ggplot() + geom_sf(data = eoo_24557)
mapview(eoo_24557)

# https://tsc.dbca.wa.gov.au/api/1/taxon/?name_id=24734
# Calyptorhynchus latirostris, Carnaby's Black Cockatoo: 14k occurrences
eoo_24734 <- eoo_polygon(fauna_occ, nid = 24734)
mapview(eoo_24734)

# Write sf object to GeoJSON geometry:
# https://cran.r-project.org/web/packages/geojsonsf/vignettes/geojson-sf-conversions.html
# 
eoo_24557 %>% sfc_geojson()

```

# Data upload
## EOO to data catalogue upload
Snapshots of the EOO polygons are uploaded to the data catalogue.
```{r}
d <- ckanr::package_show("wacensus")
# upload this workbook, species EOOs, and comms EOOs.
```

## EOO to TSC upload
This section will upload the EOOs to TSC through its API using `wastdr`.
