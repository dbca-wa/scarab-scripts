---
title: "Data ETL: Flora"
author: "Florian Mayer, DBCA"
date: "`r Sys.time()`"
always_allow_html: yes
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# devtools::install_github("ropenscilabs/skimr")
# devtools::install_github("tidyverse/readr")
# install from github: "brianb/mdbtools"
# devtools::install_github("ropensci/ckanr")
library(tidyverse)
library(skimr)
library(leaflet)
library(Hmisc)
library(ckanr)

# Configure ckanr to data.dpaw.wa.gov.au
ckanr::ckanr_setup(
  url = Sys.getenv("CKAN_URL"),
  key = Sys.getenv("CKAN_API_KEY")
)
source("helpers.R")
```
# SCB data background
[Flora dataset](https://data.dpaw.wa.gov.au/dataset/threatened-and-priority-flora-database) 
on the [departmental data catalogue](https://data.dpaw.wa.gov.au/).

[Flora data snapshot](https://data.dpaw.wa.gov.au/dataset/threatened-and-priority-flora-database/resource/d1fccebb-02e2-4a40-aba4-c4d6ad012edb) on the [departmental data catalogue](https://data.dpaw.wa.gov.au/).

# Flora

## Flora data load
```{r flora_load_data}
flora <- ckanr::resource_show("913f3e63-5254-4ab1-927b-7c2a91a0b241")$url %>%
  read.csv(., as.is = TRUE, encoding = "utf8", fileEncoding = "latin1")
```

## Flora data overview
```{r flora_skim}
skimr::skim(flora)
```

## Flora map
```{r flora_map}
leaflet(width = 800, height = 600) %>%
  addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
  addProviderTiles("OpenStreetMap.Mapnik", group = "Place names") %>%
  clearBounds() %>%
  addAwesomeMarkers(
    data = flora,
    lng = ~ Gda94Long, lat = ~ Gda94Lat,
    icon = leaflet::makeAwesomeIcon(icon = "leaf"),
    label = ~ paste(Taxon),
    popup = ~ paste(
      "<h3>", Taxon, "</h3>",
      "<strong>Encountered on</strong>", CountDate, "<br/>",
      HabNotes, "<br/>",
      PopNotes, "<br/>",
      Location
    ),
    group = "Flora",
    clusterOptions = markerClusterOptions()
  ) %>%
  addLayersControl(
    baseGroups = c("Aerial", "Place names"),
    overlayGroups = c("Flora"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

## Flora data upload
Create resource once-off to get a resource ID.
Subsequently, upload the compiled workbook.
Note, this process lags one compilation of this workbook, as the HTML output
is generated after the R code is run.

```{r flora_upload}
d <- ckanr::package_show("threatened-and-priority-flora-database")
ckanr::resource_update("d1fccebb-02e2-4a40-aba4-c4d6ad012edb", "data_etl_flora.html")
# upload_to_ckan(dataframe, "TPFL title", d$id, resource_id = NULL)
```
