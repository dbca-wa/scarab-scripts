---
title: "Data ETL: TEC"
author: "Florian Mayer, DBCA"
date: "`r Sys.time()`"
always_allow_html: yes
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# devtools::install_github("ropenscilabs/skimr")
# devtools::install_github("tidyverse/readr")
# install from github: "brianb/mdbtools"
# devtools::install_github("ropensci/ckanr")
library(tidyverse)
library(lubridate)
library(skimr)
library(leaflet)
library(Hmisc)
library(ckanr)

# Configure ckanr to data.dpaw.wa.gov.au
ckanr::ckanr_setup(url = Sys.getenv("CKAN_URL"), 
                   key = Sys.getenv("CKAN_API_KEY"))

#' Download, extract and open a zipped Access database from a CKAN dataset
#' 
#' @param resource_id The CKAN resource ID of a zipped Access DB
#' @param destdir The local destination directory for the extracted file, 
#'  will be created if not existing. Default: "data"
#' @param dateformat The parameter dateformat for Hmisc::mdb.get(), 
#'  default: '%Y-%m-%d'
#' @param asis The parameter as.is for Hmisc::mdb.get(), default: TRUE
#' @returns The Hmisc::mdb.get connection
dl_mdbzip <- function(resource_id, 
                      destdir="data", 
                      dateformat = '%m-%d-%Y', 
                      asis = TRUE) {
    dir.create(file.path(getwd(), destdir), showWarnings = FALSE)
    tmp <- tempfile()
    res_url <- ckanr::resource_show(resource_id)$url
    utils::download.file(res_url, tmp)
    dbfile <- utils::unzip(tmp, exdir = destdir)
    con <- Hmisc::mdb.get(dbfile, dateformat = dateformat, as.is = asis)
    unlink(tmp)
    con
}
```
# SCB data background
[TEC dataset](https://data.dpaw.wa.gov.au/dataset/threatened-ecological-communities-database)
on the [departmental data catalogue](https://data.dpaw.wa.gov.au/).

# TEC

## TEC data load
```{r tec_data_load}
tec <- dl_mdbzip("598b1e70-5707-4dbc-a665-1189e1524ebe")
# tec_app <- dl_mdbzip("27d9b026-6933-4516-acf6-41edc6134adb")
```

## Helpers
```{r helpers}
# Date conventions
orders <- c("mdyHMS")
tz <- "Australia/Perth"

# Prepare column def
as_def <- . %>% paste(., "=", ., " %>% as.character, \n")
make_coldef <- . %>% names %>% purrr::map(as_def) %>% unlist %>% cat
```

## Communities
```{r communities}
former_range <- tec$FORMER_RANGES %>%
  dplyr::transmute(
    former_range_id = FORMER.RANGE %>% as.character(),
    former_range = FORMER.RANGE.DESC %>% as.character()
  )
# make_coldef(former_range)

range_decline <- tec$RANGE_DECLINE %>%
    dplyr::transmute(
        range_decline_id = RANGE.DECLINE  %>% as.integer(), 
        range_decline = RANGE.DECLINE.DESC  %>% as.character()
    )
# make_coldef(range_decline)

occurrence_decline <- tec$OCCURRENCES_DECLINE %>%
    dplyr::transmute(
        occurrence_decline_id = OCC.DECLINE  %>% as.integer(), 
        occurrence_decline = OCC.DECLINE.DESC  %>% as.character()
    )
# make_coldef(occurrence_decline)

communities <- tec$COMMUNITIES %>%
    tibble::as.tibble() %>%
  dplyr::transmute(
    community_id = COM.NO %>% as.integer(),
    community_label = COM.ID %>% as.character(),
    community_name = COM.NAME %>% as.character(),
    community_description = COM.DESC %>% as.character(),
    former_range_id = COM.FORMER.RANGE %>% as.character(),
    range_decline_id = COM.RANGE.DECLINE %>% as.integer(),
    occurrence_decline_id = COM.OCC.DECLINE %>% as.integer(),
    community_tec_listing = COM.TEC.LISTING %>% as.integer(),
    community_original_area = COM.ORIG.AREA %>% as.double(),
    community_area_accuracy = COM.AREA.ACC %>% as.double(),
    preliminary = COM.PRELIMINARY %>% as.character(),
    status = COM.STATUS %>% as.character()
  ) %>%
  dplyr::left_join(former_range, by = "former_range_id") %>%
  dplyr::left_join(range_decline, by = "range_decline_id") %>%
  dplyr::left_join(occurrence_decline, by = "occurrence_decline_id")
# make_coldef(communities)
communities %>% skim()
communities %>% DT::datatable(.)

communities_short <- communities %>% 
    dplyr::select(community_id, community_label, community_name)
```

## Occurrences
```{r occurrences}
occurrences <- tec$OCCURRENCES %>% 
    tibble::as.tibble() %>%
    dplyr::transmute(
    id = OCC.UNIQUE.ID %>% as.integer,
    community_id = COM.NO %>% as.integer,
    occ_no = OCC.NO %>% as.integer,
    confidential = OCC.CONFIDENTIAL %>% as.integer,
    source_code = OCC.SOURCE.CODE %>% as.character,
    body_id = BDY.ID %>% as.integer,
    br_code = OCC.BR.CODE %>% as.character,
    beard_dist_code = OCC.BEARD.DIST.CODE %>% as.character,
    ibra_reg_code = OCC.IBRA.REG.CODE %>% as.character,
    dola_ref = OCC.DOLA.REF %>% as.character,
    ctrc_sys = OCC.CTRC.SYS %>% as.integer,
    ctrc_recommendation = OCC.CTRC.RECOMMENDATION %>% as.character,
    cwealth_listing = OCC.CWEALTH.LISTING %>% as.character,
    original_area = OCC.ORIGINAL.AREA %>% as.double,
    area_accuracy = OCC.AREA.ACCURACY %>% as.double,
    data = OCC.DATA %>% as.character,
    other = OCC.OTHER %>% as.character,
    soil = OCC.SOIL %>% as.character,
    surf_geology = OCC.SURF.GEOLOGY %>% as.character,
    land_element = OCC.LAND.ELEMENT %>% as.character,
    water = OCC.WATER %>% as.character,
    drainage = OCC.DRAINAGE %>% as.character,
    com_structure = OCC.COM.STRUCTURE %>% as.character,
    classification = OCC.CLASSIFICATION %>% as.character,
    other_attr =  OCC.OTHER.ATTR %>% as.character,
    beard_map_code = OCC.BEARD.MAP.CODE %>% as.character,
    beard_desc = OCC.BEARD.DESC %>% as.character,
    desc = OCC.DESC %>% as.character,
    boundary_desc = OCC.BOUNDARY.DESC %>% as.character,
    species_desc = OCC.SPECIES.DESC %>% as.character,
    zone_code = OCC.ZONE.CODE %>% as.character,
    username = USERNAME %>% as.character,
    date_entered =  OCC.DATE.ENTERED %>% 
        lubridate::parse_date_time(., orders = orders, tz=tz), 
    date_edited = OCC.DATE.EDITED %>% as.character %>% 
        lubridate::parse_date_time(., orders = orders, tz=tz),
    buffer_radius = OCC.BUFFER.RADIUS %>% as.integer,
    bush_forever_site_no = OCC.BUSH.FOREVER.SITE.NO %>% as.integer,
    status_code = OCC.STATUS.CODE %>% as.logical,
    no_boundary = OCC.NO.BOUNDARY %>% as.integer,
    commenwealth_desc = OCC.COMMONWEALTH.DESC %>% as.character
    ) %>%
    dplyr::left_join(communities_short, by = "community_id")
occurrences %>% skimr::skim()
occurrences %>% head(10) %>% DT::datatable(.)
```

## Recovery Plans
```{r recovery_plans}
recovery_plans <- tec$INTERIM_RECOVERY_PLANS %>%
  dplyr::transmute(
    recovery_plan_id = IRP.NO %>% as.character(),
    community_id = COM.NO %>% as.integer(),
    endorsed_on = IRP.DATE.ENDORSED %>% parse_date_time(., orders = orders, tz = tz),
    ends_on = IRP.END.DATE %>% parse_date_time(., orders = orders, tz = tz),
    author = IRP.AUTHOR %>% as.character(),
    reviewed_on = IRP.DATE.REVIEWED %>% parse_date_time(., orders = orders, tz = tz),
    comments = IRP.COMMENTS %>% as.character()
  ) %>% 
  dplyr::left_join(communities_short, by = "community_id")
# make_coldef(recovery_plans)
recovery_plans %>% skim()
```

## Publications
```{r publications}
publications <- tec$PUBLICATIONS %>%
  dplyr::transmute(
    publication_id = PUB.NO %>% as.integer(),
    title = PUB.TITLE %>% as.character(),
    author = PUB.AUTHOR %>% as.character()
    # empty:
    # published_on = PUB.DATE %>% parse_date_time(., orders = orders, tz = tz),
    # published_with = PUB.PLACE %>% as.character()
  )
# make_coldef(publications)

community_publications <- tec$COMMUNITY_PUBLICATIONS %>%
    dplyr::transmute(
        community_id = COM.NO  %>% as.integer(), 
        publication_id = CP.PUB.NO  %>% as.integer(),
    ) %>%
    dplyr::left_join(publications, by = "publication_id") %>%
    dplyr::left_join(communities_short, by = "community_id")
# make_coldef(community_publications)
community_publications %>% skim()
community_publications %>% DT::datatable(.)
```

## Reviews
```{r com_reviews}
reviews <- tec$REVIEWS %>%
  dplyr::transmute(
    review_id = REV.NO %>% as.integer(),
    review_date = REV.DATE %>% parse_date_time(., orders = orders, tz = tz),
    review_panel = REV.PANEL %>% as.character()
  )
# reviews %>% make_coldef()
reviews %>% skim()

community_reviews <- tec$COMMUNITY_REVIEWS %>%
  dplyr::transmute(
    community_id = COM.NO %>% as.integer(),
    review_id = CR.REV.NO %>% as.integer()
  ) %>%
  dplyr::left_join(communities_short, by = "community_id") %>%
  dplyr::left_join(reviews, by = "review_id")
# community_reviews %>% make_coldef()
community_reviews %>% skim()
community_reviews %>% DT::datatable(.)
```

## Community Actions
Are `COMMUNITY_ACTIONS` related to `ACTIONS`?
```{r com_actions}
community_actions <- tec$COMMUNITY_ACTIONS %>%
  dplyr::transmute(
    community_id = COM.NO %>% as.integer(),
    com_action_id = CACT.NO %>% as.integer(),
    com_action_date = CACT.DATE %>% parse_date_time(., orders = orders, tz = tz),
    com_action_code = CACT.ACTION.CODE %>% as.character(),
    com_action_description = CACT.DESC %>% as.character()
  ) %>%
  dplyr::left_join(communities_short, by = "community_id")
# community_actions %>% make_coldef()
community_actions %>% skim()
community_actions %>% DT::datatable(.)
```

## TEC data upload
Create resource once-off to get a resource ID.
Subsequently, upload the compiled workbook.
Note, this process lags one compilation of this workbook, as the HTML output
is generated after the R code is run.

```{r tec_upload}
# d <- ckanr::package_show("threatened-ecological-communities-database")

etl_title <- "TEC Data ETL"
etl_fn <- "data_etl_tec.html"
# r <- ckanr::resource_create(package_id = d$id, format = "html", name = etl_title, upload = etl_fn)
# etl_rid <- r$id
etl_rid <- "80009375-19e2-45d3-a1ae-068143fa03a5"
ckanr::resource_update(etl_rid, etl_fn)

com_title <- "Threatened Ecological Communities"
com_fn <- "data/communities.csv"
communities %>% write_delim(com_fn, delim = ",")
# r <- ckanr::resource_create(package_id = d$id, format = "csv", name = com_title, upload = com_fn)
# com_rid <- r$id
com_rid <- "9782cc52-7be8-494a-a7da-51845c119a21"
ckanr::resource_update(com_rid, com_fn)

occ_title <- "Threatened Ecological Community Occurrences"
occ_fn <- "data/occurrences.csv"
occurrences %>% write_delim(occ_fn, delim = ",")
# r <- ckanr::resource_create(package_id = d$id, format = "csv", name = occ_title, upload = occ_fn)
# occ_rid <- r$id
occ_rid <- "65f43392-a8c5-41e2-a31e-cc4135e9274e"
ckanr::resource_update(occ_rid, occ_fn)

cpu_title <- "Threatened Ecological Community Publications"
cpu_fn <- "data/community_publications.csv"
community_publications %>% write_delim(cpu_fn, delim = ",")
# r <- ckanr::resource_create(package_id = d$id, format = "csv", name = cpu_title, upload = cpu_fn)
# cpu_rid <- r$id
cpu_rid <- "fa51cd96-864a-4c43-a0e1-fc24621bb628"
ckanr::resource_update(cpu_rid, cpu_fn)

cr_title <- "Threatened Ecological Community Reviews"
cr_fn <- "data/community_reviews.csv"
community_reviews %>% write_delim(cr_fn, delim = ",")
# r <- ckanr::resource_create(package_id = d$id, format = "csv", name = cr_title, upload = cr_fn)
# cr_rid <- r$id
cr_rid <- "7c39b584-bc4b-4234-aff7-ddf4808692ed"
ckanr::resource_update(cr_rid, cr_fn)

ca_title <- "Threatened Ecological Community Actions"
ca_fn <- "data/community_actions.csv"
community_actions %>% write_delim(ca_fn, delim = ",")
# r <- ckanr::resource_create(package_id = d$id, format = "csv", name = ca_title, upload = ca_fn)
# ca_rid <- r$id
ca_rid <- "17d3c4e2-df98-4ff6-9d4d-99ba54808bb4"
ckanr::resource_update(ca_rid, ca_fn)
```
