---
title: "Data ETL: TEC"
author: "Florian Mayer, DBCA"
date: "`r Sys.time()`"
always_allow_html: yes
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    fig_width: 10
    fig_height: 6
    code_folding: show
    theme: lumen
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (file.exists("~/.Rprofile")) source("~/.Rprofile")
source("helpers.R")
```

# Conventions
The following conventions shall be used to create table and column names in this ETL process.

* All names shall be snake_case, i.e. lower cased and underscore-separated.
* Primary key (PK) columns in lookup tables shall be prefixed by the table name. 
  This facilitates joining multiple lookups using unambiguous column names.
* Numeric PKs shall be named `_id`.
* Alphanumeric PKs (containing characters) shall be named `_code`.
* Abbreviations shall be avoided largely, with the exception of the ubiquitous 
  community (`com`) and occurrence (`occ`).

* All primary tables shall be joined to their lookup tables, and legacy lookup ID / code shall be discarded.
* Tables holding obsolete or duplicate data will be discarded.

# SCB data background
[TEC dataset](https://data.dpaw.wa.gov.au/dataset/threatened-ecological-communities-database)
on the [departmental data catalogue](https://data.dpaw.wa.gov.au/).

The code for all SCB workbooks is under version control at [github](https://github.com/dbca-wa/scarab-scripts).

# TEC

## TEC data load
```{r tec_data_load}
tec <- dl_mdbzip("598b1e70-5707-4dbc-a665-1189e1524ebe")
# tec_app <- dl_mdbzip("27d9b026-6933-4516-acf6-41edc6134adb")
```

## Configuration
Some tables store legacy configuration data. We won't need or import them.

* Settings: Datum preference
* Sp Master INI old: external db config
* mddDataTables/columns: external db tables
* mddMasterLists: external db config
* mddReportItems (empty)

## Taxonomy

* WA_* WACensus data copies
* jhb
* SPMASTER_OLD, Flora conservation codes
* Fauna taxa, Fauna conservation codes, Fauna Groups, Occ Fauna, Occ species, Species roles

TODO how are taxonomy tables linked? Which one is the current master one?

## Spatial lookups
There are several groups of spatial entities which are maintained outside of the SCB ecosystem.
The link to WSCB entities can be inferred unambiguously through geospatial location and cached for performance.

* IBRA regions
* Beard: Districts within Regions within Provinces
* CALM: Occurrences within Districts within Regions. How are the occurrences inferred / added?
* CALM District Users
* DOLA locations
* Bush forever sites
* Zones (three broad zones in WA: rangelands, wheatbelt, southwest non-wheatbelt)
* Land use: Land Use, Land Use Codes, Occurrence Surr(?) Codes
* Tenures: Purposes, Tenure Types, Tenures, Occurrence Tenures, Occurrence Shires, Shires
* Maps: Maps, Occurrence Maps

```{r spatial_lookups, echo=FALSE}
# calm_regions <- tec$CALM_REGIONS
# calm_districts <- tec$CALM_DISTRICTS
# calm_district_occurrences <- tec$DISTRICTS
```

## GIS exports
Some tables refer to externally managed spatial data:

* GIS_*
* Boundaries

## Spatial concepts
* Each occurrence lies within a `boundary` polygon.
* Not all occurrences have recorded boudaries.
* Boundaries (where existing) are buffered by a distance (default 500m) into a `buffer` polygon.
* Some buffers are reconstructed from a point plus a circular buffer, where boundaries are missing.
* There is one buffer for each occurrence.
* Point observations are somewhat misleadingly named `site`.
* Sites can serve:

  * To name a boundary
  * To create a buffer
  * To reference a point observation
  * To reference a terrestrial quadrat (default 10m x 10m) which is surveyed for species occurrences
* Some boundaries contain multiple sites.

There are 122970 sites, 120118 boundaries, and 121366 buffers.

## Communities
Abbreviation: `com`

```{r communities}
former_range <- tec$FORMER_RANGES %>%
  dplyr::transmute(
    former_range_code = FORMER.RANGE %>% as.character(),
    former_range = FORMER.RANGE.DESC %>% as.character()
  )
# make_coldef(former_range)

range_decline <- tec$RANGE_DECLINE %>%
  dplyr::transmute(
    range_decline_id = RANGE.DECLINE %>% as.integer(),
    range_decline = RANGE.DECLINE.DESC %>% as.character()
  )
# make_coldef(range_decline)

occ_decline <- tec$OCCURRENCES_DECLINE %>%
  dplyr::transmute(
    occ_decline_id = OCC.DECLINE %>% as.integer(),
    occ_decline = OCC.DECLINE.DESC %>% as.character()
  )
# make_coldef(occ_decline)

status <- tec$STATUS %>%
  dplyr::transmute(
    status_code = STATUS.CODE %>% as.character(),
    status = STATUS.DESC %>% as.character()
  )
# status %>% make_coldef()
# unique(status$status_code) # "BELIEVED"   "IDENTIFIED" - where used?

communities <- tec$COMMUNITIES %>%
  tibble::as.tibble() %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    com_label = COM.ID %>% as.character(),
    com_name = COM.NAME %>% as.character(),
    com_description = COM.DESC %>% as.character(),
    former_range_code = COM.FORMER.RANGE %>% as.character(),
    range_decline_id = COM.RANGE.DECLINE %>% as.integer(),
    occ_decline_id = COM.OCC.DECLINE %>% as.integer(),
    com_tec_listing = COM.TEC.LISTING %>% as.integer(),
    com_original_area = COM.ORIG.AREA %>% as.double(),
    com_area_accuracy = COM.AREA.ACC %>% as.double(),
    preliminary = COM.PRELIMINARY %>% as.character(),
    status = COM.STATUS %>% as.character()
  ) %>%
  dplyr::left_join(former_range, by = "former_range_code") %>%
  dplyr::left_join(range_decline, by = "range_decline_id") %>%
  dplyr::left_join(occ_decline, by = "occ_decline_id") %>%
  dplyr::select(-former_range_code, -range_decline_id, -occ_decline_id)

communities %>% skim()
communities %>% DT::datatable(.)

com_short <- communities %>% dplyr::select(com_id, com_label, com_name)
```

## Community Recommendations

```{r com_recommendations}
recommendations <- tec$RECOMMENDATIONS %>%
  dplyr::transmute(
    recommendation_code = REC.CODE %>% as.character(),
    recommendation = REC.DESC %>% as.character()
  )

com_recommendations <- tec$COMMUNITY_RECOMMENDATIONS %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    recommendation_id = CREC.NO %>% as.integer(),
    recommended_on = CREC.DATE %>% as.character(),
    recommendation_code = CREC.REC.CODE %>% as.character(),
    com_recommendation = CREC.DESC %>% as.character()
  ) %>%
  dplyr::left_join(com_short, by = "com_id") %>%
  dplyr::left_join(recommendations, by = "recommendation_code")

com_recommendations %>% DT::datatable(.)
```

## Community Publications

```{r com_publications}
publications <- tec$PUBLICATIONS %>%
  dplyr::transmute(
    publication_id = PUB.NO %>% as.integer(),
    title = PUB.TITLE %>% as.character(),
    author = PUB.AUTHOR %>% as.character()
    # empty:
    # published_on = PUB.DATE %>% parse_date_time(., orders = orders, tz = tz),
    # published_with = PUB.PLACE %>% as.character()
  )

com_publications <- tec$COMMUNITY_PUBLICATIONS %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    publication_id = CP.PUB.NO %>% as.integer(),
  ) %>%
  dplyr::left_join(publications, by = "publication_id") %>%
  dplyr::left_join(com_short, by = "com_id")

com_publications %>% DT::datatable(.)
```

## Community Reviews

```{r com_reviews}
reviews <- tec$REVIEWS %>%
  dplyr::transmute(
    review_id = REV.NO %>% as.integer(),
    review_date = REV.DATE %>% parse_date_time(., orders = orders, tz = tz),
    review_panel = REV.PANEL %>% as.character()
  )

com_reviews <- tec$COMMUNITY_REVIEWS %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    review_id = CR.REV.NO %>% as.integer()
  ) %>%
  dplyr::left_join(com_short, by = "com_id") %>%
  dplyr::left_join(reviews, by = "review_id")

com_reviews %>% DT::datatable(.)
```

## Community Actions

```{r com_actions}
actions <- tec$ACTIONS %>%
  dplyr::transmute(
    action_id = ACTION.CODE %>% as.character(),
    description = ACTION.DESC %>% as.character()
  )

com_actions <- tec$COMMUNITY_ACTIONS %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    com_action_id = CACT.NO %>% as.integer(),
    com_action_date = CACT.DATE %>% parse_date_time(., orders = orders, tz = tz),
    action_id = CACT.ACTION.CODE %>% as.character(),
    com_action_description = CACT.DESC %>% as.character()
  ) %>%
  dplyr::left_join(com_short, by = "com_id") %>%
  dplyr::left_join(actions, by = "action_id")

com_actions %>% DT::datatable(.)
```

## Community History, Area Decline

```{r com_history}
area_decline <- tec$AREA_DECLINE %>%
  dplyr::transmute(
    area_decline_id = AD.CODE %>% as.integer(),
    area_decline = AD.DESC %>% as.character()
  )

com_history <- tec$HISTORY %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    history_id = HIST.NO %>% as.character(),
    history_date = HIST.DATE %>% as.character(),
    area_decline_id = HIST.AD.CODE %>% as.integer(),
    comment = HIST.COMMENT %>% as.character()
  ) %>%
  dplyr::left_join(com_short, by = "com_id") %>%
  dplyr::left_join(area_decline, by = "area_decline_id")

com_history %>% DT::datatable(.)
```

## Occurrences
Occurrences seem to refer to `BDI_ID` (boundary_id), which is a PK to a bunch of GIS tables.

```{r tec_occ}
# what's that?
classifications <- tec$CLASSIFICATIONS %>%
  dplyr::transmute(
    classification_code = CLASS.CODE %>% as.character(),
    classification = CLASS.DESC %>% as.character()
  )

# Occurrence confidentiality
confidentiality <- tec$OCC_CONFIDENTIAL_CODES %>%
  dplyr::transmute(
    confidential_id = OCC.CONFIDENTIAL %>% as.integer(),
    is_confidential = OCC.CONFID.DESC %>% as.character()
  )

reliability <- tec$RELIABILITY %>% dplyr::transmute(
  reliability_id = BR.CODE %>% as.character(),
  reliability = BR.DESC %>% as.character()
)

tec_occ <- tec$OCCURRENCES %>%
  tibble::as.tibble() %>%
  dplyr::transmute(
    # IDs
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    com_id = COM.NO %>% as.integer(),
    occ_no = OCC.NO %>% as.integer(),
    source_code = OCC.SOURCE.CODE %>% as.character(),

    # spatial references
    boundary_id = BDY.ID %>% as.integer(),
    boundary_desc = OCC.BOUNDARY.DESC %>% as.character(),
    # boundary_no = OCC.NO.BOUNDARY %>% as.integer, # empty
    buffer_radius = OCC.BUFFER.RADIUS %>% as.integer(),
    original_area = OCC.ORIGINAL.AREA %>% as.double(),
    area_accuracy = OCC.AREA.ACCURACY %>% as.double(),

    # occ details
    species_desc = OCC.SPECIES.DESC %>% as.character(),
    commonwealth_desc = OCC.COMMONWEALTH.DESC %>% as.character(),
    confidential_id = OCC.CONFIDENTIAL %>% as.integer(),
    reliability_id = OCC.BR.CODE %>% as.character(),
    desc = OCC.DESC %>% as.character(),
    status_code = OCC.STATUS.CODE %>% as.logical(),
    ctrc_sys = OCC.CTRC.SYS %>% as.integer(), # FK CTRC_SYSTEMS
    ctrc_recommendation = OCC.CTRC.RECOMMENDATION %>% as.character(),
    cwealth_listing = OCC.CWEALTH.LISTING %>% as.character(),
    data = OCC.DATA %>% as.character(),
    other = OCC.OTHER %>% as.character(),
    soil = OCC.SOIL %>% as.character(),
    surf_geology = OCC.SURF.GEOLOGY %>% as.character(),
    land_element = OCC.LAND.ELEMENT %>% as.character(),
    water = OCC.WATER %>% as.character(),
    drainage = OCC.DRAINAGE %>% as.character(),
    com_structure = OCC.COM.STRUCTURE %>% as.character(),
    classification = OCC.CLASSIFICATION %>% as.character(),
    other_attr = OCC.OTHER.ATTR %>% as.character(),

    # spatial lookups
    beard_dist_code = OCC.BEARD.DIST.CODE %>% as.character(),
    beard_map_code = OCC.BEARD.MAP.CODE %>% as.character(),
    beard_desc = OCC.BEARD.DESC %>% as.character(),
    ibra_reg_code = OCC.IBRA.REG.CODE %>% as.character(),
    dola_ref = OCC.DOLA.REF %>% as.character(),
    bush_forever_site_no = OCC.BUSH.FOREVER.SITE.NO %>% as.integer(),
    zone_code = OCC.ZONE.CODE %>% as.character(),

    # audit
    created_by = USERNAME %>% as.character(),
    created_on = OCC.DATE.ENTERED %>%
      lubridate::parse_date_time(., orders = orders, tz = tz),
    changed_on = OCC.DATE.EDITED %>%
      as.character() %>%
      lubridate::parse_date_time(., orders = orders, tz = tz)
  ) %>%
  dplyr::left_join(com_short, by = "com_id") %>%
  dplyr::left_join(confidentiality, by = "confidential_id") %>%
  dplyr::left_join(reliability, by = "reliability_id") %>%
  dplyr::select(-confidential_id, reliability_id)
tec_occ %>% skimr::skim()
tec_occ %>% head(100) %>% DT::datatable(.)

# unique(occurrences$ctrc_sys) %>% sort()

occ_short <- tec_occ %>%
  dplyr::select(occ_id, boundary_id, boundary_desc, com_id, com_label, com_name)
```

## Occurrence Actions

```{r occ_actions}
occ_actions <- tec$OCCURRENCE_ACTIONS %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    occ_action_id = OACT.NO %>% as.integer(),
    occ_action_date = OACT.DATE %>% parse_date_time(., orders = orders, tz = tz),
    occ_action_description = OACT.DESC %>% as.character(),
    username = USERNAME %>% as.character(),
    action_id = OACT.ACTION.CODE %>% as.character()
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id") %>%
  dplyr::left_join(actions, by = "action_id")

occ_actions %>% DT::datatable(.)
```

## Occcurrence Recommendations
```{r occ_recommendations}
occ_recommendations <- tec$OCCURRENCE_RECOMMENDATIONS %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    rank = OREC.RANK %>% as.character(),
    recommended_on = OREC.DATE %>% as.character(),
    recommendation_code = OREC.REC.CODE %>% as.character(),
    recommendation = OREC.DESC %>% as.character(),
    username = USERNAME %>% as.character()
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id") %>%
  dplyr::left_join(recommendations, by = "recommendation_code")

occ_recommendations %>% DT::datatable(.)
```

## Occurrence Extent

```{r occ_extent}
sources <- tec$SOURCES %>%
  dplyr::transmute(
    source_code = SOURCE.CODE %>% as.character(),
    source = SOURCE.DESC %>% as.character()
  )

occ_extent <- tec$EXTENTS %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    EXT.NO = EXT.NO %>% as.character(),
    EXT.DATE = EXT.DATE %>% as.character(),
    source_code = EXT.SOURCE.CODE %>% as.character(),
    EXT.AREA = EXT.AREA %>% as.character(),
    EXT.AREA.ACC = EXT.AREA.ACC %>% as.character(),
    area_decline_id = EXT.AD.CODE %>% as.integer(),
    EXT.COMMENT = EXT.COMMENT %>% as.character(),
    USERNAME = USERNAME %>% as.character()
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id") %>%
  dplyr::left_join(sources, by = "source_code") %>%
  dplyr::left_join(area_decline, by = "area_decline_id")

occ_extent %>% DT::datatable(.)
```

## Additional Data

```{r occ_additional_data}
items <- tec$ITEMS %>%
  dplyr::transmute(
    item_code = ITEM.CODE %>% as.character(),
    item = ITEM.DESC %>% as.character()
  )

occ_additional_data <- tec$ADDITIONAL_DATA %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    additional_data_id = ADD.NO %>% as.integer(),
    item_code = ADD.ITEM.CODE %>% as.character(),
    description = ADD.DESC %>% as.character(),
    username = USERNAME %>% as.character()
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id") %>%
  dplyr::left_join(items, by = "item_code")

occ_additional_data %>% DT::datatable(.)
```

## Occcurrence Maps
Names of physical maps describing one or multiple occurrences.

```{r occ_maps}
maps <- tec$MAPS
occ_maps <- tec$OCCURRENCE_MAPS
```

## Biological Processes
```{r occ_biol_process}
occ_biol_process <- tec$BIOL_PROCESSES %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    biol_process_id = BIOL.NO %>% as.integer(),
    biol_process = BIOL.PROCESS %>% as.character(),
    username = USERNAME %>% as.character()
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id")

occ_biol_process %>% DT::datatable(.)
```

## Non-biological Processes
```{r occ_nonbiol_process}
occ_nonbiol_process <- tec$NON_BIOL_PROCESSES %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    nonbiol_process_id = NBIO.NO %>% as.integer(),
    nonbiol_process = NBIO.PROCESS %>% as.character(),
    username = USERNAME %>% as.character()
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id")

occ_nonbiol_process %>% DT::datatable(.)
```

## Fire History

```{r occ_fire_history}
fire_history <- tec$FIRE_HISTORY %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    fire_history_id = FIRE.NO %>% as.integer(),
    fire_history_date = FIRE.DATE %>% as.character(),
    fire_history_comment = FIRE.COMMENT %>% as.character(),
    username = USERNAME %>% as.character()
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id")

fire_history %>% DT::datatable(.)
```

## Fauna Occurrences
There is another separate group of occurrences:

* Occurrence Species
* Occurrence Species INI (contains an external db config)
* Occurrence Fauna
* Species Roles
* Fauna Taxa
* Fauna Groups
* Fauna Conservation Codes

What is the overlap to the Threatened Fauna DB in terms of meaning and data flow?

```{r}
# lookups
fauna_conservation_codes <- tec$FAUNA_CONSERVATION_CODES %>%
  dplyr::transmute(
    conservation_code = CONSV.CODE %>% as.character(),
    conservation_code_description = CONSV.DESC %>% as.character()
  )

fauna_groups <- tec$FAUNA_GROUPS # paraphyletic groups

species_roles <- tec$SPECIES_ROLES %>%
  dplyr::transmute(
    species_role_code = SP.ROLE.CODE %>% as.character(),
    species_role = SP.ROLE.DESC %>% as.character()
  )

fauna_taxa <- tec$FAUNA_TAXA # taxon_id

# primary
occ_fauna <- tec$OCCURRENCE_FAUNA %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    taxon_id = OF.TAXON.ID %>% as.character(),
    species_code = OF.SPCODE %>% as.character(),
    species_role_code = OF.SP.ROLE.CODE %>% as.character(),
    comments = OF.VOUCHER.NO %>% as.character(),
    username = USERNAME %>% as.character(),
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id") %>%
  dplyr::left_join(species_roles, by = "species_role_code")

occ_fauna %>% DT::datatable(.)

occ_species <- tec$OCCURRENCE_SPECIES %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    taxon_id = SPEC.TAXON.ID %>% as.character(),
    species_code = SPEC.SPCODE %>% as.character(),
    species_role_code = SPEC.SP.ROLE.CODE %>% as.character(),
    comments = SPEC.VOUCHER.NO %>% as.character(),
    username = USERNAME %>% as.character(),
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id") %>%
  dplyr::left_join(species_roles, by = "species_role_code")

occ_species %>% DT::datatable(.)
```

## Surveys
A separate group related to surveys has the tables:

* Threat Impacts
* Threats
* Surveys
* Conditions
* Survey Conditions
* Survey Threats

```{r surveys}
# lookups
impacts <- tec$THREAT_IMPACTS %>%
  dplyr::transmute(
    impact_code = IMP.CODE %>% as.character(),
    impact = IMP.DESC %>% as.character()
  )

threats <- tec$THREATS %>%
  dplyr::transmute(
    threat_code = THREAT.CODE %>% as.character(),
    threat = THREAT.DESC %>% as.character()
  )

conditions <- tec$CONDITIONS %>%
  dplyr::transmute(
    condition_code = COND.CODE %>% as.character(),
    condition = COND.DESC %>% as.character()
  )

# primary
com_threats <- tec$COMMUNITY_THREATS %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    id = CTHR.NO %>% as.character(),
    date = CTHR.DATE %>% as.character(),
    threat_code = CTHR.THREAT.CODE %>% as.character(),
    description = CTHR.DESC %>% as.character()
  ) %>%
  dplyr::left_join(threats, by = "threat_code")

surveys <- tec$SURVEYS %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    survey_id = SUR.NO %>% as.integer(),
    surveyed_on = SUR.DATE %>% as.character(),
    surveyed_by = SUR.SURVEYOR %>% as.character(),
    survey_comments = SUR.COMMENTS %>% as.character(),
    username = USERNAME %>% as.character()
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id")

survey_threats <- tec$SURVEY_THREATS %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    survey_id = SUR.NO %>% as.integer(),
    threat_rank = THR.RANK %>% as.integer(),
    threat_code = THR.THREAT.CODE %>% as.character(),
    threat_percent = THR.PERCENT %>% as.double(),
    historic_impact_code = THR.HIST.IMP.CODE %>% as.character(),
    potential_impact_code = THR.POT.IMP.CODE %>% as.character(),
    modification = THR.MODIFICATION %>% as.character(),
    comments = THR.COMMENTS %>% as.character(),
    username = USERNAME %>% as.character(),
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id") %>%
  dplyr::left_join(threats, by = "threat_code") %>%
  dplyr::left_join(impacts, by = c("historic_impact_code" = "impact_code")) %>%
  dplyr::rename(historic_impact = impact) %>%
  dplyr::left_join(impacts, by = c("potential_impact_code" = "impact_code")) %>%
  dplyr::rename(potential_impact = impact)

survey_conditions <- tec$SURVEY_CONDITIONS %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    survey_id = SUR.NO %>% as.integer(),
    condition_code = SCON.COND.CODE %>% as.character(),
    condition_percent = SCON.PERCENT %>% as.double(),
    comments = SCON.COMMENTS %>% as.character(),
    username = USERNAME %>% as.character()
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id") %>%
  dplyr::left_join(conditions, by = "condition_code")
```

## Sites

* Sites
* Datum
* Site Visits
* Site Species

```{r sites}
datum <- tec$DATUM %>%
  dplyr::transmute(
    datum_code = DATUM.CODE %>% as.character(),
    datum = DATUM.DESC %>% as.character(),
    semi_major_axis = SEMI.MAJOR.AXIS %>% as.double(),
    inverse_flattening = INVERSE.FLATTENING %>% as.double()
  )

sites <- tec$SITES %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    site_code = S.ID %>% as.character(),
    datum_code = S.DATUM.CODE %>% as.character(),
    latitude = S.LATITUDE %>% as.double(),
    longitude = S.LONGITUDE %>% as.double(),
    comments = S.COMMENTS %>% as.character(),
    # S.LATITUDE.PREF = S.LATITUDE.PREF  %>% as.character, # wtf?
    # S.LONGITUDE.PREF = S.LONGITUDE.PREF  %>% as.character, # wut?
    created_by = USERNAME %>% as.character(),
    changed_on = S.DATE.EDITED %>% parse_date_time(., orders = orders, tz = tz),
    permanently_marked = S.PERMANENTLY.MARKED %>% as.character(), # "", "Y"
    location = S.LOCATION %>% as.character(),
    habitat = S.HABITAT %>% as.character(),
    soil = S.SOIL %>% as.character(),
    # rock_type = S.ROCK.TYPE %>% as.character(), # empty
    # parent_material = S.PARENT.MATERIAL %>% as.character(), # empty
    vegetation = S.VEGETATION %>% as.character(),
    # rock_pile_notes = S.ROCK.PILE.NOTES %>% as.character(), # empty
    site_notes = S.SITE.NOTES %>% as.character()
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id") %>%
  dplyr::left_join(datum, by = "datum_code")

# sites[15000:15250,] %>% skim # CKAN datapusher chokes on this chunk

site_visit <- tec$SITE_VISITS %>%
  dplyr::transmute(
    site_visit_id = SITE.VISIT.ID %>% as.integer(),
    site_code = S.ID %>% as.character(),
    site_visit_date = SV.VISIT.DATE %>% as.character(),
    project_code = SV.PROJ.CODE %>% as.character(),
    site_visit_described_by = SV.DESCRIBED.BY %>% as.character(),
    site_visit_described_by_notes = SV.DESCRIBED.BY.NOTES %>% as.character(),
    seasonal_conditions = SV.SEASONAL.CONDITIONS %>% as.character(),
    observation_type = SV.OBSERVATION.TYPE %>% as.character(),
    observation_quality = SV.OBSERVATION.QUALITY %>% as.character(),
    plant_id_quality = SV.PLANT.ID.QUALITY %>% as.character(),
    site_dimensions = SV.SITE.DIMENSIONS %>% as.character(),
    site_uniformity = SV.SITE.UNIFORMITY %>% as.character(),
    site_status = SV.SITE.STATUS %>% as.character(),
    photo_numbers = SV.PHOTO %>% as.character(),
    vegetation_condition = SV.VEGETATION.CONDITION %>% as.character(),
    fire_age = SV.FIRE.AGE %>% as.character(),
    fire_notes = SV.FIRE.NOTES %>% as.character(),
    observation_notes = SV.OBSERVATION.NOTES %>% as.character()
  )

# coll code and number indicates voucher specimens
voucher_specimens <- tec$SITE_SPECIES %>%
  dplyr::transmute(
    site_species_id = SITE.SPECIES.ID %>% as.character(),
    site_visit_id = SITE.VISIT.ID %>% as.integer(),
    name_id = SSP.NAME.ID %>% as.character(),
    species_code = SSP.SPCODE %>% as.character(),
    height = SSP.HEIGHT %>% as.character(),
    collector_code = SSP.COLLECTOR.CODE %>% as.character(),
    collection_number = SSP.COLLECTION.NUMBER %>% as.character(),
    notes = SSP.NOTES %>% as.character()
  ) %>%
  dplyr::left_join(site_visit, by = "site_visit_id")
```

There are `r nrow(sites)` point locations known as TEC sites.

```{r sites_map, fig.height=5, fig.width=7}
leaflet(width = 800, height = 600) %>%
  addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
  addProviderTiles("OpenStreetMap.Mapnik", group = "Place names") %>%
  clearBounds() %>%
  addAwesomeMarkers(
    data = sites,
    lng = ~ longitude, lat = ~ latitude,
    icon = leaflet::makeAwesomeIcon(icon = "leaf"),
    label = ~ paste(site_code),
    popup = ~ paste(
      "<h3>Site", site_code, "</h3>",
      "<strong>Community</strong>", com_label, "<br/>",
      "<strong>Created by</strong>", created_by, "on", changed_on, "<br/>",
      "<strong>Comments</strong>", comments, "<br/>",
      "<strong>Permanent</strong>", permanently_marked, "<br/>",
      "<strong>Location</strong>", location, "<br/>",
      "<strong>Habitat</strong>", habitat, "<br/>",
      "<strong>Soil</strong>", soil, "<br/>",
      "<strong>Vegetation</strong>", vegetation, "<br/>",
      "<strong>Site notes</strong>", site_notes, "<br/>"
    ),
    group = "Site points",
    clusterOptions = markerClusterOptions()
  ) %>%
  addLayersControl(
    baseGroups = c("Aerial", "Place names"),
    overlayGroups = c("Site points"),
    options = layersControlOptions(collapsed = FALSE)
  )
```


## Gazettal
The data model of gazettals requires clarification.

```{r gazettal}
# lookups
library(magrittr)
tec_cons_categories <- tec$CATEGORY_TYPES %>%
  dplyr::transmute(
    category_code = CT.TYPE %>% as.character(),
    category_label = CT.DESC %>% as.character(),
    authority = CT.AUTHORITY.CODE %>% as.character()
  )

tec_cons_criteria <- tec$CRITERIA_CODES %>%
  dplyr::transmute(
    criterion_code = CRIT.CODE %>% as.character(),
    criterion_description = CRIT.DESC %>% as.character()
  )

# Using a built-in function to turn uppercase into lowercase? Nah. Hold my beer.
authorities <- tec$AUTHORITIES # A lookup for upper cased authorities vs lower cased authorities.
endorsement <- tec$ENDORSED_BY # another lookup for lower case.

# primary
tec_cons_listing_categories <- tec$CATEGORIES %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    effective_from = CAT.EFFECT.DATE %>% as.character(),
    category_code = CAT.CT.TYPE %>% as.character(),
    cat_comment = CAT.COMMENT %>% as.character(),
    cat_review_date = CAT.REVIEW.DATE %>% as.character(),
    cat_endorsed_code = CAT.ENDORSED.CODE %>% as.character(),
    cat_endorsed_date = CAT.ENDORSED.DATE %>% as.character(),
    cat_endorsed_by_minister = CAT.ENDORSED.BY.MINISTER %>% as.character()
  ) %>%
  dplyr::left_join(com_short, by = "com_id") %>%
  dplyr::left_join(tec_cons_categories, by = "category_code")

tec_cons_listing_criteria <- tec$CATEGORY_CRITERIA %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    effective_from = CAT.EFFECT.DATE %>% as.character(),
    criterion_code = CC.CRIT.CODE %>% as.character()
  ) %>%
  dplyr::left_join(com_short, by = "com_id") %>%
  dplyr::left_join(tec_cons_criteria, by = "criterion_code")
# join com_short, criteria codes
```

## Recovery Plans

```{r recovery_plans}
recovery_plans <- tec$INTERIM_RECOVERY_PLANS %>%
  dplyr::transmute(
    recovery_plan_id = IRP.NO %>% as.character(),
    com_id = COM.NO %>% as.integer(),
    endorsed_on = IRP.DATE.ENDORSED %>% parse_date_time(., orders = orders, tz = tz),
    ends_on = IRP.END.DATE %>% parse_date_time(., orders = orders, tz = tz),
    author = IRP.AUTHOR %>% as.character(),
    reviewed_on = IRP.DATE.REVIEWED %>% parse_date_time(., orders = orders, tz = tz),
    comments = IRP.COMMENTS %>% as.character()
  ) %>%
  dplyr::left_join(com_short, by = "com_id")
# make_coldef(recovery_plans)
recovery_plans %>% skim()
```

## TEC data upload
Create resource once-off to get a resource ID.
Also upload the compiled workbook.
Note, this process lags one compilation of this workbook, as the HTML output
is generated after the R code is run - knit a workbook twice to update the data catalogue.

```{r tec_upload}
d <- ckanr::package_show("threatened-ecological-communities-database")
# ckanr::resource_update("80009375-19e2-45d3-a1ae-068143fa03a5", "data_etl_tec.html") # HTML, not CSV
upload_to_ckan(communities, "Threatened Ecological Communities (TEC)", 
               d$id, resource_id = "9782cc52-7be8-494a-a7da-51845c119a21")
upload_to_ckan(tec_occ, "TEC Occurrences", 
               d$id, resource_id = "65f43392-a8c5-41e2-a31e-cc4135e9274e")
upload_to_ckan(sites, "TEC Site Points", 
               d$id, resource_id = "bf4c2973-e549-408b-a583-013052072d6c")
upload_to_ckan(com_recommendations, "TEC Recommendations", 
               d$id, resource_id = "fd96a053-523c-401d-8755-9116c55f5744")
upload_to_ckan(com_publications, "TEC Publications", 
               d$id, resource_id = "fa51cd96-864a-4c43-a0e1-fc24621bb628")
upload_to_ckan(com_reviews, "TEC Reviews", 
               d$id, resource_id = "7c39b584-bc4b-4234-aff7-ddf4808692ed")
upload_to_ckan(com_actions, "TEC Actions", 
               d$id, resource_id = "17d3c4e2-df98-4ff6-9d4d-99ba54808bb4")
upload_to_ckan(com_history, "TEC History", 
               d$id, resource_id = "479d7358-d42d-4c4b-93ee-1bac39d21024")
upload_to_ckan(occ_actions, "TEC Occurrence Actions", 
               d$id, resource_id = "25894a68-11de-4a58-b521-6a9abd06ee40")
upload_to_ckan(occ_recommendations, "TEC Occurrence Recommendations", 
               d$id, resource_id = "747464e4-2434-459a-b654-52861b37095c")
upload_to_ckan(occ_extent, "TEC occurrence extent", 
               d$id, resource_id = "502c74d7-32be-453f-aff6-c50aedd3deed")
upload_to_ckan(occ_additional_data, "TEC occurrence additional data", 
               d$id, resource_id = "8dd3454c-1bf0-4575-adcb-154b700c4283")
upload_to_ckan(occ_biol_process, "TEC biological process", 
               d$id, resource_id = "5805a671-576a-4077-b595-35ca96d7ca96")
upload_to_ckan(occ_nonbiol_process, "TEC nonbiological process", 
               d$id, resource_id = "a5341117-2735-4694-8cd4-e806f4c06668")
upload_to_ckan(fire_history, "TEC fire history", 
               d$id, resource_id = "e062f57e-f6aa-4403-a682-875dab2f77f6")
upload_to_ckan(occ_fauna, "TEC occurence fauna", 
               d$id, resource_id = "a0eddc66-5fef-4252-b49f-691422a88f28")
upload_to_ckan(occ_species, "TEC occurence species", 
               d$id, resource_id = "e94f1e35-30da-4982-b851-ceb888eb41b3")
upload_to_ckan(com_threats, "TEC community threats", 
               d$id, resource_id = "5426c45b-1dee-4547-a6e3-bec81585e52e")
upload_to_ckan(survey_threats, "TEC survey threats", 
               d$id, resource_id = "5b795656-a240-402e-92b8-edbe54b3fee8")
upload_to_ckan(site_visit, "TEC site visit", 
               d$id, resource_id = "85cef94b-d12e-4aff-bd24-446d1c0757db")
upload_to_ckan(voucher_specimens, "TEC voucher specimens", 
               d$id, resource_id = "6b8fe493-8183-4fe8-a91a-67a569bf9c46")
upload_to_ckan(tec_cons_listing_categories, "TEC Conservation Listing Categories", 
               d$id, resource_id = "f0085651-8c38-496e-a6bd-1adc7ae2f06a")
upload_to_ckan(tec_cons_listing_criteria, "TEC Conservation Listing Criteria", 
               d$id, resource_id = "9483f333-97fd-4975-a799-d44bf8bd252a")
```


