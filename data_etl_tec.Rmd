---
title: "Data ETL: TEC"
author: "Florian Mayer, DBCA"
date: "`r Sys.time()`"
always_allow_html: yes
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# devtools::install_github("ropenscilabs/skimr")
# devtools::install_github("tidyverse/readr")
# install from github: "brianb/mdbtools"
# devtools::install_github("ropensci/ckanr")
library(tidyverse)
library(lubridate)
library(skimr)
library(leaflet)
library(Hmisc)
library(ckanr)

# Configure ckanr to data.dpaw.wa.gov.au
ckanr::ckanr_setup(
  url = Sys.getenv("CKAN_URL"),
  key = Sys.getenv("CKAN_API_KEY")
)

#' Download, extract and open a zipped Access database from a CKAN dataset
#'
#' @param resource_id The CKAN resource ID of a zipped Access DB
#' @param destdir The local destination directory for the extracted file,
#'  will be created if not existing. Default: "data"
#' @param dateformat The parameter dateformat for Hmisc::mdb.get(),
#'  default: '%Y-%m-%d'
#' @param asis The parameter as.is for Hmisc::mdb.get(), default: TRUE
#' @returns The Hmisc::mdb.get connection
dl_mdbzip <- function(resource_id,
                      destdir="data",
                      dateformat = "%m-%d-%Y",
                      asis = TRUE) {
  dir.create(file.path(getwd(), destdir), showWarnings = FALSE)
  tmp <- tempfile()
  res_url <- ckanr::resource_show(resource_id)$url
  utils::download.file(res_url, tmp)
  dbfile <- utils::unzip(tmp, exdir = destdir)
  con <- Hmisc::mdb.get(dbfile, dateformat = dateformat, as.is = asis)
  unlink(tmp)
  con
}
```

# Conventions
The following conventions shall be used to create table and column names in this ETL process.

* All names shall be snake_case, i.e. lower cased and underscore-separated.
* Primary key (PK) columns in lookup tables shall be prefixed by the table name. 
  This facilitates joining multiple lookups using unambiguous column names.
* Numeric PKs shall be named `_id`.
* Alphanumeric PKs (containing characters) shall be named `_code`.
* Abbreviations shall be avoided largely, with the exception of the ubiquitous 
  community (`com`) and occurrence (`occ`).

* All primary tables shall be joined to their lookup tables, and legacy lookup ID / code shall be discarded.
* Tables holding obsolete or duplicate data will be discarded.

# SCB data background
[TEC dataset](https://data.dpaw.wa.gov.au/dataset/threatened-ecological-communities-database)
on the [departmental data catalogue](https://data.dpaw.wa.gov.au/).

# TEC

## TEC data load
```{r tec_data_load}
tec <- dl_mdbzip("598b1e70-5707-4dbc-a665-1189e1524ebe")
# tec_app <- dl_mdbzip("27d9b026-6933-4516-acf6-41edc6134adb")
```

## Helpers
```{r helpers}
# Date conventions
orders <- c("mdyHMS")
tz <- "Australia/Perth"

# Prepare column def
as_def <- . %>% paste(., "=", ., " %>% as.character, \n")
make_coldef <- . %>% names() %>% purrr::map(as_def) %>% unlist() %>% cat()
```

## Configuration
Some tables store legacy configuration data. We won't need or import them.

* Settings: Datum preference
* Sp Master INI old: external db config
* mddDataTables/columns: external db tables
* mddMasterLists: external db config
* mddReportItems (empty)

## Taxonomy

* WA_* WACensus data copies
* jhb
* SPMASTER_OLD, Flora conservation codes
* Fauna taxa, Fauna conservation codes, Fauna Groups, Occ Fauna, Occ species, Species roles

TODO how are taxonomy tables linked? Which one is the current master one?

## Spatial lookups
There are several groups of spatial entities which are maintained outside of the SCB ecosystem.
The link to WSCB entities can be inferred unambiguously through geospatial location and cached for performance.

* IBRA regions
* Beard: Districts within Regions within Provinces
* CALM: Occurrences within Districts within Regions. How are the occurrences inferred / added?
* CALM District Users
* DOLA locations
* Bush forever sites
* Zones (three broad zones in WA: rangelands, wheatbelt, southwest non-wheatbelt)
* Land use: Land Use, Land Use Codes, Occurrence Surr(?) Codes
* Tenures: Purposes, Tenure Types, Tenures, Occurrence Tenures, Occurrence Shires, Shires
* Maps: Maps, Occurrence Maps

```{r spatial_lookups, echo=FALSE}
# calm_regions <- tec$CALM_REGIONS
# calm_districts <- tec$CALM_DISTRICTS
# calm_district_occurrences <- tec$DISTRICTS
```

## GIS exports
Some tables refer to externally managed spatial data:

* GIS_*
* Boundaries

## Spatial concepts
* Each occurrence lies within a `boundary` polygon.
* Not all occurrences have recorded boudaries.
* Boundaries (where existing) are buffered by a distance (default 500m) into a `buffer` polygon.
* Some buffers are reconstructed from a point plus a circular buffer, where boundaries are missing.
* There is one buffer for each occurrence.
* Point observations are somewhat misleadingly named `site`.
* Sites can serve:

  * To name a boundary
  * To create a buffer
  * To reference a point observation
  * To reference a terrestrial quadrat (default 10m x 10m) which is surveyed for species occurrences
* Some boundaries contain multiple sites.

There are 122970 sites, 120118 boundaries, and 121366 buffers.

TODO Wendy to upload zip archives of boundary, buffer and site shapefiles to the data catalogue.
Florian to convert each to GeoJSON.

## Communities
Abbreviation: `com`

```{r communities}
former_range <- tec$FORMER_RANGES %>%
  dplyr::transmute(
    former_range_code = FORMER.RANGE %>% as.character(),
    former_range = FORMER.RANGE.DESC %>% as.character()
  )
# make_coldef(former_range)

range_decline <- tec$RANGE_DECLINE %>%
  dplyr::transmute(
    range_decline_id = RANGE.DECLINE %>% as.integer(),
    range_decline = RANGE.DECLINE.DESC %>% as.character()
  )
# make_coldef(range_decline)

occ_decline <- tec$OCCURRENCES_DECLINE %>%
  dplyr::transmute(
    occ_decline_id = OCC.DECLINE %>% as.integer(),
    occ_decline = OCC.DECLINE.DESC %>% as.character()
  )
# make_coldef(occ_decline)

status <- tec$STATUS %>%
    dplyr::transmute(
        status_code = STATUS.CODE  %>% as.character, 
        status = STATUS.DESC  %>% as.character
    )
# status %>% make_coldef()
# unique(status$status_code) # "BELIEVED"   "IDENTIFIED" - where used?

communities <- tec$COMMUNITIES %>%
  tibble::as.tibble() %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    com_label = COM.ID %>% as.character(),
    com_name = COM.NAME %>% as.character(),
    com_description = COM.DESC %>% as.character(),
    former_range_code = COM.FORMER.RANGE %>% as.character(),
    range_decline_id = COM.RANGE.DECLINE %>% as.integer(),
    occ_decline_id = COM.OCC.DECLINE %>% as.integer(),
    com_tec_listing = COM.TEC.LISTING %>% as.integer(),
    com_original_area = COM.ORIG.AREA %>% as.double(),
    com_area_accuracy = COM.AREA.ACC %>% as.double(),
    preliminary = COM.PRELIMINARY %>% as.character(),
    status = COM.STATUS %>% as.character()
  ) %>%
  dplyr::left_join(former_range, by = "former_range_code") %>%
  dplyr::left_join(range_decline, by = "range_decline_id") %>%
  dplyr::left_join(occ_decline, by = "occ_decline_id") %>%
    dplyr::select(-former_range_code, -range_decline_id, -occ_decline_id)
# make_coldef(communities)
communities %>% skim()
communities %>% DT::datatable(.)

com_short <- communities %>%
  dplyr::select(com_id, com_label, com_name)


# history, area decline, extents

```

## Community Recommendations

```{r com_recommendations}
recommendations <- tec$RECOMMENDATIONS
com_recommendations <- tec$COMMUNITY_RECOMMENDATIONS
```
TODO


## Community Publications

```{r com_publications}
publications <- tec$PUBLICATIONS %>%
  dplyr::transmute(
    publication_id = PUB.NO %>% as.integer(),
    title = PUB.TITLE %>% as.character(),
    author = PUB.AUTHOR %>% as.character()
    # empty:
    # published_on = PUB.DATE %>% parse_date_time(., orders = orders, tz = tz),
    # published_with = PUB.PLACE %>% as.character()
  )
# make_coldef(publications)

community_publications <- tec$COMMUNITY_PUBLICATIONS %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    publication_id = CP.PUB.NO %>% as.integer(),
  ) %>%
  dplyr::left_join(publications, by = "publication_id") %>%
  dplyr::left_join(com_short, by = "com_id")
# make_coldef(community_publications)
community_publications %>% skim()
community_publications %>% DT::datatable(.)
```

## Community Reviews

```{r com_reviews}
reviews <- tec$REVIEWS %>%
  dplyr::transmute(
    review_id = REV.NO %>% as.integer(),
    review_date = REV.DATE %>% parse_date_time(., orders = orders, tz = tz),
    review_panel = REV.PANEL %>% as.character()
  )
# reviews %>% make_coldef()
reviews %>% skim()

community_reviews <- tec$COMMUNITY_REVIEWS %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    review_id = CR.REV.NO %>% as.integer()
  ) %>%
  dplyr::left_join(com_short, by = "com_id") %>%
  dplyr::left_join(reviews, by = "review_id")
# community_reviews %>% make_coldef()
community_reviews %>% skim()
community_reviews %>% DT::datatable(.)
```

## Community Actions
Are `COMMUNITY_ACTIONS` related to `ACTIONS`?

```{r com_actions}
actions <- tec$ACTIONS %>% 
    dplyr::transmute(
        action_id = ACTION.CODE  %>% as.character, 
        description = ACTION.DESC  %>% as.character
)
# actions %>% make_coldef()

com_actions <- tec$COMMUNITY_ACTIONS %>%
  dplyr::transmute(
    com_id = COM.NO %>% as.integer(),
    com_action_id = CACT.NO %>% as.integer(),
    com_action_date = CACT.DATE %>% parse_date_time(., orders = orders, tz = tz),
    action_id = CACT.ACTION.CODE %>% as.character(),
    com_action_description = CACT.DESC %>% as.character()
  ) %>%
  dplyr::left_join(com_short, by = "com_id") %>%
  dplyr::left_join(actions, by = "action_id")
# com_actions %>% make_coldef()
com_actions %>% skim()
com_actions %>% DT::datatable(.)
```

## Community History, Area Decline

```{r com_history}
area_decline <- tec$AREA_DECLINE %>% 
    dplyr::transmute(
        area_decline_id = AD.CODE  %>% as.integer(), 
        area_decline = AD.DESC  %>% as.character
    )
# area_decline %>% make_coldef()

com_history <- tec$HISTORY # join to area decline

```

## Occurrences
Occurrences seem to refer to `BDI_ID` (boundary_id), which is a PK to a bunch of GIS tables.

```{r occ}
# what's that?
classifications <- tec$CLASSIFICATIONS

# Occurrence confidentiality
confidentiality <- tec$OCC_CONFIDENTIAL_CODES %>% 
    dplyr::transmute(
        confidential_id = OCC.CONFIDENTIAL  %>% as.integer(), 
        is_confidential = OCC.CONFID.DESC  %>% as.character()
)
# confidential %>% make_coldef()

reliability <- tec$RELIABILITY %>% dplyr::transmute(
    reliability_id = BR.CODE  %>% as.character, 
    reliability = BR.DESC  %>% as.character
)
# reliability %>% make_coldef()

occurrences <- tec$OCCURRENCES %>%
  tibble::as.tibble() %>%
  dplyr::transmute(
    # IDs
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    com_id = COM.NO %>% as.integer(),
    occ_no = OCC.NO %>% as.integer(),
    source_code = OCC.SOURCE.CODE %>% as.character(),

    # spatial references
    boundary_id = BDY.ID %>% as.integer(),
    boundary_desc = OCC.BOUNDARY.DESC %>% as.character(),
    # boundary_no = OCC.NO.BOUNDARY %>% as.integer, # empty
    buffer_radius = OCC.BUFFER.RADIUS %>% as.integer(),
    original_area = OCC.ORIGINAL.AREA %>% as.double(),
    area_accuracy = OCC.AREA.ACCURACY %>% as.double(),

    # occ details
    species_desc = OCC.SPECIES.DESC %>% as.character(),
    commonwealth_desc = OCC.COMMONWEALTH.DESC %>% as.character(),
    confidential_id = OCC.CONFIDENTIAL %>% as.integer(),
    reliability_id = OCC.BR.CODE %>% as.character(),
    desc = OCC.DESC %>% as.character(),
    status_code = OCC.STATUS.CODE %>% as.logical(),
    ctrc_sys = OCC.CTRC.SYS %>% as.integer(), # FK CTRC_SYSTEMS
    ctrc_recommendation = OCC.CTRC.RECOMMENDATION %>% as.character(),
    cwealth_listing = OCC.CWEALTH.LISTING %>% as.character(),
    data = OCC.DATA %>% as.character(),
    other = OCC.OTHER %>% as.character(),
    soil = OCC.SOIL %>% as.character(),
    surf_geology = OCC.SURF.GEOLOGY %>% as.character(),
    land_element = OCC.LAND.ELEMENT %>% as.character(),
    water = OCC.WATER %>% as.character(),
    drainage = OCC.DRAINAGE %>% as.character(),
    com_structure = OCC.COM.STRUCTURE %>% as.character(),
    classification = OCC.CLASSIFICATION %>% as.character(),
    other_attr = OCC.OTHER.ATTR %>% as.character(),

    # spatial lookups
    beard_dist_code = OCC.BEARD.DIST.CODE %>% as.character(),
    beard_map_code = OCC.BEARD.MAP.CODE %>% as.character(),
    beard_desc = OCC.BEARD.DESC %>% as.character(),
    ibra_reg_code = OCC.IBRA.REG.CODE %>% as.character(),
    dola_ref = OCC.DOLA.REF %>% as.character(),
    bush_forever_site_no = OCC.BUSH.FOREVER.SITE.NO %>% as.integer(),
    zone_code = OCC.ZONE.CODE %>% as.character(),

    # audit
    created_by = USERNAME %>% as.character(),
    created_on = OCC.DATE.ENTERED %>%
      lubridate::parse_date_time(., orders = orders, tz = tz),
    changed_on = OCC.DATE.EDITED %>%
      as.character() %>%
      lubridate::parse_date_time(., orders = orders, tz = tz)
  ) %>%
  dplyr::left_join(com_short, by = "com_id") %>%
  dplyr::left_join(confidentiality, by = "confidential_id") %>%
    dplyr::left_join(reliability, by = "reliability_id") %>%
  dplyr::select(-confidential_id, reliability_id)
occurrences %>% skimr::skim()
occurrences %>% head(100) %>% DT::datatable(.)

# unique(occurrences$ctrc_sys) %>% sort()

occ_short <- occurrences %>% dplyr::select(
  occ_id, boundary_id, boundary_desc, com_id, com_label, com_name
)
```

## Occurrence Actions

```{r occ_actions}
occ_actions <- tec$OCCURRENCE_ACTIONS %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    occ_action_id = OACT.NO %>% as.integer(),
    occ_action_date = OACT.DATE %>% parse_date_time(., orders = orders, tz = tz),
    occ_action_description = OACT.DESC %>% as.character(),
    username = USERNAME %>% as.character(),
    action_id = OACT.ACTION.CODE %>% as.character()
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id") %>%
  dplyr::left_join(actions, by = "action_id")
# occ_actions %>% make_coldef()
occ_actions %>% DT::datatable(.)
```

## Occcurrence Recommendations
```{r occ_recommendations}
occ_recommendations <- tec$COMMUNITY_RECOMMENDATIONS
```
TODO see `com_recommendations`

## Occurrence Extent

```{r occ_extent}
sources <- tec$SOURCES
occ_extent <- tec$EXTENTS # join area decline, sources, occ_short

```

## Additional Data

```{r occ_additional_data}
items <- tec$ITEMS
occ_additional_data <- tec$ADDITIONAL_DATA
```
TODO

## Occcurrence Maps

```{r occ_maps}
maps <- tec$MAPS
occ_maps <- tec$OCCURRENCE_MAPS
```
TODO

## Biological Processes
```{r occ_biol_process}
occ_biol_process <- tec$BIOL_PROCESSES
```

## Non-biological Processes
```{r occ_nonbiol_process}
occ_nonbiol_process <- tec$NON_BIOL_PROCESSES
```

## Fire History

```{r occ_fire_history}
fire_history <- tec$FIRE_HISTORY
```

## Fauna Occurrences
There is another separate group of occurrences:

* Occurrence Species
* Occurrence Species INI (contains an external db config)
* Occurrence Fauna
* Species Roles
* Fauna Taxa
* Fauna Groups
* Fauna Conservation Codes

What is the overlap to the Threatened Fauna DB in terms of meaning and data flow?

```{r}
# lookups
fauna_conservation_codes <- tec$FAUNA_CONSERVATION_CODES
fauna_groups <- tec$FAUNA_GROUPS
species_roles <- tec$SPECIES_ROLES

# primary
fauna_taxa <- tec$FAUNA_TAXA
occ_fauna <- tec$OCCURRENCE_FAUNA # join occ_short, fauna_taxa, species roles
occ_species <- tec$OCCURRENCE_SPECIES # join occ_hort, taxon id (where?), species roles
```

## Surveys
A separate group related to surveys has the tables:

* Threat Impacts
* Threats
* Surveys
* Conditions
* Survey Conditions
* Survey Threats

```{r surveys}
# lookups
impacts <- tec$THREAT_IMPACTS
threats <- tec$THREATS
conditions <- tec$CONDITIONS

# primary
com_threats <- tec$COMMUNITY_THREATS # join threats
surveys <- tec$SURVEYS # join occ_short
survey_threats <- tec$SURVEY_THREATS # join survey, threat, impact (x2)
survey_conditions <- tec$SURVEY_CONDITIONS # join survey, condition
```

## Sites

* Sites
* Datum
* Site Visits
* Site Species

```{r sites}
datum <- tec$DATUM


sites <- tec$SITES %>%
  dplyr::transmute(
    occ_id = OCC.UNIQUE.ID %>% as.integer(),
    label = S.ID %>% as.character(),
    datum = S.DATUM.CODE %>% as.character(),
    latitude = S.LATITUDE %>% as.double(),
    longitude = S.LONGITUDE %>% as.double(),
    comments = S.COMMENTS %>% as.character(),
    # S.LATITUDE.PREF = S.LATITUDE.PREF  %>% as.character, # wtf?
    # S.LONGITUDE.PREF = S.LONGITUDE.PREF  %>% as.character, # wut?
    created_by = USERNAME %>% as.character(),
    changed_on = S.DATE.EDITED %>% parse_date_time(., orders = orders, tz = tz),
    permanently_marked = S.PERMANENTLY.MARKED %>% as.character(), # "", "Y"
    location = S.LOCATION %>% as.character(),
    habitat = S.HABITAT %>% as.character(),
    soil = S.SOIL %>% as.character(),
    # rock_type = S.ROCK.TYPE %>% as.character(), # empty
    # parent_material = S.PARENT.MATERIAL %>% as.character(), # empty
    vegetation = S.VEGETATION %>% as.character(),
    # rock_pile_notes = S.ROCK.PILE.NOTES %>% as.character(), # empty
    site_notes = S.SITE.NOTES %>% as.character()
  ) %>%
  dplyr::left_join(occ_short, by = "occ_id")
# sites %>% make_coldef
# sites %>% skim

# sites[15000:15250,] %>% skim # CKAN datapusher chokes on this chunk

site_visit <- tec$SITE_VISITS

# coll code and number indicates voucher specimens
voucher_specimens <- tec$SITE_SPECIES # join site_visit, taxonomy (which?)
```

There are `r nrow(sites)` point locations known as TEC sites.

```{r sites_map, fig.height=5, fig.width=7}
leaflet(width = 800, height = 600) %>%
  addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
  addProviderTiles("OpenStreetMap.Mapnik", group = "Place names") %>%
  clearBounds() %>%
  addAwesomeMarkers(
    data = sites,
    lng = ~ longitude, lat = ~ latitude,
    icon = leaflet::makeAwesomeIcon(icon = "leaf"),
    label = ~ paste(label),
    popup = ~ paste(
      "<h3>Site", label, "</h3>",
      "<strong>Community</strong>", com_label, "<br/>",
      "<strong>Created by</strong>", created_by, "on", changed_on, "<br/>",
      "<strong>Comments</strong>", comments, "<br/>",
      "<strong>Permanent</strong>", permanently_marked, "<br/>",
      "<strong>Location</strong>", location, "<br/>",
      "<strong>Habitat</strong>", habitat, "<br/>",
      "<strong>Soil</strong>", soil, "<br/>",
      "<strong>Vegetation</strong>", vegetation, "<br/>",
      "<strong>Site notes</strong>", site_notes, "<br/>"
    ),
    group = "Site points",
    clusterOptions = markerClusterOptions()
  ) %>%
  addLayersControl(
    baseGroups = c("Aerial", "Place names"),
    overlayGroups = c("Site points"),
    options = layersControlOptions(collapsed = FALSE)
  )
```


## Gazettal
The data model of gazettals requires clarification.

```{r gazettal}
# lookups
category_type <- tec$CATEGORY_TYPES
authorities <- tec$AUTHORITIES # where used?
criteria_codes <- tec$CRITERIA_CODES
endorsement <- tec$ENDORSED_BY

# primary
categories <- tec$CATEGORIES # join com_short, cat type, endorsement
category_criteria <- tec$CATEGORY_CRITERIA # join com_short, criteria codes
```

## Recovery Plans

```{r recovery_plans}
recovery_plans <- tec$INTERIM_RECOVERY_PLANS %>%
  dplyr::transmute(
    recovery_plan_id = IRP.NO %>% as.character(),
    com_id = COM.NO %>% as.integer(),
    endorsed_on = IRP.DATE.ENDORSED %>% parse_date_time(., orders = orders, tz = tz),
    ends_on = IRP.END.DATE %>% parse_date_time(., orders = orders, tz = tz),
    author = IRP.AUTHOR %>% as.character(),
    reviewed_on = IRP.DATE.REVIEWED %>% parse_date_time(., orders = orders, tz = tz),
    comments = IRP.COMMENTS %>% as.character()
  ) %>%
  dplyr::left_join(com_short, by = "com_id")
# make_coldef(recovery_plans)
recovery_plans %>% skim()
```

## TEC data upload
Create resource once-off to get a resource ID.
Subsequently, upload the compiled workbook.
Note, this process lags one compilation of this workbook, as the HTML output
is generated after the R code is run.

```{r tec_upload}
d <- ckanr::package_show("threatened-ecological-communities-database")

etl_title <- "TEC Data ETL"
etl_fn <- "data_etl_tec.html"
# r <- ckanr::resource_create(package_id = d$id, format = "html", name = etl_title, upload = etl_fn)
# etl_rid <- r$id
etl_rid <- "80009375-19e2-45d3-a1ae-068143fa03a5"
ckanr::resource_update(etl_rid, etl_fn)

com_title <- "Threatened Ecological Communities"
com_fn <- "data/communities.csv"
communities %>% write_delim(com_fn, delim = ",")
# r <- ckanr::resource_create(package_id = d$id, format = "csv", name = com_title, upload = com_fn)
# com_rid <- r$id
com_rid <- "9782cc52-7be8-494a-a7da-51845c119a21"
ckanr::resource_update(com_rid, com_fn)

occ_title <- "Threatened Ecological Community Occurrences"
occ_fn <- "data/occurrences.csv"
occurrences %>% write_delim(occ_fn, delim = ",")
# r <- ckanr::resource_create(package_id = d$id, format = "csv", name = occ_title, upload = occ_fn)
# occ_rid <- r$id
occ_rid <- "65f43392-a8c5-41e2-a31e-cc4135e9274e"
ckanr::resource_update(occ_rid, occ_fn)

sit_title <- "Threatened Ecological Community Site Points"
sit_fn <- "data/site_points.csv"
sites %>% write_delim(sit_fn, delim = ",")
# r <- ckanr::resource_create(package_id = d$id, format = "csv", name = sit_title, upload = sit_fn)
sit_rid <- "bf4c2973-e549-408b-a583-013052072d6c"
ckanr::resource_update(sit_rid, sit_fn)

cpu_title <- "Threatened Ecological Community Publications"
cpu_fn <- "data/community_publications.csv"
community_publications %>% write_delim(cpu_fn, delim = ",")
# r <- ckanr::resource_create(package_id = d$id, format = "csv", name = cpu_title, upload = cpu_fn)
# cpu_rid <- r$id
cpu_rid <- "fa51cd96-864a-4c43-a0e1-fc24621bb628"
ckanr::resource_update(cpu_rid, cpu_fn)

cr_title <- "Threatened Ecological Community Reviews"
cr_fn <- "data/community_reviews.csv"
community_reviews %>% write_delim(cr_fn, delim = ",")
# r <- ckanr::resource_create(package_id = d$id, format = "csv", name = cr_title, upload = cr_fn)
# cr_rid <- r$id
cr_rid <- "7c39b584-bc4b-4234-aff7-ddf4808692ed"
ckanr::resource_update(cr_rid, cr_fn)

ca_title <- "Threatened Ecological Community Actions"
ca_fn <- "data/community_actions.csv"
com_actions %>% write_delim(ca_fn, delim = ",")
# r <- ckanr::resource_create(package_id = d$id, format = "csv", name = ca_title, upload = ca_fn)
# ca_rid <- r$id
ca_rid <- "17d3c4e2-df98-4ff6-9d4d-99ba54808bb4"
ckanr::resource_update(ca_rid, ca_fn)

oa_title <- "Threatened Ecological Occurrence Actions"
oa_fn <- "data/occurrence_actions.csv"
occ_actions %>% write_delim(oa_fn, delim = ",")
r <- ckanr::resource_create(package_id = d$id, format = "csv", name = oa_title, upload = oa_fn)
oa_rid <- "25894a68-11de-4a58-b521-6a9abd06ee40"
ckanr::resource_update(oa_rid, oa_fn)
```

