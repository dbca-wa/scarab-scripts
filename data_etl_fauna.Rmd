---
title: "Data ETL: Fauna"
author: "Florian Mayer, DBCA"
date: "`r Sys.time()`"
always_allow_html: yes
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# devtools::install_github("ropenscilabs/skimr")
# devtools::install_github("tidyverse/readr")
# install from github: "brianb/mdbtools"
# devtools::install_github("ropensci/ckanr")
library(tidyverse)
library(lubridate)
library(skimr)
library(leaflet)
library(Hmisc)
library(ckanr)

# Configure ckanr to data.dpaw.wa.gov.au
ckanr::ckanr_setup(
  url = Sys.getenv("CKAN_URL"),
  key = Sys.getenv("CKAN_API_KEY")
)

#' Download, extract and open a zipped Access database from a CKAN dataset
#'
#' @param resource_id The CKAN resource ID of a zipped Access DB
#' @param destdir The local destination directory for the extracted file,
#'  will be created if not existing. Default: "data"
#' @param dateformat The parameter dateformat for Hmisc::mdb.get(),
#'  default: '%Y-%m-%d'
#' @param asis The parameter as.is for Hmisc::mdb.get(), default: TRUE
#' @returns The Hmisc::mdb.get connection
dl_mdbzip <- function(resource_id,
                      destdir="data",
                      dateformat = "%Y-%m-%d",
                      asis = TRUE) {
  dir.create(file.path(getwd(), destdir), showWarnings = FALSE)
  tmp <- tempfile()
  res_url <- ckanr::resource_show(resource_id)$url
  utils::download.file(res_url, tmp)
  dbfile <- utils::unzip(tmp, exdir = destdir)
  unlink(tmp)
  con <- Hmisc::mdb.get(dbfile, dateformat = dateformat, as.is = asis)
  con
}
```
# SCB data background
[Fauna dataset](https://data.dpaw.wa.gov.au/dataset/threatened-and-priority-fauna-database) 
on the [departmental data catalogue](https://data.dpaw.wa.gov.au/).

# Fauna

## Fauna data load
The zip archive containing the MS Access database is downloaded from the data 
catalogue, the archive is extracted, and a database connection is opened.

```{r fauna_data_load}
fauna_app <- dl_mdbzip("fb5869a9-61d2-4320-bae2-3c6e4ea3f73f")
fauna_data <- dl_mdbzip("66efb68d-8f05-4bfc-af14-5d1a381d0cf2")
```

Some helpers are defined.

```{r etl_helpers}
# Date conventions
orders <- c("mdyHMS")
tz <- "Australia/Perth"

# Prepare column def
as_def <- . %>% paste(., " = ", ., " %>% as.character, \n")
# fnames <- fauna_data$`Fauna Records` %>% names
# fnames %>% purrr::map(as_def) %>% unlist %>% cat
```

## Lookup tables
Lookup table columns are renamed to facilitate joining.

```{r lookup_tables}
# Lookup tables
shires <- fauna_data$Shires %>%
  dplyr::transmute(
    lga_id = LGACode %>% as.integer(),
    shire_name = LGAName %>% as.character(),
    shire_label = LGAName2 %>% as.character()
  )

tenure <- fauna_data$`Land Tenure` %>%
  dplyr::transmute(
    tenure_id = TenCode %>% as.character(),
    tenure = Tenure %>% as.character()
  )

vegetation_types <- fauna_data$`Vegetation Types` %>%
  dplyr::mutate(
    vegetation_type_id = VegCode %>% as.character(),
    vegetation_type = VegTypeName %>% as.character()
  )

certainty <- fauna_data$Certainty %>%
  dplyr::transmute(
    certainty_id = Code %>% as.integer(),
    certainty = Certainty %>% as.character()
  ) 
```

## Fauna occurrence
Fauna data is parsed into matching data types, dates are recognised, and lookup
values are joined while lookup IDs are retained to facilitate later data ingestion
into other systems.

Legacy column names are capitalised, while new or reformatted column are lower-cased.

```{r fauna_occurrence}
# Species occurrence: fauna encounters
fauna_raw <- fauna_data$`Fauna Records`
fauna <- fauna_raw %>%
  dplyr::transmute(
    id = DBNo %>% as.integer(),
    dist_db = DistDB %>% as.integer(),
    dist_db_no = DistDBNo %>% as.character(),
    species_id = SpCode %>% as.character(),
    # name_id = NameId %>% as.character(), # they're all NA
    o_date = parse_date_time(Date, orders = orders, tz = tz),
    o_time = parse_date_time(Time, orders = orders, tz = tz),
    date = with_tz(o_date + hours(hour(o_time)) + minutes(minute(o_time)), tzone = tz),
    observer_name = Observer %>% as.character(),
    observer_role = OrgRole %>% as.character(),
    observer_address = Address %>% as.character(),
    observer_phone = Phone %>% as.character(),
    certainty_id = Certainty %>% as.integer(),
    number_seen = NumSeen %>% as.integer(),
    animal_features = Features %>% as.character(),
    number_adult_males = AdultM %>% as.integer(),
    number_adult_females = AdultF %>% as.integer(),
    number_adult_unknown = AdultU %>% as.integer(),
    number_juvenile_males = JuvM %>% as.integer(),
    number_juvenile_females = JuvF %>% as.integer(),
    number_juvenile_unknown = JuvU %>% as.integer(),
    location_id = Location. %>% as.character(),
    location_name = LocName %>% as.character(),
    tenure_id = TenCode %>% as.character(),
    lga_id = LGACode %>% as.integer(),
    district_id = DistrictNo %>% as.character(),
    site = Site %>% as.character(),
    latitude = Lat %>% as.double(),
    longitude = Long %>% as.double(),
    map_zone = MapZone %>% as.character(),
    northing = SightNorth %>% as.character(),
    easting = SightEast %>% as.character(),
    map_datum = Datum %>% as.character(),
    resolution = Resolution %>% as.character(),
    landform_id = Landform %>% as.character(),
    vegetation_type_id = VegType %>% as.character(),
    fire_history = Fire %>% as.character(),
    Sp1 = Sp1 %>% as.character(),
    Sp2 = Sp2 %>% as.character(),
    Sp3 = Sp3 %>% as.character(),
    Sp4 = Sp4 %>% as.character(),
    Sp5 = Sp5 %>% as.character(),
    Sp6 = Sp6 %>% as.character(),
    observation_method = ObservMethod %>% as.character(),
    observation_type = ObservType %>% as.character(),
    secondary_signs = SecSign %>% as.character(),
    observation_comments = Observation %>% as.character(),
    breeding_status = Breeding %>% as.character(),
    specimen_status = Specimen %>% as.character(),
    species_id_confirmed_by = Identification %>% as.character(),
    specimen_location = SpHeld %>% as.character(),
    Map = Map %>% as.character(), # TODO parse bool
    MudMap = MudMap %>% as.character(), # TODO parse bool
    photo_taken = Photo %>% as.character(), # TODO parse bool
    notes = Notes %>% as.character(),
    comments = Comments %>% as.character(),
    entered_by = EnName %>% as.character(),
    entered_on = parse_date_time(EnDate, orders = orders, tz = tz),
    changed_by = ChName %>% as.character(),
    changed_on = parse_date_time(ChDate, orders = orders, tz = tz),
    species_voucher = SpVoucher %>% as.logical(),
    SpCatNum = SpCatNum %>% as.character(),
    UnPublished = UnPublished %>% as.logical(),
    ReportTitle = ReportTitle %>% as.character(),
    Author = Author %>% as.character(),
    MFeggsH = MFeggsH %>% as.character(),
    MFeggsU = MFeggsU %>% as.character(),
    MFmoundU = MFmoundU %>% as.character(),
    MFmoundCA = MFmoundCA %>% as.character(),
    MFmoundRA = MFmoundRA %>% as.character(),
    MFmoundI = MFmoundI %>% as.character(),
    MFMage = MFMage %>% as.character(),
    MFMdiam = MFMdiam %>% as.character(),
    MFMheight = MFMheight %>% as.character(),
    MFMwidth = MFMwidth %>% as.character(),
    MFMdepth = MFMdepth %>% as.character(),
    MFMsoil = MFMsoil %>% as.character(),
    MFMcomment = MFMcomment %>% as.character(),
    MFextract = MFextract %>% as.character(),
    Field1 = Field1 %>% as.character(),
    Field2 = Field2 %>% as.character(),
    Field3 = Field3 %>% as.character(),
    Field4 = Field4 %>% as.character(),
    Field5 = Field5 %>% as.character()
  ) %>%
  dplyr::left_join(shires, by = "lga_id") %>%
  dplyr::left_join(tenure, by = "tenure_id") %>%
  dplyr::left_join(vegetation_types, by = "vegetation_type_id") %>%
  dplyr::left_join(certainty, by = "certainty_id") %>%
  dplyr::select(-o_date, -o_time)
```

Columns to confirm:

* SpCatNum


## Fauna occurrence data overview
A condensed overview over data values (completeness, ranges and distribution).
```{r fauna_skim}
fauna_skim <- skimr::skim(fauna)
fauna_skim
```

## Fauna occurrence map
An interactive map of fauna occurrences.

```{r fauna_map}
leaflet(width = 800, height = 600) %>%
  addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
  addProviderTiles("OpenStreetMap.Mapnik", group = "Place names") %>%
  clearBounds() %>%
  addAwesomeMarkers(
    data = fauna,
    lng = ~ longitude, lat = ~ latitude,
    icon = leaflet::makeAwesomeIcon(icon = "leaf"),
    label = ~ paste(species_id),
    popup = ~ paste(
      "<h3>", species_id, "</h3>",
      "<strong>Encountered on</strong>", date, "<br/>",
      "<strong>by</strong>", observer_name, "<br/>",
      "<strong>through</strong>", observation_method, "(", observation_type, ")<br/>",
      "<strong>at </strong>", site, "(", shire_label, ")<br/>",
      "<strong>Tenure</strong>", tenure, "(", tenure_id, ")<br/>",
      "<strong>Vegetation type</strong>", vegetation_type, "(", vegetation_type_id, ")<br/>",
      "<strong>Certainty</strong>", certainty, "(", certainty_id, ")<br/>"
    ),
    group = "Fauna",
    clusterOptions = markerClusterOptions()
  ) %>%
  addLayersControl(
    baseGroups = c("Aerial", "Place names"),
    overlayGroups = c("Fauna"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

## Fauna data upload
Create resource once-off to get a resource ID.
Subsequently, upload the compiled workbook.
Note, this process lags one compilation of this workbook, as the HTML output
is generated after the R code is run.

```{r fauna_upload}
# d <- ckanr::package_show("threatened-and-priority-fauna-database")
# r <- ckanr::resource_create(package_id = d$id,
#                      format = "html",
#                      name = "Fauna Data ETL",
#                      upload = "data_etl_fauna.html")
ckanr::resource_update("761af921-94ad-4383-be2c-300713c37e98", "data_etl_fauna.html")
```

