---
title: "Data ETL: Fauna"
author: "Florian Mayer, DBCA"
date: "`r Sys.time()`"
always_allow_html: yes
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
# devtools::install_github("ropenscilabs/skimr")
# devtools::install_github("tidyverse/readr")
# install from github: "brianb/mdbtools"
# devtools::install_github("ropensci/ckanr")
library(tidyverse)
library(lubridate)
library(skimr)
library(leaflet)
library(Hmisc)
library(ckanr)

# Configure ckanr to data.dpaw.wa.gov.au
ckanr::ckanr_setup(url = Sys.getenv("CKAN_URL"), key = Sys.getenv("CKAN_API_KEY"))
source("helpers.R")
```
# SCB data background
[Fauna dataset](https://data.dpaw.wa.gov.au/dataset/threatened-and-priority-fauna-database) 
on the [departmental data catalogue](https://data.dpaw.wa.gov.au/).

# Fauna

## Fauna data load
The zip archive containing the MS Access database is downloaded from the data 
catalogue, the archive is extracted, and a database connection is opened.

```{r fauna_data_load, message=FALSE}
# fauna_app <- dl_mdbzip("fb5869a9-61d2-4320-bae2-3c6e4ea3f73f") # no data
fauna_data <- dl_mdbzip("66efb68d-8f05-4bfc-af14-5d1a381d0cf2")
```

Some helpers are defined.

```{r etl_helpers}
# Date conventions
orders <- c("mdyHMS")
tz <- "Australia/Perth"
```

## Lookup tables
Lookup table columns are renamed to facilitate joining.

```{r lookup_tables}
# Lookup tables
shires <- fauna_data$Shires %>%
  dplyr::transmute(
    lga_id = LGACode %>% as.integer(),
    shire_name = LGAName %>% as.character(),
    shire_label = LGAName2 %>% as.character()
  )

tenure <- fauna_data$`Land Tenure` %>%
  dplyr::transmute(
    tenure_id = TenCode %>% as.character(),
    tenure = Tenure %>% as.character()
  )

vegetation_types <- fauna_data$`Vegetation Types` %>%
  dplyr::mutate(
    vegetation_type_id = VegCode %>% as.character(),
    vegetation_type = VegTypeName %>% as.character()
  )

certainty <- fauna_data$Certainty %>%
  dplyr::transmute(
    certainty_id = Code %>% as.integer(),
    certainty = Certainty %>% as.character()
  )

users <- tibble::tibble(
  username = c(
    "AmyM", "AbbyT", "BrianaWingfield",
    "ChristineFreegard", "GeorginaA", "KellieMantle",
    "NickyMarlow", "PeterMawson", "PeterOrell"
  ),
  initials = c(
    "AM", "AT", "BW",
    "CF", "GA", "KM",
    "NM", "PM", "PO"
  ),
  name = c(
    "Amy Mutton", "Abby Thomas", "Briana Wingfield",
    "Christine Freegard", "Georgina Anderson", "Kellie Mantle",
    "Nicky Marlow", "Peter Mawson", "Peter Orell"
  )
)

phylo_class <- fauna_data$`Class List` %>%
  dplyr::transmute(
    phylo_class_id = ClassCode %>% as.character(),
    phylo_class_common_name = ClassName %>% as.character(),
    phylo_class_scientific_name = Class %>% as.character(),
    order = ClassOrder %>% as.character()
  ) %>%
  dplyr::arrange(order)

phylo_group <- fauna_data$`Group List` %>%
  dplyr::transmute(
    phylo_group_id = Group %>% as.integer(),
    phylo_group_name = GroupName %>% as.character(),
    phylo_class_id = Class %>% as.character()
    # order = GroupOrder %>% as.character()
  ) %>%
  dplyr::left_join(phylo_class, by = "phylo_class_id")
# skimr::skim(group)

species_notes <- fauna_data$`Species Notes` %>%
  dplyr::transmute(
    species_code = SpCode %>% as.character(),
    species_notes = Notes %>% as.character()
  )

resolution <- fauna_data$Resolution %>%
  dplyr::transmute(
    resolution_id = ResCode %>% as.integer(),
    resolution_geographic_coords = ResolutionLL %>% as.character(),
    resolution_projected_coords = ResolutionUTM %>% as.character()
  )

category <- fauna_data$`Category List` %>%
  dplyr::transmute(
    category_id = Category %>% as.character(),
    phylogenetic_category = CategoryName %>% as.character()
  )
```

## Species names
Data is parsed into matching data types, dates are recognised, and lookup
values are joined while lookup IDs are retained to facilitate later data ingestion
into other systems.

Legacy column names are capitalised, while new or reformatted column are lower-cased.

```{r fauna_species}
# TODO species notes
species <- fauna_data$`Species List` %>%
  dplyr::transmute(
    species_code = SpCode %>% as.character(),
    old_species_code = OldCode %>% as.character(),
    short_code = ShCode %>% as.character(),
    name_id = NameID %>% as.character(),
    scientific_name = ScName %>% as.character(),
    common_name = ComName %>% as.character(),
    phylo_group_id = PhyloGroup %>% as.integer(),
    family = Family %>% as.character(),
    genus = Genus %>% as.character(),
    species = Species %>% as.character(),
    authority_species = Authority.sp %>% as.character(),
    subspecies = Subspecies %>% as.character(),
    authority_subspecies = Authority.ssp %>% as.character(),
    file_number_calm = CALMFileNum %>%
      as.character() %>%
      map(~ as_filenumber(., prefix = "CALM")),
    file_number_dec = DECFileNum %>%
      as.character() %>%
      map(~ as_filenumber(., prefix = "DEC")),
    file_number_dpaw = DPaWFileNum %>%
      as.character() %>%
      map(~ as_filenumber(., prefix = "DPAW")),
    file_number_dbca = DBCAFileNum %>%
      as.character() %>%
      map(~ as_filenumber(., prefix = "DBCA")),
    category_id = Category %>% as.character(),
    origin = Origin %>% as.character(), # N - native, I - introduced
    # region_id_list = Region %>% map(~ as.list(strsplit(., ",")[[1]] %>% as.integer())),
    taxon_id = TaxonId %>% as.logical(),
    # translocated = Trans %>% as.character(), # E - extant, T - translocated
    # accept_new_records = Incl %>% as.logical(), # only FALSE in old records
    # species_can_be_trapped = Trap %>% as.logical(),
    # only_sighting_type_surveys = Sight %>% as.logical(),
    # could_have_nest_box = Nbox %>% as.logical(),
    # could_display_secondary_signs = Sign %>% as.logical(),
    # can_associate_band_number = BANo %>% as.logical(),
    # buffer = Buffer %>% as.character(), # NA 0 1 2 3 - unused
    # estimated_lifespan = EST.LIFE %>% as.integer() # NA  0 10  7 15  6  8
  ) %>%
  dplyr::left_join(phylo_group, by = "phylo_group_id") %>%
  dplyr::left_join(species_notes, by = "species_code") %>%
  dplyr::left_join(category, by = "category_id")
species_skim <- skimr::skim(species)
print(species_skim)
DT::datatable(species)

# Just the essentials: species code, name_id, names.
species_names <- species %>%
  dplyr::select(species_code, name_id, scientific_name, common_name)

# Without things that break saving to CSV
species_save <- species %>% dplyr::select(-starts_with("file_number"))
```

There are `r nrow(species)` species names. The following columns are incomplete:

```{r species_missing_values}
species_skim %>% filter(stat == "missing", value > 0) %>% select(-stat, -level, -formatted)
```

The table `species` contains info on:

* taxonomy (links to `name_id`, names, various hierarchy levels, 
  paraphyletic groups e.g. `phylo_group`, category)
* occurrence summary (e.g. region ID list, an unimplemented m2m relation)
* some numeric fields: `est_life` `r unique(species$est_life)`
* corporate file numbers (what's in those files?)
* some now unused fields (see above for excluded fields)
The field `region_id_list` should be a many-to-many relation to regions, but is superseded by spatial lookup of occurrence to spatial entity.

## Fauna occurrence

### Critical Habitat, Population, Subpopulation
* CH are Multipolygon Features.
* Population is the sum of all subpopulations.
* Subpopulation is a spatially and/or genetically distinct group of occurrences.

### Occurrences
* AnimalEncounters are species occurrences.
* Opportunistic sightings by members of public currently end up in ThrFaunaDB.
* Opportunistic sightings by members of public could come in via an app.
* Data returns from wildlife licenses go into the Wildlife Licensing System.
* The precursor of Wildlife Licensing System is a system called "Fauna Survey Return System", which is shown as layer in NatureMap.
* Staff should (but don't always) use the Wildlife Licensing System for data returns.
* Some staff use FaunaFile for data returns.
* Staff could use BioSys for data returns.

```{r fauna_occurrence}
# Generate column config:
# fauna_data$`Fauna Records` %>% make_coldef()

fauna_raw <- fauna_data$`Fauna Records`
fauna <- fauna_raw %>%
  dplyr::transmute(
    id = DBNo %>% as.integer(),
    # district_db = DistDB %>% as.integer(),
    # district_db_no = DistDBNo %>% as.character(),
    species_code = SpCode %>% as.character(),
    # name_id = NameId %>% as.character(), # they're all NA
    o_date = parse_date_time(Date, orders = orders, tz = tz),
    o_time = parse_date_time(Time, orders = orders, tz = tz),
    date = with_tz(o_date + hours(hour(o_time)) + minutes(minute(o_time)), tzone = tz),
    observer_name = Observer %>% as.character(),
    observer_role = OrgRole %>% as.character(),
    observer_address = Address %>% as.character(),
    observer_phone = Phone %>% as.character(),
    certainty_id = Certainty %>% as.integer(),
    number_seen = NumSeen %>% as.integer(), # sum of number_*
    animal_features = Features %>% as.character(),
    number_adult_males = AdultM %>% as.integer(),
    number_adult_females = AdultF %>% as.integer(),
    number_adult_unknown = AdultU %>% as.integer(),
    number_juvenile_males = JuvM %>% as.integer(),
    number_juvenile_females = JuvF %>% as.integer(),
    number_juvenile_unknown = JuvU %>% as.integer(),
    location_id = Location. %>% as.character(),
    location_name = LocName %>% as.character(),
    tenure_id = TenCode %>% as.character(),
    lga_id = LGACode %>% as.integer(),
    district_id = DistrictNo %>% as.character(),
    site_comment = Site %>% as.character(),
    latitude = Lat %>% as.double(),
    longitude = Long %>% as.double(),
    map_zone = MapZone %>% as.character(),
    northing = SightNorth %>% as.character(),
    easting = SightEast %>% as.character(),
    map_datum = Datum %>% as.character(),
    resolution_id = Resolution %>% as.integer(),
    landform_id = Landform %>% as.character(),
    vegetation_type_id = VegType %>% as.character(),
    fire_history = Fire %>% as.character(),
    associated_flora_species_1 = Sp1 %>% as.character(),
    associated_flora_species_2 = Sp2 %>% as.character(),
    associated_flora_species_3 = Sp3 %>% as.character(),
    associated_flora_species_4 = Sp4 %>% as.character(),
    associated_flora_species_5 = Sp5 %>% as.character(),
    associated_flora_species_6 = Sp6 %>% as.character(),
    observation_method = ObservMethod %>% as.character(),
    observation_type = ObservType %>% as.character(),
    secondary_signs = SecSign %>% as.character(),
    observation_comments = Observation %>% as.character(),
    breeding_status = Breeding %>% as.character(),
    specimen_status = Specimen %>% as.character(),
    species_id_confirmed_by = Identification %>% as.character(),
    map_provided = Map %>% as.character(), # TODO parse bool
    mudmap_provided = MudMap %>% as.character(), # TODO parse bool
    photo_taken = Photo %>% as.character(), # TODO parse bool
    notes = Notes %>% as.character(),
    comments = Comments %>% as.character(),
    entered_by = EnName %>% as.character(),
    entered_on = parse_date_time(EnDate, orders = orders, tz = tz),
    changed_by = ChName %>% as.character(),
    changed_on = parse_date_time(ChDate, orders = orders, tz = tz),
    specimen_voucher_exists = SpVoucher %>% as.logical(),
    specimen_voucher_location = SpHeld %>% as.character(), # specimen catalogue
    specimen_voucher_catalogue_number = SpCatNum %>% as.character(),
    occurence_not_published = UnPublished %>% as.logical(),
    occurrence_citation = ReportTitle %>% as.character(),
    # occurrence_citation_author = Author %>% as.character(),
    malleefowl_MFeggsH = MFeggsH %>% as.character(),
    malleefowl_MFeggsU = MFeggsU %>% as.character(),
    malleefowl_MFmoundU = MFmoundU %>% as.character(),
    malleefowl_MFmoundCA = MFmoundCA %>% as.character(),
    malleefowl_MFmoundRA = MFmoundRA %>% as.character(),
    malleefowl_MFmoundI = MFmoundI %>% as.character(),
    malleefowl_MFMage = MFMage %>% as.character(),
    malleefowl_MFMdiam = MFMdiam %>% as.character(),
    malleefowl_MFMheight = MFMheight %>% as.character(),
    malleefowl_MFMwidth = MFMwidth %>% as.character(),
    malleefowl_MFMdepth = MFMdepth %>% as.character(),
    malleefowl_MFMsoil = MFMsoil %>% as.character(),
    malleefowl_MFMcomment = MFMcomment %>% as.character(),
    malleefowl_MFextract = MFextract %>% as.character()
    # Field* are empty, skipping:
    # Field1 = Field1 %>% as.character(),
    # Field2 = Field2 %>% as.character(),
    # Field3 = Field3 %>% as.character(),
    # Field4 = Field4 %>% as.character(),
    # Field5 = Field5 %>% as.character()
  ) %>%
  dplyr::left_join(shires, by = "lga_id") %>%
  dplyr::left_join(tenure, by = "tenure_id") %>%
  dplyr::left_join(vegetation_types, by = "vegetation_type_id") %>%
  dplyr::left_join(certainty, by = "certainty_id") %>%
  dplyr::left_join(species_names, by = "species_code") %>%
  dplyr::left_join(resolution, by = "resolution_id") %>%
  dplyr::select(-o_date, -o_time)
```

Fauna occurrence does link to the name that was current / legal at the time.
Occurrence query should show hints linking to current / legal names and their history.

## Fauna occurrence data overview
A condensed overview over data values (completeness, ranges and distribution).


```{r fauna_skim}
fauna_skim <- fauna %>% skimr::skim()
print(fauna_skim)
```

There are `r nrow(fauna)` species occurrence records (encounters). 
The following columns are incomplete:

```{r fauna_missing_values}
fauna_skim %>%
  filter(stat == "missing", value > 0) %>%
  select(-stat, -level, -formatted) %>%
  DT::datatable(.)
```

The table `fauna` contains species occurrence records:
* taxonomy,
* location (coordinates, accuracy and derived information) and time of observation,
* observers, taxonomic ID confirmation,
* data entry and last change (date and operator),
* info on type specimens,
* info on surroundings of observation,
* info on animal(s) like group size, age, breeding condition,
* additional info (comments, whether photo was taken),
* MalleeFowl-specific observations (MF*),
* empty columns (Field*).

### Data migration strategy
* Personnel: Create lookup table of `Personnel$Initials` to DBCA usernames as table `users`.
* Names: observer, taxonomist, record entered by, record last changed by.
* Names include menbers of public.

## Fauna occurrence map
An interactive map of fauna occurrences.

```{r fauna_map, fig.height=5, fig.width=7}
leaflet(width = 800, height = 600) %>%
  addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
  addProviderTiles("OpenStreetMap.Mapnik", group = "Place names") %>%
  clearBounds() %>%
  addAwesomeMarkers(
    data = fauna,
    lng = ~ longitude, lat = ~ latitude,
    icon = leaflet::makeAwesomeIcon(icon = "leaf"),
    label = ~ paste0(scientific_name, " (", stringr::str_to_title(common_name), ")"),
    popup = ~ paste(
      "<h3>", stringr::str_to_title(common_name), "</h3>",
      "<strong>", scientific_name, "</strong> (", species_code, ")<br/>",
      "<strong>Encountered on</strong>", date, "<br/>",
      "<strong>by</strong>", observer_name, "<br/>",
      "<strong>through</strong>", observation_method, "(", observation_type, ")<br/>",
      "<strong>at </strong>", site_comment, "(", shire_label, ")<br/>",
      "<strong>Tenure</strong>", tenure, "(", tenure_id, ")<br/>",
      "<strong>Vegetation type</strong>", vegetation_type, "(", vegetation_type_id, ")<br/>",
      "<strong>Certainty</strong>", certainty, "(", certainty_id, ")<br/>"
    ),
    group = "Fauna",
    clusterOptions = markerClusterOptions()
  ) %>%
  addLayersControl(
    baseGroups = c("Aerial", "Place names"),
    overlayGroups = c("Fauna"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

## Conservation status
Gazettal, Listing Category, Listing Names, List Names deal with assigning conservation status from 
various legal listings to species.

### Listing Names
Lookups for legal acts.

```{r listing_names}
listing_names <- fauna_data$`Listing Names` %>%
  dplyr::transmute(
    list_code = ListCode %>% as.character(),
    list_name = ListName %>% as.character(),
    list_order = ListOrder %>% as.integer()
  ) %>%
  dplyr::arrange(list_order)
listing_names %>% skim()
```

### DEC Listing Names
```{r dec_listing_names}
dec_listing_names <- fauna_data$`DEC List Names` %>%
  dplyr::transmute(
    dec_listing_id = DECCode %>% as.character(),
    dec_listing_name = DECList %>% as.character(),
    dec_listing_order = DECOrder %>% as.integer()
  ) %>%
  dplyr::arrange(dec_listing_order)
dec_listing_names %>% skim()
```

### Conservation status
Each act (listing) defines a number of possible conservation statuses.
The table `Listing Category` contains all possible conservation statuses.
Conservation status can be assigned (for a period of time) to a species.

```{r listing_category}
# make_coldef(listing_category)
conservation_status <- fauna_data$`Listing Category` %>%
  dplyr::transmute(
    list_code = ListCode %>% as.character(),
    status_code = StatCode %>% as.character(),
    status = Status %>% as.character(),
    status_expand = StatusExpand %>% as.character(),
    explanations = Explanations %>% as.character(),
    notes = Notes %>% as.character(),
    order = Order %>% as.integer(),
    dec_listing_id = DECCode %>% as.character()
  ) %>%
  dplyr::arrange(order) %>%
  dplyr::left_join(listing_names, by = "list_code") %>%
  dplyr::left_join(dec_listing_names, by = "dec_listing_id")
conservation_status %>% skim()
conservation_status %>% head(10) %>% DT::datatable(.)
```

### Gazettal
Gazettal is the act of assigning a conservation status to a species for a span of time.

```{r gazettal}
gazettal <- fauna_data$Gazettal %>%
  dplyr::transmute(
    species_code = SpCode %>% as.character(),
    list_code = ListCode %>% as.character(),
    status_code = StatCode %>% as.character(),
    population = Popn %>% as.character(),
    reasons = Reasons %>% as.character(),
    authority = AUTHORITY %>% as.character(),
    gazetted_on = DateList %>% parse_date_time(., orders = orders, tz = tz),
    delisted_on = DateDeList %>% parse_date_time(., orders = orders, tz = tz),
    review_due = DateReview %>% parse_date_time(., orders = orders, tz = tz),
    interim = INTERIM %>% as.character(),
    translocation = TRANSLOCATION %>% as.character(),
    comments = Comments %>% as.character()
  ) %>%
  dplyr::left_join(species_names, by = "species_code")
gazettal %>% skim()
gazettal %>% head(10) %>% DT::datatable()
```

## Recovery Plans
Recovery Plans, Recovery Actions, Research Topics, Research Priorities.

### Research Priorities
```{r res_prio}
res_prio <- fauna_data$`Research Priorities` %>%
  dplyr::transmute(
    species_code = SpCode %>% as.character(),
    research_priority = ResearchPriority %>% as.character(),
    undertaken = Undertaken %>% as.logical(),
    comments = Comments %>% as.character()
  ) %>%
  left_join(species_names, by = "species_code")
res_prio %>% skim()
```

### Recovery Plans
```{r recovery_plans}
res_topics <- fauna_data$`Research Topics` %>%
  dplyr::transmute(
    research_topic_id = ID %>% as.integer(),
    research_topic = Research.Topics %>% as.character()
  )

rec_actions <- fauna_data$`Recovery Actions` %>%
  dplyr::transmute(
    recovery_action_id = ID %>% as.integer(),
    recovery_action = Recovery.Actions %>% as.character(),
  )

recovery_plans <- fauna_data$`Recovery Plans` %>%
  dplyr::transmute(
    species_code = SpCode %>% as.character(),
    program_number = ProgramNo %>% as.integer(),
    title = RecoveryPlan %>% as.character(),
    scope = NationalorState %>% as.character(),
    year_approved = YearApproved %>% as.character(),
    objectives = Objectives %>% as.character(),
    recovery_action_id = ActionTypes %>% as.integer(),
    research_topic_id = ResearchTopics %>% as.integer(),
    recovery_team = RecoveryTeam %>% as.character(),
    is_active = Active %>% as.logical(),
    team_scope = RTNationalorState %>% as.character(),
    lead_org = LeadOrg %>% as.character(),
    chair_org = ChairOrg %>% as.character(),
    chair_name = ChairName %>% as.character(),
    chair_contact = ChairContact %>% as.character(),
    xo_name = ExecOName %>% as.character(),
    xo_contact = ExecOContact %>% as.character(),
    membership = Membership %>% as.character(),
    rt_filenumber = RTFileNumber %>% as.character()
  ) %>%
  dplyr::left_join(res_topics, by = "research_topic_id") %>%
  dplyr::left_join(rec_actions, by = "recovery_action_id") %>%
  dplyr::left_join(species_names, by = "species_code")
recovery_plans %>% skim()
recovery_plans %>% DT::datatable(.)
```

## Data model
As a relational data model, the dependencies can be expressed linearly (excluding key-value lookups):

* [Taxonomy] Species names
* [Observations] Species Occurrence > Species Names
* [Conservation] Conservation List > Conservation Status > Conservation Status Gazettal > Species names
* [Conservation] Recovery Plan / Conservation Advice > Species Names
* [Conservation] Research Priorities > Species Names
* [Conservation] Threats > Species Names

The models fit broadly into three modules:

* Taxonomy - a local copy of WACensus plus temporary names.
* Observations - encounters with things (such as animals) and related measurements.
* Conservation - conservation status and its assignment to species names, recovery plans aiming to
  change conservation status, research priorities related to species names.

## Data upload
Create resource once-off to get a resource ID.
Subsequently, upload the compiled workbook.
Note, this process lags one compilation of this workbook, as the HTML output
is generated after the R code is run.

```{r fauna_upload}
d <- ckanr::package_show("threatened-and-priority-fauna-database")
ckanr::resource_update("761af921-94ad-4383-be2c-300713c37e98", "data_etl_fauna.html")
upload_to_ckan(species_save, "Threatened Fauna Species Names", d$id, resource_id = "eae0b480-c687-450c-a736-87d4e75c2a4d")
upload_to_ckan(res_prio, "Threatened Fauna Research Priorities", d$id, resource_id = "7a26d00c-f3da-46a3-9d74-42e4475bd6a9")
upload_to_ckan(conservation_status, "Threatened Fauna Conservation Status", d$id, resource_id = "2793b1a8-eb55-41e7-8f8f-9cbc79a01243")
upload_to_ckan(gazettal, "Threatened Fauna Conservation Status Gazettal", d$id, resource_id = "ac089664-de5a-4efa-af3c-ada0ec77ef1f")
upload_to_ckan(recovery_plans, "Threatened Fauna Recovery Plans", d$id, resource_id = "9f8426c3-20ed-4ba7-a551-05e1838ab1cb")
upload_to_ckan(fauna, "Threatened Fauna Occurrence", d$id, resource_id = "b73ae0de-f243-4bb3-bbce-25b65bb98e66")
```

