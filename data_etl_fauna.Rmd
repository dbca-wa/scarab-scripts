---
title: "Data ETL: Fauna"
author: "Florian Mayer, DBCA"
date: "`r Sys.time()`"
always_allow_html: yes
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# devtools::install_github("ropenscilabs/skimr")
# devtools::install_github("tidyverse/readr")
# install from github: "brianb/mdbtools"
# devtools::install_github("ropensci/ckanr")
library(tidyverse)
library(lubridate)
library(skimr)
library(leaflet)
library(Hmisc)
library(ckanr)

# Configure ckanr to data.dpaw.wa.gov.au
ckanr::ckanr_setup(url = Sys.getenv("CKAN_URL"), 
                   key = Sys.getenv("CKAN_API_KEY"))

#' Download, extract and open a zipped Access database from a CKAN dataset
#' 
#' @param resource_id The CKAN resource ID of a zipped Access DB
#' @param destdir The local destination directory for the extracted file, 
#'  will be created if not existing. Default: "data"
#' @param dateformat The parameter dateformat for Hmisc::mdb.get(), 
#'  default: '%Y-%m-%d'
#' @param asis The parameter as.is for Hmisc::mdb.get(), default: TRUE
#' @returns The Hmisc::mdb.get connection
dl_mdbzip <- function(resource_id, 
                      destdir="data", 
                      dateformat = '%Y-%m-%d', 
                      asis = TRUE) {
    dir.create(file.path(getwd(), destdir), showWarnings = FALSE)
    tmp <- tempfile()
    res_url <- ckanr::resource_show(resource_id)$url
    utils::download.file(res_url, tmp)
    dbfile <- utils::unzip(tmp, exdir = destdir)
    unlink(tmp)
    con <- Hmisc::mdb.get(dbfile, dateformat = dateformat, as.is = asis)
    con
}
```
# SCB data background
[Fauna dataset](https://data.dpaw.wa.gov.au/dataset/threatened-and-priority-fauna-database) 
on the [departmental data catalogue](https://data.dpaw.wa.gov.au/).

# Fauna

## Fauna data load
The zip archive containing the MS Access database is downloaded from the data 
catalogue, the archive is extracted, and a database connection is opened.

Lookup tables are joined to the main tables.

```{r fauna_data_load}
fauna_app <- dl_mdbzip("fb5869a9-61d2-4320-bae2-3c6e4ea3f73f")
fauna_data <- dl_mdbzip("66efb68d-8f05-4bfc-af14-5d1a381d0cf2")

# Prepare column def
as_def <- . %>% paste(., " = ", ., " %>% as.character, \n")
# fnames <- fauna_data$`Fauna Records` %>% names
# fnames %>% purrr::map(as_def) %>% unlist %>% cat

shires <- fauna_data$Shires %>%
    dplyr::transmute(
        LGACode = LGACode %>% as.integer,
        shire_name = LGAName %>% as.character,
        shire_label = LGAName2 %>% as.character
    )
orders <- c("mdyhms")
tz <- "Australia/Perth"

fauna_raw <- fauna_data$`Fauna Records`
fauna <- fauna_raw %>%
    dplyr::transmute(
        db_no = DBNo %>% as.integer,
        dist_db = DistDB %>% as.integer,
        DBNo = DBNo  %>% as.character, 
        DistDB = DistDB  %>% as.character, 
        DistDBNo = DistDBNo  %>% as.character, 
        SpCode = SpCode  %>% as.character, 
        NameId = NameId  %>% as.character,
        o_date = parse_date_time(Date, orders=orders, tz=tz),
        o_time = parse_date_time(Time, orders=orders, tz=tz),
        date = with_tz(o_date + hours(hour(o_time)) + minutes(minute(o_time)), tzone = tz),
        Observer = Observer  %>% as.character, 
        OrgRole = OrgRole  %>% as.character, 
        Address = Address  %>% as.character, 
        Phone = Phone  %>% as.character, 
        Certainty = Certainty  %>% as.character, 
        NumSeen = NumSeen  %>% as.character, 
        Features = Features  %>% as.character, 
        AdultM = AdultM  %>% as.character, 
        AdultF = AdultF  %>% as.character, 
        AdultU = AdultU  %>% as.character, 
        JuvM = JuvM  %>% as.character, 
        JuvF = JuvF  %>% as.character, 
        JuvU = JuvU  %>% as.character, 
        Location = Location.  %>% as.character, 
        LocName = LocName  %>% as.character, 
        TenCode = TenCode  %>% as.integer, 
        LGACode = LGACode  %>% as.integer, 
        DistrictNo = DistrictNo  %>% as.character, 
        Site = Site  %>% as.character, 
        Lat = Lat  %>% as.double, 
        Long = Long  %>% as.double, 
        MapZone = MapZone  %>% as.character, 
        SightNorth = SightNorth  %>% as.character, 
        SightEast = SightEast  %>% as.character, 
        Datum = Datum  %>% as.character, 
        Resolution = Resolution  %>% as.character, 
        Landform = Landform  %>% as.character, 
        VegType = VegType  %>% as.character, 
        Fire = Fire  %>% as.character, 
        Sp1 = Sp1  %>% as.character, 
        Sp2 = Sp2  %>% as.character, 
        Sp3 = Sp3  %>% as.character, 
        Sp4 = Sp4  %>% as.character, 
        Sp5 = Sp5  %>% as.character, 
        Sp6 = Sp6  %>% as.character, 
        observation_method = ObservMethod  %>% as.character, 
        observation_type = ObservType  %>% as.character, 
        SecSign = SecSign  %>% as.character, 
        Observation = Observation  %>% as.character, 
        Breeding = Breeding  %>% as.character, 
        Specimen = Specimen  %>% as.character, 
        Identification = Identification  %>% as.character, 
        SpHeld = SpHeld  %>% as.character, 
        Map = Map  %>% as.character, 
        MudMap = MudMap  %>% as.character, 
        Photo = Photo  %>% as.character, 
        Notes = Notes  %>% as.character, 
        Comments = Comments  %>% as.character, 
        entered_by = EnName  %>% as.character, 
        entered_on = parse_date_time(EnDate, orders=orders, tz=tz),
        changed_by = ChName  %>% as.character, 
        changed_on =  parse_date_time(ChDate, orders=orders, tz=tz),
        SpVoucher = SpVoucher  %>% as.character, 
        SpCatNum = SpCatNum  %>% as.character, 
        UnPublished = UnPublished  %>% as.logical, 
        ReportTitle = ReportTitle  %>% as.character, 
        Author = Author  %>% as.character, 
        MFeggsH = MFeggsH  %>% as.character, 
        MFeggsU = MFeggsU  %>% as.character, 
        MFmoundU = MFmoundU  %>% as.character, 
        MFmoundCA = MFmoundCA  %>% as.character, 
        MFmoundRA = MFmoundRA  %>% as.character, 
        MFmoundI = MFmoundI  %>% as.character, 
        MFMage = MFMage  %>% as.character, 
        MFMdiam = MFMdiam  %>% as.character, 
        MFMheight = MFMheight  %>% as.character, 
        MFMwidth = MFMwidth  %>% as.character, 
        MFMdepth = MFMdepth  %>% as.character, 
        MFMsoil = MFMsoil  %>% as.character, 
        MFMcomment = MFMcomment  %>% as.character, 
        MFextract = MFextract  %>% as.character, 
        Field1 = Field1  %>% as.character, 
        Field2 = Field2  %>% as.character, 
        Field3 = Field3  %>% as.character, 
        Field4 = Field4  %>% as.character, 
        Field5 = Field5  %>% as.character
        ) %>%
    dplyr::left_join(shires, by = "LGACode") %>% 
    dplyr::select(-LGACode, -o_date, -o_time)
```

## Fauna data overview
```{r fauna_skim}
fauna_skim <- skimr::skim(fauna)
fauna_skim
```

## Fauna map
```{r fauna_map}
leaflet(width = 800, height = 600) %>% 
    addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
    addProviderTiles("OpenStreetMap.Mapnik", group = "Place names") %>%
    clearBounds() %>%
    addAwesomeMarkers(
        data = fauna,
        lng = ~Long, lat=~Lat,
        icon = leaflet::makeAwesomeIcon(icon="leaf"),
        label = ~paste(SpCode),
        popup = ~paste(
            "<h3>", SpCode, "</h3>",
            "<strong>NameId</strong>", NameId, "<br/>",
            "<strong>Encountered on</strong>", date, "<br/>",
            "<strong>by</strong>", Observer, "<br/>",
            "<strong>through</strong>", observation_method, "(", observation_type, ")<br/>",
            "<strong>at </strong>", Site, "(", shire_label, ")<br/>"),
        group = "Fauna",
        clusterOptions = markerClusterOptions()) %>%
    addLayersControl(
        baseGroups = c("Aerial", "Place names"),
        overlayGroups = c("Fauna"),
        options = layersControlOptions(collapsed = FALSE))
```
## Fauna data upload
Create resource once-off to get a resource ID.
Subsequently, upload the compiled workbook.
Note, this process lags one compilation of this workbook, as the HTML output
is generated after the R code is run.

```{r fauna_upload}
# d <- ckanr::package_show("threatened-and-priority-fauna-database")
# r <- ckanr::resource_create(package_id = d$id,
#                      format = "html",
#                      name = "Fauna Data ETL",
#                      upload = "data_etl_fauna.html")
ckanr::resource_update("761af921-94ad-4383-be2c-300713c37e98", "data_etl_fauna.html")
```
